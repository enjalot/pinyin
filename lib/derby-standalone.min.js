(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){(function(global){var DerbyStandalone=require("derby/lib/DerbyStandalone");global.derby=module.exports=new DerbyStandalone;require("derby/node_modules/derby-parsing")}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"derby/lib/DerbyStandalone":21,"derby/node_modules/derby-parsing":30}],2:[function(require,module,exports){var base64=require("base64-js");var ieee754=require("ieee754");exports.Buffer=Buffer;exports.SlowBuffer=Buffer;exports.INSPECT_MAX_BYTES=50;Buffer.poolSize=8192;Buffer._useTypedArrays=function(){try{var buf=new ArrayBuffer(0);var arr=new Uint8Array(buf);arr.foo=function(){return 42};return 42===arr.foo()&&typeof arr.subarray==="function"}catch(e){return false}}();function Buffer(subject,encoding,noZero){if(!(this instanceof Buffer))return new Buffer(subject,encoding,noZero);var type=typeof subject;if(encoding==="base64"&&type==="string"){subject=stringtrim(subject);while(subject.length%4!==0){subject=subject+"="}}var length;if(type==="number")length=coerce(subject);else if(type==="string")length=Buffer.byteLength(subject,encoding);else if(type==="object")length=coerce(subject.length);else throw new Error("First argument needs to be a number, array or string.");var buf;if(Buffer._useTypedArrays){buf=Buffer._augment(new Uint8Array(length))}else{buf=this;buf.length=length;buf._isBuffer=true}var i;if(Buffer._useTypedArrays&&typeof subject.byteLength==="number"){buf._set(subject)}else if(isArrayish(subject)){for(i=0;i<length;i++){if(Buffer.isBuffer(subject))buf[i]=subject.readUInt8(i);else buf[i]=subject[i]}}else if(type==="string"){buf.write(subject,0,encoding)}else if(type==="number"&&!Buffer._useTypedArrays&&!noZero){for(i=0;i<length;i++){buf[i]=0}}return buf}Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return true;default:return false}};Buffer.isBuffer=function(b){return!!(b!==null&&b!==undefined&&b._isBuffer)};Buffer.byteLength=function(str,encoding){var ret;str=str+"";switch(encoding||"utf8"){case"hex":ret=str.length/2;break;case"utf8":case"utf-8":ret=utf8ToBytes(str).length;break;case"ascii":case"binary":case"raw":ret=str.length;break;case"base64":ret=base64ToBytes(str).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=str.length*2;break;default:throw new Error("Unknown encoding")}return ret};Buffer.concat=function(list,totalLength){assert(isArray(list),"Usage: Buffer.concat(list, [totalLength])\n"+"list should be an Array.");if(list.length===0){return new Buffer(0)}else if(list.length===1){return list[0]}var i;if(typeof totalLength!=="number"){totalLength=0;for(i=0;i<list.length;i++){totalLength+=list[i].length}}var buf=new Buffer(totalLength);var pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos);pos+=item.length}return buf};function _hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;assert(strLen%2===0,"Invalid hex string");if(length>strLen/2){length=strLen/2}for(var i=0;i<length;i++){var byte=parseInt(string.substr(i*2,2),16);assert(!isNaN(byte),"Invalid hex string");buf[offset+i]=byte}Buffer._charsWritten=i*2;return i}function _utf8Write(buf,string,offset,length){var charsWritten=Buffer._charsWritten=blitBuffer(utf8ToBytes(string),buf,offset,length);return charsWritten}function _asciiWrite(buf,string,offset,length){var charsWritten=Buffer._charsWritten=blitBuffer(asciiToBytes(string),buf,offset,length);return charsWritten}function _binaryWrite(buf,string,offset,length){return _asciiWrite(buf,string,offset,length)}function _base64Write(buf,string,offset,length){var charsWritten=Buffer._charsWritten=blitBuffer(base64ToBytes(string),buf,offset,length);return charsWritten}function _utf16leWrite(buf,string,offset,length){var charsWritten=Buffer._charsWritten=blitBuffer(utf16leToBytes(string),buf,offset,length);return charsWritten}Buffer.prototype.write=function(string,offset,length,encoding){if(isFinite(offset)){if(!isFinite(length)){encoding=length;length=undefined}}else{var swap=encoding;encoding=offset;offset=length;length=swap}offset=Number(offset)||0;var remaining=this.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}encoding=String(encoding||"utf8").toLowerCase();var ret;switch(encoding){case"hex":ret=_hexWrite(this,string,offset,length);break;case"utf8":case"utf-8":ret=_utf8Write(this,string,offset,length);break;case"ascii":ret=_asciiWrite(this,string,offset,length);break;case"binary":ret=_binaryWrite(this,string,offset,length);break;case"base64":ret=_base64Write(this,string,offset,length);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=_utf16leWrite(this,string,offset,length);break;default:throw new Error("Unknown encoding")}return ret};Buffer.prototype.toString=function(encoding,start,end){var self=this;encoding=String(encoding||"utf8").toLowerCase();start=Number(start)||0;end=end!==undefined?Number(end):end=self.length;if(end===start)return"";var ret;switch(encoding){case"hex":ret=_hexSlice(self,start,end);break;case"utf8":case"utf-8":ret=_utf8Slice(self,start,end);break;case"ascii":ret=_asciiSlice(self,start,end);break;case"binary":ret=_binarySlice(self,start,end);break;case"base64":ret=_base64Slice(self,start,end);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":ret=_utf16leSlice(self,start,end);break;default:throw new Error("Unknown encoding")}return ret};Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};Buffer.prototype.copy=function(target,target_start,start,end){var source=this;if(!start)start=0;if(!end&&end!==0)end=this.length;if(!target_start)target_start=0;if(end===start)return;if(target.length===0||source.length===0)return;assert(end>=start,"sourceEnd < sourceStart");assert(target_start>=0&&target_start<target.length,"targetStart out of bounds");assert(start>=0&&start<source.length,"sourceStart out of bounds");assert(end>=0&&end<=source.length,"sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-target_start<end-start)end=target.length-target_start+start;var len=end-start;if(len<100||!Buffer._useTypedArrays){for(var i=0;i<len;i++)target[i+target_start]=this[i+start]}else{target._set(this.subarray(start,start+len),target_start)}};function _base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function _utf8Slice(buf,start,end){var res="";var tmp="";end=Math.min(buf.length,end);for(var i=start;i<end;i++){if(buf[i]<=127){res+=decodeUtf8Char(tmp)+String.fromCharCode(buf[i]);tmp=""}else{tmp+="%"+buf[i].toString(16)}}return res+decodeUtf8Char(tmp)}function _asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;i++)ret+=String.fromCharCode(buf[i]);return ret}function _binarySlice(buf,start,end){return _asciiSlice(buf,start,end)}function _hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;i++){out+=toHex(buf[i])}return out}function _utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256)}return res}Buffer.prototype.slice=function(start,end){var len=this.length;start=clamp(start,len,0);end=clamp(end,len,len);if(Buffer._useTypedArrays){return Buffer._augment(this.subarray(start,end))}else{var sliceLen=end-start;var newBuf=new Buffer(sliceLen,undefined,true);for(var i=0;i<sliceLen;i++){newBuf[i]=this[i+start]}return newBuf}};Buffer.prototype.get=function(offset){console.log(".get() is deprecated. Access using array indexes instead.");return this.readUInt8(offset)};Buffer.prototype.set=function(v,offset){console.log(".set() is deprecated. Access using array indexes instead.");return this.writeUInt8(v,offset)};Buffer.prototype.readUInt8=function(offset,noAssert){if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<this.length,"Trying to read beyond buffer length")}if(offset>=this.length)return;return this[offset]};function _readUInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val;if(littleEndian){val=buf[offset];if(offset+1<len)val|=buf[offset+1]<<8}else{val=buf[offset]<<8;if(offset+1<len)val|=buf[offset+1]}return val}Buffer.prototype.readUInt16LE=function(offset,noAssert){return _readUInt16(this,offset,true,noAssert)};Buffer.prototype.readUInt16BE=function(offset,noAssert){return _readUInt16(this,offset,false,noAssert)};function _readUInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val;if(littleEndian){if(offset+2<len)val=buf[offset+2]<<16;if(offset+1<len)val|=buf[offset+1]<<8;val|=buf[offset];if(offset+3<len)val=val+(buf[offset+3]<<24>>>0)}else{if(offset+1<len)val=buf[offset+1]<<16;if(offset+2<len)val|=buf[offset+2]<<8;if(offset+3<len)val|=buf[offset+3];val=val+(buf[offset]<<24>>>0)}return val}Buffer.prototype.readUInt32LE=function(offset,noAssert){return _readUInt32(this,offset,true,noAssert)};Buffer.prototype.readUInt32BE=function(offset,noAssert){return _readUInt32(this,offset,false,noAssert)};Buffer.prototype.readInt8=function(offset,noAssert){if(!noAssert){assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<this.length,"Trying to read beyond buffer length")}if(offset>=this.length)return;var neg=this[offset]&128;if(neg)return(255-this[offset]+1)*-1;else return this[offset]};function _readInt16(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val=_readUInt16(buf,offset,littleEndian,true);var neg=val&32768;if(neg)return(65535-val+1)*-1;else return val}Buffer.prototype.readInt16LE=function(offset,noAssert){return _readInt16(this,offset,true,noAssert)};Buffer.prototype.readInt16BE=function(offset,noAssert){return _readInt16(this,offset,false,noAssert)};function _readInt32(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to read beyond buffer length")}var len=buf.length;if(offset>=len)return;var val=_readUInt32(buf,offset,littleEndian,true);var neg=val&2147483648;if(neg)return(4294967295-val+1)*-1;else return val}Buffer.prototype.readInt32LE=function(offset,noAssert){return _readInt32(this,offset,true,noAssert)};Buffer.prototype.readInt32BE=function(offset,noAssert){return _readInt32(this,offset,false,noAssert)};function _readFloat(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+3<buf.length,"Trying to read beyond buffer length")}return ieee754.read(buf,offset,littleEndian,23,4)}Buffer.prototype.readFloatLE=function(offset,noAssert){return _readFloat(this,offset,true,noAssert)};Buffer.prototype.readFloatBE=function(offset,noAssert){return _readFloat(this,offset,false,noAssert)};function _readDouble(buf,offset,littleEndian,noAssert){if(!noAssert){assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset+7<buf.length,"Trying to read beyond buffer length")}return ieee754.read(buf,offset,littleEndian,52,8)}Buffer.prototype.readDoubleLE=function(offset,noAssert){return _readDouble(this,offset,true,noAssert)};Buffer.prototype.readDoubleBE=function(offset,noAssert){return _readDouble(this,offset,false,noAssert)};Buffer.prototype.writeUInt8=function(value,offset,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<this.length,"trying to write beyond buffer length");verifuint(value,255)}if(offset>=this.length)return;this[offset]=value};function _writeUInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"trying to write beyond buffer length");verifuint(value,65535)}var len=buf.length;if(offset>=len)return;for(var i=0,j=Math.min(len-offset,2);i<j;i++){buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>(littleEndian?i:1-i)*8}}Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){_writeUInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){_writeUInt16(this,value,offset,false,noAssert)};function _writeUInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"trying to write beyond buffer length");verifuint(value,4294967295)}var len=buf.length;if(offset>=len)return;for(var i=0,j=Math.min(len-offset,4);i<j;i++){buf[offset+i]=value>>>(littleEndian?i:3-i)*8&255}}Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){_writeUInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){_writeUInt32(this,value,offset,false,noAssert)};Buffer.prototype.writeInt8=function(value,offset,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset<this.length,"Trying to write beyond buffer length");verifsint(value,127,-128)}if(offset>=this.length)return;if(value>=0)this.writeUInt8(value,offset,noAssert);else this.writeUInt8(255+value+1,offset,noAssert)};function _writeInt16(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+1<buf.length,"Trying to write beyond buffer length");verifsint(value,32767,-32768)}var len=buf.length;if(offset>=len)return;if(value>=0)_writeUInt16(buf,value,offset,littleEndian,noAssert);else _writeUInt16(buf,65535+value+1,offset,littleEndian,noAssert)}Buffer.prototype.writeInt16LE=function(value,offset,noAssert){_writeInt16(this,value,offset,true,noAssert)};Buffer.prototype.writeInt16BE=function(value,offset,noAssert){_writeInt16(this,value,offset,false,noAssert)};function _writeInt32(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifsint(value,2147483647,-2147483648)}var len=buf.length;if(offset>=len)return;if(value>=0)_writeUInt32(buf,value,offset,littleEndian,noAssert);else _writeUInt32(buf,4294967295+value+1,offset,littleEndian,noAssert)}Buffer.prototype.writeInt32LE=function(value,offset,noAssert){_writeInt32(this,value,offset,true,noAssert)};Buffer.prototype.writeInt32BE=function(value,offset,noAssert){_writeInt32(this,value,offset,false,noAssert)};function _writeFloat(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+3<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,3.4028234663852886e38,-3.4028234663852886e38)}var len=buf.length;if(offset>=len)return;ieee754.write(buf,value,offset,littleEndian,23,4)}Buffer.prototype.writeFloatLE=function(value,offset,noAssert){_writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function(value,offset,noAssert){_writeFloat(this,value,offset,false,noAssert)};function _writeDouble(buf,value,offset,littleEndian,noAssert){if(!noAssert){assert(value!==undefined&&value!==null,"missing value");assert(typeof littleEndian==="boolean","missing or invalid endian");assert(offset!==undefined&&offset!==null,"missing offset");assert(offset+7<buf.length,"Trying to write beyond buffer length");verifIEEE754(value,1.7976931348623157e308,-1.7976931348623157e308)}var len=buf.length;if(offset>=len)return;ieee754.write(buf,value,offset,littleEndian,52,8)}Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){_writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){_writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.fill=function(value,start,end){if(!value)value=0;if(!start)start=0;if(!end)end=this.length;if(typeof value==="string"){value=value.charCodeAt(0)}assert(typeof value==="number"&&!isNaN(value),"value is not a number");assert(end>=start,"end < start");if(end===start)return;if(this.length===0)return;assert(start>=0&&start<this.length,"start out of bounds");assert(end>=0&&end<=this.length,"end out of bounds");for(var i=start;i<end;i++){this[i]=value}};Buffer.prototype.inspect=function(){var out=[];var len=this.length;for(var i=0;i<len;i++){out[i]=toHex(this[i]);if(i===exports.INSPECT_MAX_BYTES){out[i+1]="...";break}}return"<Buffer "+out.join(" ")+">"};Buffer.prototype.toArrayBuffer=function(){if(typeof Uint8Array!=="undefined"){if(Buffer._useTypedArrays){return new Buffer(this).buffer}else{var buf=new Uint8Array(this.length);for(var i=0,len=buf.length;i<len;i+=1)buf[i]=this[i];return buf.buffer}}else{throw new Error("Buffer.toArrayBuffer not supported in this browser")}};function stringtrim(str){if(str.trim)return str.trim();return str.replace(/^\s+|\s+$/g,"")}var BP=Buffer.prototype;Buffer._augment=function(arr){arr._isBuffer=true;arr._get=arr.get;arr._set=arr.set;arr.get=BP.get;arr.set=BP.set;arr.write=BP.write;arr.toString=BP.toString;arr.toLocaleString=BP.toString;arr.toJSON=BP.toJSON;arr.copy=BP.copy;arr.slice=BP.slice;arr.readUInt8=BP.readUInt8;arr.readUInt16LE=BP.readUInt16LE;arr.readUInt16BE=BP.readUInt16BE;arr.readUInt32LE=BP.readUInt32LE;arr.readUInt32BE=BP.readUInt32BE;arr.readInt8=BP.readInt8;arr.readInt16LE=BP.readInt16LE;arr.readInt16BE=BP.readInt16BE;arr.readInt32LE=BP.readInt32LE;arr.readInt32BE=BP.readInt32BE;arr.readFloatLE=BP.readFloatLE;arr.readFloatBE=BP.readFloatBE;arr.readDoubleLE=BP.readDoubleLE;arr.readDoubleBE=BP.readDoubleBE;arr.writeUInt8=BP.writeUInt8;arr.writeUInt16LE=BP.writeUInt16LE;arr.writeUInt16BE=BP.writeUInt16BE;arr.writeUInt32LE=BP.writeUInt32LE;arr.writeUInt32BE=BP.writeUInt32BE;arr.writeInt8=BP.writeInt8;arr.writeInt16LE=BP.writeInt16LE;arr.writeInt16BE=BP.writeInt16BE;arr.writeInt32LE=BP.writeInt32LE;arr.writeInt32BE=BP.writeInt32BE;arr.writeFloatLE=BP.writeFloatLE;arr.writeFloatBE=BP.writeFloatBE;arr.writeDoubleLE=BP.writeDoubleLE;arr.writeDoubleBE=BP.writeDoubleBE;arr.fill=BP.fill;arr.inspect=BP.inspect;arr.toArrayBuffer=BP.toArrayBuffer;return arr};function clamp(index,len,defaultValue){if(typeof index!=="number")return defaultValue;index=~~index;if(index>=len)return len;if(index>=0)return index;index+=len;if(index>=0)return index;return 0}function coerce(length){length=~~Math.ceil(+length);return length<0?0:length}function isArray(subject){return(Array.isArray||function(subject){return Object.prototype.toString.call(subject)==="[object Array]"})(subject)}function isArrayish(subject){return isArray(subject)||Buffer.isBuffer(subject)||subject&&typeof subject==="object"&&typeof subject.length==="number"}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){var b=str.charCodeAt(i);if(b<=127)byteArray.push(str.charCodeAt(i));else{var start=i;if(b>=55296&&b<=57343)i++;var h=encodeURIComponent(str.slice(start,i+1)).substr(1).split("%");for(var j=0;j<h.length;j++)byteArray.push(parseInt(h[j],16))}}return byteArray}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;i++){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function utf16leToBytes(str){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;i++){c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi)}return byteArray}function base64ToBytes(str){return base64.toByteArray(str)}function blitBuffer(src,dst,offset,length){var pos;for(var i=0;i<length;i++){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function decodeUtf8Char(str){try{return decodeURIComponent(str)}catch(err){return String.fromCharCode(65533)}}function verifuint(value,max){assert(typeof value==="number","cannot write a non-number as a number");assert(value>=0,"specified a negative value for writing an unsigned value");assert(value<=max,"value is larger than maximum value for type");assert(Math.floor(value)===value,"value has a fractional component")}function verifsint(value,max,min){assert(typeof value==="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value");assert(Math.floor(value)===value,"value has a fractional component")}function verifIEEE754(value,max,min){assert(typeof value==="number","cannot write a non-number as a number");assert(value<=max,"value larger than maximum allowed value");assert(value>=min,"value smaller than minimum allowed value")}function assert(test,message){if(!test)throw new Error(message||"Failed assertion")}},{"base64-js":3,ieee754:4}],3:[function(require,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";(function(exports){"use strict";var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var ZERO="0".charCodeAt(0);var PLUS="+".charCodeAt(0);var SLASH="/".charCodeAt(0);var NUMBER="0".charCodeAt(0);var LOWER="a".charCodeAt(0);var UPPER="A".charCodeAt(0);function decode(elt){var code=elt.charCodeAt(0);if(code===PLUS)return 62;if(code===SLASH)return 63;if(code<NUMBER)return-1;if(code<NUMBER+10)return code-NUMBER+26+26;if(code<UPPER+26)return code-UPPER;if(code<LOWER+26)return code-LOWER+26}function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0;arr=new Arr(b64.length*3/4-placeHolders);l=placeHolders>0?b64.length-4:b64.length;var L=0;function push(v){arr[L++]=v}for(i=0,j=0;i<l;i+=4,j+=3){tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3));push((tmp&16711680)>>16);push((tmp&65280)>>8);push(tmp&255)}if(placeHolders===2){tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4;push(tmp&255)}else if(placeHolders===1){tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2;push(tmp>>8&255);push(tmp&255)}return arr}function uint8ToBase64(uint8){var i,extraBytes=uint8.length%3,output="",temp,length;function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(num&63)}for(i=0,length=uint8.length-extraBytes;i<length;i+=3){temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2];output+=tripletToBase64(temp)}switch(extraBytes){case 1:temp=uint8[uint8.length-1];output+=encode(temp>>2);output+=encode(temp<<4&63);output+="==";break;case 2:temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1];output+=encode(temp>>10);output+=encode(temp>>4&63);output+=encode(temp<<2&63);output+="=";break}return output}module.exports.toByteArray=b64ToByteArray;module.exports.fromByteArray=uint8ToBase64})()},{}],4:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8);m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8);if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=nBytes*8-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8);e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=s*128}},{}],5:[function(require,module,exports){var Buffer=require("buffer").Buffer;var intSize=4;var zeroBuffer=new Buffer(intSize);zeroBuffer.fill(0);var chrsz=8;function toArray(buf,bigEndian){if(buf.length%intSize!==0){var len=buf.length+(intSize-buf.length%intSize);buf=Buffer.concat([buf,zeroBuffer],len)}var arr=[];var fn=bigEndian?buf.readInt32BE:buf.readInt32LE;for(var i=0;i<buf.length;i+=intSize){arr.push(fn.call(buf,i))}return arr}function toBuffer(arr,size,bigEndian){var buf=new Buffer(size);var fn=bigEndian?buf.writeInt32BE:buf.writeInt32LE;for(var i=0;i<arr.length;i++){fn.call(buf,arr[i],i*4,true)}return buf}function hash(buf,fn,hashSize,bigEndian){if(!Buffer.isBuffer(buf))buf=new Buffer(buf);var arr=fn(toArray(buf,bigEndian),buf.length*chrsz);return toBuffer(arr,hashSize,bigEndian)}module.exports={hash:hash}},{buffer:2}],6:[function(require,module,exports){var Buffer=require("buffer").Buffer;var sha=require("./sha");var sha256=require("./sha256");var rng=require("./rng");var md5=require("./md5");var algorithms={sha1:sha,sha256:sha256,md5:md5};var blocksize=64;var zeroBuffer=new Buffer(blocksize);zeroBuffer.fill(0);function hmac(fn,key,data){if(!Buffer.isBuffer(key))key=new Buffer(key);if(!Buffer.isBuffer(data))data=new Buffer(data);if(key.length>blocksize){key=fn(key)}else if(key.length<blocksize){key=Buffer.concat([key,zeroBuffer],blocksize)}var ipad=new Buffer(blocksize),opad=new Buffer(blocksize);for(var i=0;i<blocksize;i++){ipad[i]=key[i]^54;opad[i]=key[i]^92}var hash=fn(Buffer.concat([ipad,data]));return fn(Buffer.concat([opad,hash]))}function hash(alg,key){alg=alg||"sha1";var fn=algorithms[alg];var bufs=[];var length=0;if(!fn)error("algorithm:",alg,"is not yet supported");return{update:function(data){if(!Buffer.isBuffer(data))data=new Buffer(data);bufs.push(data);length+=data.length;return this},digest:function(enc){var buf=Buffer.concat(bufs);var r=key?hmac(fn,key,buf):fn(buf);bufs=null;return enc?r.toString(enc):r}}}function error(){var m=[].slice.call(arguments).join(" ");throw new Error([m,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join("\n"))}exports.createHash=function(alg){return hash(alg)};exports.createHmac=function(alg,key){return hash(alg,key)};exports.randomBytes=function(size,callback){if(callback&&callback.call){try{callback.call(this,undefined,new Buffer(rng(size)))}catch(err){callback(err)}}else{return new Buffer(rng(size))}};function each(a,f){for(var i in a)f(a[i],i)}each(["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],function(name){exports[name]=function(){error("sorry,",name,"is not implemented yet")}})},{"./md5":7,"./rng":8,"./sha":9,"./sha256":10,buffer:2}],7:[function(require,module,exports){var helpers=require("./helpers");function md5_vm_test(){return hex_md5("abc")=="900150983cd24fb0d6963f7d28e17f72"}function core_md5(x,len){x[len>>5]|=128<<len%32;x[(len+64>>>9<<4)+14]=len;var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;a=md5_ff(a,b,c,d,x[i+0],7,-680876936);d=md5_ff(d,a,b,c,x[i+1],12,-389564586);c=md5_ff(c,d,a,b,x[i+2],17,606105819);b=md5_ff(b,c,d,a,x[i+3],22,-1044525330);a=md5_ff(a,b,c,d,x[i+4],7,-176418897);d=md5_ff(d,a,b,c,x[i+5],12,1200080426);c=md5_ff(c,d,a,b,x[i+6],17,-1473231341);b=md5_ff(b,c,d,a,x[i+7],22,-45705983);a=md5_ff(a,b,c,d,x[i+8],7,1770035416);d=md5_ff(d,a,b,c,x[i+9],12,-1958414417);c=md5_ff(c,d,a,b,x[i+10],17,-42063);b=md5_ff(b,c,d,a,x[i+11],22,-1990404162);a=md5_ff(a,b,c,d,x[i+12],7,1804603682);d=md5_ff(d,a,b,c,x[i+13],12,-40341101);c=md5_ff(c,d,a,b,x[i+14],17,-1502002290);b=md5_ff(b,c,d,a,x[i+15],22,1236535329);a=md5_gg(a,b,c,d,x[i+1],5,-165796510);d=md5_gg(d,a,b,c,x[i+6],9,-1069501632);c=md5_gg(c,d,a,b,x[i+11],14,643717713);b=md5_gg(b,c,d,a,x[i+0],20,-373897302);a=md5_gg(a,b,c,d,x[i+5],5,-701558691);d=md5_gg(d,a,b,c,x[i+10],9,38016083);c=md5_gg(c,d,a,b,x[i+15],14,-660478335);b=md5_gg(b,c,d,a,x[i+4],20,-405537848);a=md5_gg(a,b,c,d,x[i+9],5,568446438);d=md5_gg(d,a,b,c,x[i+14],9,-1019803690);c=md5_gg(c,d,a,b,x[i+3],14,-187363961);b=md5_gg(b,c,d,a,x[i+8],20,1163531501);a=md5_gg(a,b,c,d,x[i+13],5,-1444681467);d=md5_gg(d,a,b,c,x[i+2],9,-51403784);c=md5_gg(c,d,a,b,x[i+7],14,1735328473);b=md5_gg(b,c,d,a,x[i+12],20,-1926607734);a=md5_hh(a,b,c,d,x[i+5],4,-378558);d=md5_hh(d,a,b,c,x[i+8],11,-2022574463);c=md5_hh(c,d,a,b,x[i+11],16,1839030562);b=md5_hh(b,c,d,a,x[i+14],23,-35309556);a=md5_hh(a,b,c,d,x[i+1],4,-1530992060);d=md5_hh(d,a,b,c,x[i+4],11,1272893353);c=md5_hh(c,d,a,b,x[i+7],16,-155497632);b=md5_hh(b,c,d,a,x[i+10],23,-1094730640);a=md5_hh(a,b,c,d,x[i+13],4,681279174);d=md5_hh(d,a,b,c,x[i+0],11,-358537222);c=md5_hh(c,d,a,b,x[i+3],16,-722521979);b=md5_hh(b,c,d,a,x[i+6],23,76029189);a=md5_hh(a,b,c,d,x[i+9],4,-640364487);d=md5_hh(d,a,b,c,x[i+12],11,-421815835);c=md5_hh(c,d,a,b,x[i+15],16,530742520);b=md5_hh(b,c,d,a,x[i+2],23,-995338651);a=md5_ii(a,b,c,d,x[i+0],6,-198630844);d=md5_ii(d,a,b,c,x[i+7],10,1126891415);c=md5_ii(c,d,a,b,x[i+14],15,-1416354905);b=md5_ii(b,c,d,a,x[i+5],21,-57434055);a=md5_ii(a,b,c,d,x[i+12],6,1700485571);d=md5_ii(d,a,b,c,x[i+3],10,-1894986606);c=md5_ii(c,d,a,b,x[i+10],15,-1051523);b=md5_ii(b,c,d,a,x[i+1],21,-2054922799);a=md5_ii(a,b,c,d,x[i+8],6,1873313359);d=md5_ii(d,a,b,c,x[i+15],10,-30611744);c=md5_ii(c,d,a,b,x[i+6],15,-1560198380);b=md5_ii(b,c,d,a,x[i+13],21,1309151649);a=md5_ii(a,b,c,d,x[i+4],6,-145523070);d=md5_ii(d,a,b,c,x[i+11],10,-1120210379);c=md5_ii(c,d,a,b,x[i+2],15,718787259);b=md5_ii(b,c,d,a,x[i+9],21,-343485551);a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd)}return Array(a,b,c,d)
}function md5_cmn(q,a,b,x,s,t){return safe_add(bit_rol(safe_add(safe_add(a,q),safe_add(x,t)),s),b)}function md5_ff(a,b,c,d,x,s,t){return md5_cmn(b&c|~b&d,a,b,x,s,t)}function md5_gg(a,b,c,d,x,s,t){return md5_cmn(b&d|c&~d,a,b,x,s,t)}function md5_hh(a,b,c,d,x,s,t){return md5_cmn(b^c^d,a,b,x,s,t)}function md5_ii(a,b,c,d,x,s,t){return md5_cmn(c^(b|~d),a,b,x,s,t)}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function bit_rol(num,cnt){return num<<cnt|num>>>32-cnt}module.exports=function md5(buf){return helpers.hash(buf,core_md5,16)}},{"./helpers":5}],8:[function(require,module,exports){(function(){var _global=this;var mathRNG,whatwgRNG;mathRNG=function(size){var bytes=new Array(size);var r;for(var i=0,r;i<size;i++){if((i&3)==0)r=Math.random()*4294967296;bytes[i]=r>>>((i&3)<<3)&255}return bytes};if(_global.crypto&&crypto.getRandomValues){whatwgRNG=function(size){var bytes=new Uint8Array(size);crypto.getRandomValues(bytes);return bytes}}module.exports=whatwgRNG||mathRNG})()},{}],9:[function(require,module,exports){var helpers=require("./helpers");function core_sha1(x,len){x[len>>5]|=128<<24-len%32;x[(len+64>>9<<4)+15]=len;var w=Array(80);var a=1732584193;var b=-271733879;var c=-1732584194;var d=271733878;var e=-1009589776;for(var i=0;i<x.length;i+=16){var olda=a;var oldb=b;var oldc=c;var oldd=d;var olde=e;for(var j=0;j<80;j++){if(j<16)w[j]=x[i+j];else w[j]=rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1);var t=safe_add(safe_add(rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j)));e=d;d=c;c=rol(b,30);b=a;a=t}a=safe_add(a,olda);b=safe_add(b,oldb);c=safe_add(c,oldc);d=safe_add(d,oldd);e=safe_add(e,olde)}return Array(a,b,c,d,e)}function sha1_ft(t,b,c,d){if(t<20)return b&c|~b&d;if(t<40)return b^c^d;if(t<60)return b&c|b&d|c&d;return b^c^d}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function safe_add(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535}function rol(num,cnt){return num<<cnt|num>>>32-cnt}module.exports=function sha1(buf){return helpers.hash(buf,core_sha1,20,true)}},{"./helpers":5}],10:[function(require,module,exports){var helpers=require("./helpers");var safe_add=function(x,y){var lsw=(x&65535)+(y&65535);var msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|lsw&65535};var S=function(X,n){return X>>>n|X<<32-n};var R=function(X,n){return X>>>n};var Ch=function(x,y,z){return x&y^~x&z};var Maj=function(x,y,z){return x&y^x&z^y&z};var Sigma0256=function(x){return S(x,2)^S(x,13)^S(x,22)};var Sigma1256=function(x){return S(x,6)^S(x,11)^S(x,25)};var Gamma0256=function(x){return S(x,7)^S(x,18)^R(x,3)};var Gamma1256=function(x){return S(x,17)^S(x,19)^R(x,10)};var core_sha256=function(m,l){var K=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298);var HASH=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225);var W=new Array(64);var a,b,c,d,e,f,g,h,i,j;var T1,T2;m[l>>5]|=128<<24-l%32;m[(l+64>>9<<4)+15]=l;for(var i=0;i<m.length;i+=16){a=HASH[0];b=HASH[1];c=HASH[2];d=HASH[3];e=HASH[4];f=HASH[5];g=HASH[6];h=HASH[7];for(var j=0;j<64;j++){if(j<16){W[j]=m[j+i]}else{W[j]=safe_add(safe_add(safe_add(Gamma1256(W[j-2]),W[j-7]),Gamma0256(W[j-15])),W[j-16])}T1=safe_add(safe_add(safe_add(safe_add(h,Sigma1256(e)),Ch(e,f,g)),K[j]),W[j]);T2=safe_add(Sigma0256(a),Maj(a,b,c));h=g;g=f;f=e;e=safe_add(d,T1);d=c;c=b;b=a;a=safe_add(T1,T2)}HASH[0]=safe_add(a,HASH[0]);HASH[1]=safe_add(b,HASH[1]);HASH[2]=safe_add(c,HASH[2]);HASH[3]=safe_add(d,HASH[3]);HASH[4]=safe_add(e,HASH[4]);HASH[5]=safe_add(f,HASH[5]);HASH[6]=safe_add(g,HASH[6]);HASH[7]=safe_add(h,HASH[7])}return HASH};module.exports=function sha256(buf){return helpers.hash(buf,core_sha256,32,true)}},{"./helpers":5}],11:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{throw TypeError('Uncaught, unspecified "error" event.')}return false}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];handler.apply(this,args)}}else if(isObject(handler)){len=arguments.length;args=new Array(len-1);for(i=1;i<len;i++)args[i-1]=arguments[i];listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){var m;if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);console.trace()}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-->0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else{while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.listenerCount=function(emitter,type){var ret;if(!emitter._events||!emitter._events[type])ret=0;else if(isFunction(emitter._events[type]))ret=1;else ret=emitter._events[type].length;return ret};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],12:[function(require,module,exports){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){var source=ev.source;if((source===window||source===null)&&ev.data==="process-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("process-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];function noop(){}process.on=noop;process.once=noop;process.off=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],13:[function(require,module,exports){(function(process){function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts}var splitPathRe=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;var splitPath=function(filename){return splitPathRe.exec(filename).slice(1)};exports.resolve=function(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=="string"){throw new TypeError("Arguments to path.resolve must be strings")}else if(!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=normalizeArray(filter(resolvedPath.split("/"),function(p){return!!p}),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."};exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=substr(path,-1)==="/";path=normalizeArray(filter(path.split("/"),function(p){return!!p}),!isAbsolute).join("/");if(!path&&!isAbsolute){path="."}if(path&&trailingSlash){path+="/"}return(isAbsolute?"/":"")+path};exports.isAbsolute=function(path){return path.charAt(0)==="/"};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){if(typeof p!=="string"){throw new TypeError("Arguments to path.join must be strings")}return p}).join("/"))};exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=="")break}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=="")break}if(start>end)return[];return arr.slice(start,end-start+1)}var fromParts=trim(from.split("/"));var toParts=trim(to.split("/"));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push("..")}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join("/")};exports.sep="/";exports.delimiter=":";exports.dirname=function(path){var result=splitPath(path),root=result[0],dir=result[1];if(!root&&!dir){return"."}if(dir){dir=dir.substr(0,dir.length-1)}return root+dir};exports.basename=function(path,ext){var f=splitPath(path)[2];if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length)}return f};exports.extname=function(path){return splitPath(path)[3]};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i])}return res}var substr="ab".substr(-1)==="b"?function(str,start,len){return str.substr(start,len)}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len)}}).call(this,require("/Users/enjamini/code/codeparty/derby-standalone/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"/Users/enjamini/code/codeparty/derby-standalone/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":12}],14:[function(require,module,exports){(function(global){(function(root){var freeExports=typeof exports=="object"&&exports;var freeModule=typeof module=="object"&&module&&module.exports==freeExports&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^ -~]/,regexSeparators=/\x2E|\u3002|\uFF0E|\uFF61/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw RangeError(errors[type])}function map(array,fn){var length=array.length;while(length--){array[length]=fn(array[length])}return array}function mapDomain(string,fn){return map(string.split(regexSeparators),fn).join(".")}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(domain){return mapDomain(domain,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(domain){return mapDomain(domain,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.2.4",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define("punycode",function(){return punycode})}else if(freeExports&&!freeExports.nodeType){if(freeModule){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],15:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],16:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return obj[k].map(function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],17:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":15,"./encode":16}],18:[function(require,module,exports){(function(){"use strict";var punycode=require("punycode");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","~","`"].concat(delims),autoEscape=["'"].concat(delims),nonHostChars=["%","/","?",";","#"].concat(unwise).concat(autoEscape),nonAuthChars=["/","@","?","#"].concat(delims),hostnameMaxLen=255,hostnamePartPattern=/^[a-zA-Z0-9][a-z0-9A-Z_-]{0,62}$/,hostnamePartStart=/^([a-zA-Z0-9][a-z0-9A-Z_-]{0,62})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},pathedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"ftp:":true,"gopher:":true,"file:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&typeof url==="object"&&url.href)return url;if(typeof url!=="string"){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var out={},rest=url;rest=rest.trim();var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();out.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);out.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var atSign=rest.indexOf("@");if(atSign!==-1){var auth=rest.slice(0,atSign);var hasAuth=true;for(var i=0,l=nonAuthChars.length;i<l;i++){if(auth.indexOf(nonAuthChars[i])!==-1){hasAuth=false;break}}if(hasAuth){out.auth=decodeURIComponent(auth);rest=rest.substr(atSign+1)}}var firstNonHost=-1;for(var i=0,l=nonHostChars.length;i<l;i++){var index=rest.indexOf(nonHostChars[i]);if(index!==-1&&(firstNonHost<0||index<firstNonHost))firstNonHost=index}if(firstNonHost!==-1){out.host=rest.substr(0,firstNonHost);rest=rest.substr(firstNonHost)}else{out.host=rest;rest=""}var p=parseHost(out.host);var keys=Object.keys(p);for(var i=0,l=keys.length;i<l;i++){var key=keys[i];out[key]=p[key]}out.hostname=out.hostname||"";var ipv6Hostname=out.hostname[0]==="["&&out.hostname[out.hostname.length-1]==="]";if(out.hostname.length>hostnameMaxLen){out.hostname=""}else if(!ipv6Hostname){var hostparts=out.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}out.hostname=validParts.join(".");break}}}}out.hostname=out.hostname.toLowerCase();if(!ipv6Hostname){var domainArray=out.hostname.split(".");var newOut=[];for(var i=0;i<domainArray.length;++i){var s=domainArray[i];newOut.push(s.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(s):s)}out.hostname=newOut.join(".")}out.host=(out.hostname||"")+(out.port?":"+out.port:"");out.href+=out.host;if(ipv6Hostname){out.hostname=out.hostname.substr(1,out.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){out.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){out.search=rest.substr(qm);out.query=rest.substr(qm+1);if(parseQueryString){out.query=querystring.parse(out.query)}rest=rest.slice(0,qm)}else if(parseQueryString){out.search="";out.query={}}if(rest)out.pathname=rest;if(slashedProtocol[proto]&&out.hostname&&!out.pathname){out.pathname="/"}if(out.pathname||out.search){out.path=(out.pathname?out.pathname:"")+(out.search?out.search:"")}out.href=urlFormat(out);return out}function urlFormat(obj){if(typeof obj==="string")obj=urlParse(obj);var auth=obj.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=obj.protocol||"",pathname=obj.pathname||"",hash=obj.hash||"",host=false,query="";if(obj.host!==undefined){host=auth+obj.host}else if(obj.hostname!==undefined){host=auth+(obj.hostname.indexOf(":")===-1?obj.hostname:"["+obj.hostname+"]");if(obj.port){host+=":"+obj.port}}if(obj.query&&typeof obj.query==="object"&&Object.keys(obj.query).length){query=querystring.stringify(obj.query)}var search=obj.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(obj.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;return protocol+host+pathname+search+hash}function urlResolve(source,relative){return urlFormat(urlResolveObject(source,relative))}function urlResolveObject(source,relative){if(!source)return relative;source=urlParse(urlFormat(source),false,true);relative=urlParse(urlFormat(relative),false,true);source.hash=relative.hash;if(relative.href===""){source.href=urlFormat(source);return source}if(relative.slashes&&!relative.protocol){relative.protocol=source.protocol;if(slashedProtocol[relative.protocol]&&relative.hostname&&!relative.pathname){relative.path=relative.pathname="/"}relative.href=urlFormat(relative);return relative}if(relative.protocol&&relative.protocol!==source.protocol){if(!slashedProtocol[relative.protocol]){relative.href=urlFormat(relative);return relative}source.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");relative.pathname=relPath.join("/")}source.pathname=relative.pathname;source.search=relative.search;source.query=relative.query;source.host=relative.host||"";source.auth=relative.auth;source.hostname=relative.hostname||relative.host;source.port=relative.port;if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.slashes=source.slashes||relative.slashes;source.href=urlFormat(source);return source}var isSourceAbs=source.pathname&&source.pathname.charAt(0)==="/",isRelAbs=relative.host!==undefined||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||source.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=source.pathname&&source.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=source.protocol&&!slashedProtocol[source.protocol];if(psychotic){delete source.hostname;delete source.port;if(source.host){if(srcPath[0]==="")srcPath[0]=source.host;else srcPath.unshift(source.host)}delete source.host;if(relative.protocol){delete relative.hostname;delete relative.port;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}delete relative.host}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){source.host=relative.host||relative.host===""?relative.host:source.host;source.hostname=relative.hostname||relative.hostname===""?relative.hostname:source.hostname;source.search=relative.search;source.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);source.search=relative.search;source.query=relative.query}else if("search"in relative){if(psychotic){source.hostname=source.host=srcPath.shift();var authInHost=source.host&&source.host.indexOf("@")>0?source.host.split("@"):false;if(authInHost){source.auth=authInHost.shift();source.host=source.hostname=authInHost.shift()}}source.search=relative.search;source.query=relative.query;if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.href=urlFormat(source);return source}if(!srcPath.length){delete source.pathname;if(!source.search){source.path="/"+source.search}else{delete source.path}source.href=urlFormat(source);return source}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(source.host||relative.host)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last=="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){source.hostname=source.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=source.host&&source.host.indexOf("@")>0?source.host.split("@"):false;if(authInHost){source.auth=authInHost.shift();source.host=source.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||source.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}source.pathname=srcPath.join("/");if(source.pathname!==undefined||source.search!==undefined){source.path=(source.pathname?source.pathname:"")+(source.search?source.search:"")}source.auth=relative.auth||source.auth;source.slashes=source.slashes||relative.slashes;source.href=urlFormat(source);return source}function parseHost(host){var out={};var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){out.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)out.hostname=host;return out}})()},{punycode:14,querystring:17}],19:[function(require,module,exports){(function(process,global,__dirname){var EventEmitter=require("events").EventEmitter;var tracks=require("tracks");var util=require("racer/lib/util");var derbyTemplates=require("derby-templates");var documentListeners=require("./documentListeners");var Page=require("./Page");module.exports=App;function App(derby,name,filename){EventEmitter.call(this);this.derby=derby;this.name=name;this.filename=filename;this.Page=createAppPage();this.proto=this.Page.prototype;this.views=new derbyTemplates.templates.Views;this.tracksRoutes=tracks.setup(this);this.model=null;this.page=null;this._init()}function createAppPage(){function AppPage(){Page.apply(this,arguments)}AppPage.prototype=Object.create(Page.prototype);return AppPage}util.mergeInto(App.prototype,EventEmitter.prototype);App.prototype._init=function(){var serializedViews=require("./_views");serializedViews(derbyTemplates,this.views);
this.model=new this.derby.Model;var app=this;process.nextTick(function(){app.emit("model",app.model);var script=app._getScript();var data=JSON.parse(script.getAttribute("data-bundle"));script.removeAttribute("data-bundle");app.model.createConnection(data);app.model.unbundle(data);app._autoRefresh();var page=app.createPage();page.params=app.model.get("$render.params");page.attach();app.emit("ready")})};App.prototype._getScript=function(){return document.querySelector('script[src="/derby/'+this.name+'"]')};App.prototype.use=util.use;App.prototype.loadViews=function(){};App.prototype.loadStyles=function(){};App.prototype.createPage=function(){if(this.page)this.page.destroy();var page=new this.Page(this,this.model);this.page=page;return page};App.prototype.onRoute=function(callback,page,params,next,isTransitional,done){if(isTransitional){if(callback.length===4){callback(page.model,params,next,done);return true}else{callback(page.model,params,next);return}}callback(page,page.model,params,next)};App.prototype._autoRefresh=function(){if(util.isProduction)return;var app=this;this.model.on("change","$connection.state",function(state){if(state==="connected")registerClient()});this.model.channel.on("derby:refreshViews",function(serializedViews){var fn=new Function("return "+serializedViews)();fn(derbyTemplates,app.views);var ns=app.model.get("$render.ns");app.page.render(ns)});function registerClient(){var data={name:app.name,hash:global.DERBY_SCRIPT_HASH};app.model.channel.send("derby:app",data,function(err){if(!err)return;setTimeout(function(){window.location=window.location},100)})}registerClient()};util.serverRequire(__dirname+"/App.server")}).call(this,require("/Users/enjamini/code/codeparty/derby-standalone/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"),typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},"/node_modules/derby/lib")},{"./Page":23,"./_views":24,"./documentListeners":26,"/Users/enjamini/code/codeparty/derby-standalone/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":12,"derby-templates":33,events:11,"racer/lib/util":56,tracks:61}],20:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var util=require("racer/lib/util");var Dom=require("./Dom");module.exports=Controller;function Controller(){EventEmitter.call(this);this.dom=new Dom(this)}util.mergeInto(Controller.prototype,EventEmitter.prototype);Controller.prototype.emitCancellable=function(){var cancelled=false;function cancel(){cancelled=true}var args=Array.prototype.slice.call(arguments);args.push(cancel);this.emit.apply(this,args);return cancelled};Controller.prototype.emitDelayable=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var delayed=false;function delay(){delayed=true;return callback}args.push(delay);this.emit.apply(this,args);if(!delayed)callback();return delayed}},{"./Dom":22,events:11,"racer/lib/util":56}],21:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var Model=require("racer/lib/Model/ModelStandalone");var util=require("racer/lib/util");var App=require("./App");var Page=require("./Page");var components=require("./components");module.exports=DerbyStandalone;require("./documentListeners").add(document);function DerbyStandalone(){EventEmitter.call(this)}util.mergeInto(DerbyStandalone.prototype,EventEmitter.prototype);DerbyStandalone.prototype.Model=Model;DerbyStandalone.prototype.util=util;DerbyStandalone.prototype.App=App;DerbyStandalone.prototype.Page=Page;DerbyStandalone.prototype.Component=components.Component;DerbyStandalone.prototype.createApp=function(){return new App(this)};App.prototype._init=function(){this.model=new this.derby.Model;this.createPage()}},{"./App":19,"./Page":23,"./components":25,"./documentListeners":26,events:11,"racer/lib/Model/ModelStandalone":45,"racer/lib/util":56}],22:[function(require,module,exports){module.exports=Dom;function Dom(controller){this.controller=controller;this._listeners=null}Dom.prototype._initListeners=function(){var dom=this;this.controller.on("destroy",function domOnDestroy(){var listeners=dom._listeners;if(!listeners)return;for(var i=listeners.length;i--;){listeners[i].remove()}dom._listeners=null});return this._listeners=[]};Dom.prototype._listenerIndex=function(domListener){var listeners=this._listeners;if(!listeners)return-1;for(var i=listeners.length;i--;){if(listeners[i].equals(domListener))return i}return-1};Dom.prototype.addListener=function(type,target,listener,useCapture){if(typeof target==="function"){useCapture=listener;listener=target;target=document}var domListener=new DomListener(type,target,listener,useCapture);if(-1===this._listenerIndex(domListener)){var listeners=this._listeners||this._initListeners();listeners.push(domListener)}domListener.add()};Dom.prototype.on=Dom.prototype.addListener;Dom.prototype.once=function(type,target,listener,useCapture){if(typeof target==="function"){useCapture=listener;listener=target;target=document}this.addListener(type,target,wrappedListener,useCapture);var dom=this;function wrappedListener(){dom.removeListener(type,target,wrappedListener,useCapture);return listener.apply(this,arguments)}};Dom.prototype.removeListener=function(type,target,listener,useCapture){if(typeof target==="function"){useCapture=listener;listener=target;target=document}var domListener=new DomListener(type,target,listener,useCapture);domListener.remove();var i=this._listenerIndex(domListener);if(i>-1)this._listeners.splice(i,1)};function DomListener(type,target,listener,useCapture){this.type=type;this.target=target;this.listener=listener;this.useCapture=!!useCapture}DomListener.prototype.equals=function(domListener){return this.listener===domListener.listener&&this.target===domListener.target&&this.type===domListener.type&&this.useCapture===domListener.useCapture};DomListener.prototype.add=function(){this.target.addEventListener(this.type,this.listener,this.useCapture)};DomListener.prototype.remove=function(){this.target.removeEventListener(this.type,this.listener,this.useCapture)}},{}],23:[function(require,module,exports){(function(global,__dirname){var derbyTemplates=require("derby-templates");var contexts=derbyTemplates.contexts;var expressions=derbyTemplates.expressions;var templates=derbyTemplates.templates;var util=require("racer/lib/util");var EventModel=require("./eventmodel");var textDiff=require("./textDiff");var Controller=require("./Controller");module.exports=Page;function Page(app,model,req,res){Controller.call(this);this.page=this;this.app=app;this.model=model;this.req=req;this.res=res;this.params=null;if(this.init)this.init(model);this.context=this._createContext();this._eventModel=null;this._removeModelListeners=null;this._components={};this._addListeners()}Page.prototype=Object.create(global,{parent:{value:null}});util.mergeInto(Page.prototype,Controller.prototype);Page.prototype.$bodyClass=function(ns){if(!ns)return;var classNames=[];var segments=ns.split(":");for(var i=0,len=segments.length;i<len;i++){var className=segments.slice(0,i+1).join("-");classNames.push(className)}return classNames.join(" ")};Page.prototype.$preventDefault=function(e){e.preventDefault()};Page.prototype.$stopPropagation=function(e){e.stopPropagation()};Page.prototype._setRenderParams=function(ns){this.model.set("$render.ns",ns);this.model.set("$render.params",this.params);this.model.set("$render.url",this.params&&this.params.url);this.model.set("$render.query",this.params&&this.params.query)};Page.prototype._setRenderPrefix=function(ns){var prefix=ns?ns+":":"";this.model.set("$render.prefix",prefix)};Page.prototype.get=function(viewName,ns){this._setRenderPrefix(ns);var view=this.getView(viewName,ns);return view.get(this.context,view.string)};Page.prototype.getFragment=function(viewName,ns){this._setRenderPrefix(ns);var view=this.getView(viewName,ns);return view.getFragment(this.context)};Page.prototype.getView=function(viewName,ns){return this.app.views.find(viewName,ns)};Page.prototype.render=function(ns){this.context.pause();this._setRenderParams(ns);var fragment=this.getFragment("Page",ns);document.body.innerHTML="";document.body.offsetTop;document.replaceChild(fragment,document.documentElement);this.context.unpause()};Page.prototype.attach=function(){this.context.pause();var ns=this.model.get("$render.ns");var view=this.getView("Page",ns);view.attachTo(document,document.firstChild,this.context);if(this.create)this.create(this.model,this.dom);this.context.unpause()};Page.prototype._createContext=function(){var contextMeta=new contexts.ContextMeta;contextMeta.views=this.app&&this.app.views;var context=new contexts.Context(contextMeta,this);context.expression=new expressions.PathExpression([]);context.alias="#root";return context};Page.prototype._addListeners=function(){var eventModel=this._eventModel=new EventModel;this._addModelListeners(eventModel);this._addContextListeners(eventModel)};Page.prototype.destroy=function(){this.emit("destroy");this._removeModelListeners();for(var id in this._components){var component=this._components[id];component.destroy()}var silentModel=this.model.silent();silentModel.destroy("_page");silentModel.destroy("$components");silentModel.unloadAll&&silentModel.unloadAll()};Page.prototype._addModelListeners=function(eventModel){var model=this.model;if(!model)return;var context=this.context;var changeListener=model.on("change","**",function onChange(path,value,previous,pass){var segments=util.castSegments(path.split("."));context.pause();pass.previous=previous;eventModel.set(segments,pass);context.unpause()});var loadListener=model.on("load","**",function onLoad(path){var segments=util.castSegments(path.split("."));context.pause();eventModel.set(segments);context.unpause()});var unloadListener=model.on("unload","**",function onUnload(path){var segments=util.castSegments(path.split("."));context.pause();eventModel.set(segments);context.unpause()});var insertListener=model.on("insert","**",function onInsert(path,index,values){var segments=util.castSegments(path.split("."));context.pause();eventModel.insert(segments,index,values.length);context.unpause()});var removeListener=model.on("remove","**",function onRemove(path,index,values){var segments=util.castSegments(path.split("."));context.pause();eventModel.remove(segments,index,values.length);context.unpause()});var moveListener=model.on("move","**",function onMove(path,from,to,howMany){var segments=util.castSegments(path.split("."));context.pause();eventModel.move(segments,from,to,howMany);context.unpause()});this._removeModelListeners=function(){model.removeListener("change",changeListener);model.removeListener("load",loadListener);model.removeListener("unload",unloadListener);model.removeListener("insert",insertListener);model.removeListener("remove",removeListener);model.removeListener("move",moveListener)}};Page.prototype._addContextListeners=function(eventModel){this.context.meta.addBinding=addBinding;this.context.meta.removeBinding=removeBinding;this.context.meta.addItemContext=addItemContext;this.context.meta.removeItemContext=removeItemContext;function addItemContext(context){var segments=context.expression.resolve(context);eventModel.addItemContext(segments,context)}function removeItemContext(context){}function addBinding(binding){patchTextBinding(binding);var expressions=binding.template.expressions;if(expressions){for(var i=0,len=expressions.length;i<len;i++){addDependencies(eventModel,expressions[i],binding)}}else{addDependencies(eventModel,binding.template.expression,binding)}}function removeBinding(binding){eventModel.removeBinding(binding)}};function addDependencies(eventModel,expression,binding){var dependencies=expression.dependencies(binding.context);if(!dependencies)return;for(var i=0,len=dependencies.length;i<len;i++){eventModel.addBinding(dependencies[i],binding)}}function patchTextBinding(binding){if(binding instanceof templates.AttributeBinding&&binding.name==="value"&&(binding.element.tagName==="INPUT"||binding.element.tagName==="TEXTAREA")&&binding.template.expression.resolve(binding.context)){binding.update=textUpdate}}function textUpdate(pass){if(pass){if(pass.$event&&pass.$event.target===this.element){return}else if(pass.$type==="stringInsert"){return textDiff.onStringInsert(this.element,pass.previous,pass.index,pass.text)}else if(pass.$type==="stringRemove"){return textDiff.onStringRemove(this.element,pass.previous,pass.index,pass.howMany)}}this.template.update(this.context,this)}util.serverRequire(__dirname+"/Page.server")}).call(this,typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},"/node_modules/derby/lib")},{"./Controller":20,"./eventmodel":27,"./textDiff":28,"derby-templates":33,"racer/lib/util":56}],24:[function(require,module,exports){},{}],25:[function(require,module,exports){var path=require("path");var util=require("racer/lib/util");var derbyTemplates=require("derby-templates");var templates=derbyTemplates.templates;var expressions=derbyTemplates.expressions;var App=require("./App");var Controller=require("./Controller");exports.Component=Component;exports.ComponentFactory=ComponentFactory;exports.SingletonComponentFactory=SingletonComponentFactory;exports.createFactory=createFactory;function Component(id,model,parent){this.id=id;this.model=model;this.parent=parent;this.page=parent&&parent.page;this.app=this.page&&this.page.app;this._scope=["$components",id]}util.mergeInto(Component.prototype,Controller.prototype);Component.prototype.destroy=function(){this.emit("destroy")};function createComponent(Constructor,context,componentContext,parent,attributes){var id=context.id();var scope="$components."+id;var root=context.controller.model.root;var model=root.scope(scope);model.set("id",id);model.data=model.get();if(attributes){for(var key in attributes){var attribute=attributes[key];if(attribute instanceof templates.ParentWrapper){var segments=attribute.expression&&attribute.expression.pathSegments(context);if(segments){root.ref(scope+"."+key,segments.join("."))}else{var value=attribute.get(componentContext);model.set(key,value)}}else if(typeof attribute==="object"){var value=expressions.renderValue(attribute,componentContext);model.set(key,value)}else{model.set(key,attribute)}}}var component=componentContext.controller=new Constructor;Controller.call(component);Component.call(component,id,model,parent);emitHooks(context,component);component.emit("init",component);if(component.init)component.init(model);return component}function emitHooks(context,component){if(!context.hooks)return;for(var i=0,len=context.hooks.length;i<len;i++){context.hooks[i].emit(context,component)}}function createFactory(constructor){return constructor.prototype.singleton?new SingletonComponentFactory(constructor):new ComponentFactory(constructor)}function ComponentFactory(constructor){this.constructor=constructor}ComponentFactory.prototype.init=function(context){var componentContext=context.componentChild();var component=createComponent(this.constructor,context,componentContext,context.controller,context.attributes);component.page._components[component.id]=component;return componentContext};ComponentFactory.prototype.create=function(context){var component=context.controller;component.emit("create",component);if(component.create){component.create(component.model,component.dom)}};function SingletonComponentFactory(constructor){this.constructor=constructor;this.component=null;this.created=false}SingletonComponentFactory.prototype.init=function(context){var componentContext=context.componentChild();if(this.component){componentContext.controller=this.component;emitHooks(context,this.component)}else{this.component=createComponent(this.constructor,context,componentContext)}return componentContext};SingletonComponentFactory.prototype.create=function(context){var component=context.controller;component.emit("create",component);if(!this.created&&component.create){this.created=true;component.create(component.model,component.dom)}};App.prototype.component=function(viewName,constructor){if(typeof viewName==="function"){constructor=viewName;viewName=null}extendComponent(constructor);if(constructor.prototype.view){var viewFilename=constructor.prototype.view;viewName=path.basename(viewFilename,".html");this.loadViews(viewFilename,viewName)}else if(!viewName){if(constructor.prototype.name){viewName=constructor.prototype.name;var view=this.views.register(viewName);view.template=templates.emptyTemplate}else{throw new Error("No view name specified for component")}}var view=this.views.find(viewName);if(!view){var message=this.views.findErrorMessage(viewName);throw new Error(message)}view.componentFactory=createFactory(constructor);return this};function extendComponent(constructor){if(constructor.prototype instanceof Component)return;var oldPrototype=constructor.prototype;constructor.prototype=new Component;util.mergeInto(constructor.prototype,oldPrototype)}},{"./App":19,"./Controller":20,"derby-templates":33,path:13,"racer/lib/util":56}],26:[function(require,module,exports){var textDiff=require("./textDiff");exports.add=addDocumentListeners;var INPUT_TYPE_SUPPORTS_SELECTION={text:true,search:true,url:true,tel:true,password:true};function addDocumentListeners(doc){doc.addEventListener("input",documentInput,true);doc.addEventListener("change",documentChange,true)}function documentInput(e){var target=e.target;if(!target)return;var bindAttributes=target.$bindAttributes;if(!bindAttributes)return;var tagName=target.tagName.toLowerCase();var pass={$event:e};if((tagName==="input"||tagName==="textarea")&&bindAttributes.value){var binding=bindAttributes.value;if(INPUT_TYPE_SUPPORTS_SELECTION[target.type]){textDiffBinding(binding,target.value,pass)}else{binding.template.expression.set(binding.context,target.value)}}else if(target.isContentEditable){}}function documentChange(e){var target=e.target;if(!target)return;var bindAttributes=target.$bindAttributes;var tagName=target.tagName.toLowerCase();if(tagName==="input"){if(bindAttributes&&bindAttributes.checked){var binding=bindAttributes.checked;binding.template.expression.set(binding.context,target.checked)}}else if(tagName==="select"){setOptionBindings(target)}}function textDiffBinding(binding,value,pass){var expression=binding.template.expression;var segments=expression.pathSegments(binding.context);if(segments){var model=binding.context.controller.model.pass(pass);textDiff.onTextInput(model,segments,value)}else if(expression.set){expression.set(binding.context,value)}}function setOptionBindings(parent){for(var node=parent.firstChild;node;node=node.nextSibling){if(node.tagName&&node.tagName.toLowerCase()==="option"){var binding=node.$bindAttributes&&node.$bindAttributes.selected;if(binding)binding.template.expression.set(binding.context,node.selected)}else if(node.hasChildNodes()){setOptionBindings(node)}}}},{"./textDiff":28}],27:[function(require,module,exports){var expressions=require("derby-templates").expressions;module.exports=EventModel;var nextId=1;function BindingMeta(){this.id=nextId++;this.removed=false;this.eventModels={}}function ModelRef(model,item,segments,outside){this.id=nextId++;this.model=model;this.segments=segments;this.item=item;this.outside=outside;this.result=outside.child(item).refChild(this)}ModelRef.prototype.update=function(){var segments=expressions.pathSegments(this.segments);var newItem=expressions.lookup(segments,this.model.data);if(this.item===newItem)return;delete this.outside.child(this.item).refChildren[this.id];this.item=newItem;var container=this.outside.child(this.item);if(!container.refChildren)container.refChildren=new RefChildrenMap;container.refChildren[this.id]=this.result;this.result.update()};function RefOutMap(){}function RefChildrenMap(){}function BindingsMap(){}function ItemContextsMap(){}function EventModel(){this.id=nextId++;this.object=null;this.array=null;this.arrayByReference=null;this.refOut=null;this.refChildren=null;this.bindings=null;this.itemContexts=null}EventModel.prototype.refChild=function(ref){if(!this.refChildren)this.refChildren=new RefChildrenMap;var id=ref.id;if(!this.refChildren[id]){this.refChildren[id]=new EventModel}return this.refChildren[id]};EventModel.prototype.arrayLookup=function(model,segmentsBefore,segmentsInside){var segments=expressions.pathSegments(segmentsInside);var item=expressions.lookup(segments,model.data);var source=this.at(segmentsInside);var container=this.at(segmentsBefore);if(!source.refOut)source.refOut=new RefOutMap;var ref=source.refOut[container.id];if(ref==null){ref=new ModelRef(model,item,segmentsInside,container);source.refOut[container.id]=ref}return ref};EventModel.prototype.child=function(segment){var container;if(typeof segment==="string"){if(!this.object)this.object={};container=this.object}else if(typeof segment==="number"){if(!this.array)this.array=[];container=this.array}else if(segment instanceof ModelRef){return segment.result}else{if(!this.arrayByReference)this.arrayByReference=[];container=this.arrayByReference;segment=segment.item}return container[segment]||(container[segment]=new EventModel)};EventModel.prototype.at=function(segments){if(segments==null)return this;var eventModel=this;for(var i=0;i<segments.length;i++){eventModel=eventModel.child(segments[i])}return eventModel};EventModel.prototype.isEmpty=function(){if(!isEmpty(this.dependancies))return false;if(!isEmpty(this.itemContexts))return false;if(this.object){for(var k in this.object)return false;this.object=null}if(this.arrayByReference){for(var i=0;i<this.arrayByReference.length;i++){if(this.arrayByReference[i]!=null)return false}this.arrayByReference=null}if(this.array){for(var i=0;i<this.array.length;i++){if(this.array[i]!=null)return false}this.array=null}return true};EventModel.prototype._addItemContext=function(context){if(!context._id)context._id=nextId++;if(!this.itemContexts)this.itemContexts=new ItemContextsMap;this.itemContexts[context._id]=context};EventModel.prototype._removeItemContext=function(context){if(this.itemContexts){delete this.itemContexts[context._id]}};EventModel.prototype._addBinding=function(binding){var meta=binding.meta||(binding.meta=new BindingMeta);var bindings=this.bindings||(this.bindings=new BindingsMap);bindings[meta.id]=binding;meta.eventModels[this.id]=this};EventModel.prototype.addBinding=function(segments,binding){this.at(segments)._addBinding(binding)};EventModel.prototype.addItemContext=function(segments,context){this.at(segments)._addItemContext(context)};EventModel.prototype.removeBinding=function(binding){var meta=binding.meta;if(!meta)return;meta.removed=true;for(var id in meta.eventModels){var eventModel=meta.eventModels[id];if(eventModel.bindings)delete eventModel.bindings[meta.id]}meta.eventModels=null};EventModel.prototype._each=function(segments,pos,fn){if(this.refChildren){for(var id in this.refChildren){this.refChildren[id]._each(segments,pos,fn)}}if(segments.length===pos){fn(this);return}var segment=segments[pos];var child;if(typeof segment==="string"){child=this.object&&this.object[segment];if(child)child._each(segments,pos+1,fn)}else{child=this.array&&this.array[segment];if(child)child._each(segments,pos+1,fn);child=this.arrayByReference&&this.arrayByReference[segment];if(child)child._each(segments,pos+1,fn)}};EventModel.prototype.localUpdate=function(pass){if(this.bindings)for(var id in this.bindings){var binding=this.bindings[id];if(!binding.removed)binding.update(pass)}if(this.refOut)for(var id in this.refOut){var ref=this.refOut[id];ref.update()}};EventModel.prototype.update=function(pass){this.localUpdate(pass);if(this.object){for(var key in this.object){this.object[key].update()}}if(this.array){for(var i=0;i<this.array.length;i++){if(this.array[i])this.array[i].update()}}if(this.arrayByReference){for(var i=0;i<this.arrayByReference.length;i++){this.arrayByReference[i].update()}}};EventModel.prototype._updateChildItemContexts=function(from,to){if(!this.arrayByReference)return;if(from==null)from=0;if(to==null)to=this.arrayByReference.length;for(var i=from;i<to;i++){var contexts=this.arrayByReference[i]&&this.arrayByReference[i].itemContexts;if(contexts){for(var key in contexts){contexts[key].item=i}}}};EventModel.prototype._updateArray=function(from,to){if(!this.array)return;if(from==null)from=0;if(to==null)to=this.array.length;for(var i=from;i<to;i++){if(this.array[i])this.array[i].update()}};EventModel.prototype._updateObject=function(){if(this.object)for(var key in this.object){this.object[key].update()}};EventModel.prototype._set=function(pass){this.update(pass)};EventModel.prototype._insert=function(index,howMany){this._updateArray(index);if(this.arrayByReference&&this.arrayByReference.length>index){for(var i=0;i<howMany;i++){this.arrayByReference.splice(index,0,null)}this._updateChildItemContexts(index+howMany)}if(this.bindings)for(var id in this.bindings){var binding=this.bindings[id];binding.insert(index,howMany)}this._updateObject()};EventModel.prototype._remove=function(index,howMany){this._updateArray(index);if(this.arrayByReference){this.arrayByReference.splice(index,howMany);this._updateChildItemContexts(index)}if(this.bindings)for(var id in this.bindings){var binding=this.bindings[id];binding.remove(index,howMany)}this._updateObject()};EventModel.prototype._move=function(from,to,howMany){var first,end;if(from<to){first=from;end=to+howMany}else{first=to;end=from+howMany}this._updateArray(first,end);var arr=this.arrayByReference;if(arr&&arr.length>first){var values=arr.splice(from,howMany);arr.splice.apply(arr,[to,0].concat(values));this._updateChildItemContexts(first,end)}if(this.bindings)for(var id in this.bindings){var binding=this.bindings[id];binding.move(from,to,howMany)}this._updateObject()};EventModel.prototype.mutate=function(segments,fn){this._each(segments,0,fn);for(var i=0,len=segments.length;i++<len;){var wildcardSegments=segments.slice(0,i);wildcardSegments.push("*");this._each(wildcardSegments,0,childSetWildcard)}};function childSetWildcard(child){child._set()}EventModel.prototype.set=function(segments,pass){this.mutate(segments,function childSet(child){child._set(pass)})};EventModel.prototype.insert=function(segments,index,howMany){this.mutate(segments,function childInsert(child){child._insert(index,howMany)})};EventModel.prototype.remove=function(segments,index,howMany){this.mutate(segments,function childRemove(child){child._remove(index,howMany)})};EventModel.prototype.move=function(segments,from,to,howMany){this.mutate(segments,function childMove(child){child._move(from,to,howMany)})}},{"derby-templates":33}],28:[function(require,module,exports){exports.onStringInsert=onStringInsert;exports.onStringRemove=onStringRemove;exports.onTextInput=onTextInput;function onStringInsert(el,previous,index,text){function transformCursor(cursor){return index<cursor?cursor+text.length:cursor}var newText=previous.slice(0,index)+text+previous.slice(index);replaceText(el,newText,transformCursor)}function onStringRemove(el,previous,index,howMany){function transformCursor(cursor){return index<cursor?cursor-Math.min(howMany,cursor-index):cursor}var newText=previous.slice(0,index)+previous.slice(index+howMany);replaceText(el,newText,transformCursor)}function replaceText(el,newText,transformCursor){var selectionStart=transformCursor(el.selectionStart);var selectionEnd=transformCursor(el.selectionEnd);var scrollTop=el.scrollTop;el.value=newText;if(el.scrollTop!==scrollTop){el.scrollTop=scrollTop}if(document.activeElement===el){el.selectionStart=selectionStart;el.selectionEnd=selectionEnd}}function onTextInput(model,segments,value){var previous=model._get(segments)||"";if(previous===value)return;var start=0;while(previous.charAt(start)===value.charAt(start)){start++}var end=0;while(previous.charAt(previous.length-1-end)===value.charAt(value.length-1-end)&&end+start<previous.length&&end+start<value.length){end++}if(previous.length!==start+end){var howMany=previous.length-start-end;model._stringRemove(segments,start,howMany)}if(value.length!==start+end){var inserted=value.slice(start,value.length-end);model._stringInsert(segments,start,inserted)}}},{}],29:[function(require,module,exports){var derbyTemplates=require("derby-templates");var expressions=derbyTemplates.expressions;var operatorFns=derbyTemplates.operatorFns;var esprima=require("esprima-derby");var Syntax=esprima.Syntax;module.exports=createPathExpression;function createPathExpression(source){var node=esprima.parse(source).expression;return reduce(node)}function reduce(node){var type=node.type;if(type===Syntax.MemberExpression){return reduceMemberExpression(node)}else if(type===Syntax.Identifier){return reduceIdentifier(node)}else if(type===Syntax.ThisExpression){return reduceThis(node)}else if(type===Syntax.CallExpression){return reduceCallExpression(node)}else if(type===Syntax.Literal){return reduceLiteral(node)}else if(type===Syntax.UnaryExpression){return reduceUnaryExpression(node)}else if(type===Syntax.BinaryExpression||type===Syntax.LogicalExpression){return reduceBinaryExpression(node)}else if(type===Syntax.ConditionalExpression){return reduceConditionalExpression(node)}else if(type===Syntax.ArrayExpression){return reduceArrayExpression(node)}else if(type===Syntax.ObjectExpression){return reduceObjectExpression(node)}else if(type===Syntax.SequenceExpression){return reduceSequenceExpression(node)}else if(type===Syntax.NewExpression){return reduceNewExpression(node)}unexpected(node)}function reduceMemberExpression(node,afterSegments){if(node.computed){if(node.property.type===Syntax.Literal){return reducePath(node,node.property.value,afterSegments)}var before=reduce(node.object);var inside=reduce(node.property);return new expressions.BracketsExpression(before,inside,afterSegments)}if(node.property.type===Syntax.Identifier){return reducePath(node,node.property.name)}unexpected(node)}function reducePath(node,segment,afterSegments){var segments=[segment];if(afterSegments)segments=segments.concat(afterSegments);var relative=false;while(node=node.object){if(node.type===Syntax.MemberExpression){if(node.computed){return reduceMemberExpression(node,segments)}else if(node.property.type===Syntax.Identifier){segments.unshift(node.property.name)}else{unexpected(node)}}else if(node.type===Syntax.Identifier){segments.unshift(node.name)}else if(node.type===Syntax.ThisExpression){relative=true}else if(node.type===Syntax.CallExpression){return reduceCallExpression(node,segments)}else if(node.type===Syntax.SequenceExpression){return reduceSequenceExpression(node,segments)}else if(node.type===Syntax.NewExpression){return reduceNewExpression(node,segments)}else{unexpected(node)}}return relative?new expressions.RelativePathExpression(segments):createSegmentsExpression(segments)}function reduceIdentifier(node){var segments=[node.name];return createSegmentsExpression(segments)}function reduceThis(node){var segments=[];return new expressions.RelativePathExpression(segments)}function createSegmentsExpression(segments){var firstSegment=segments[0];var firstChar=firstSegment.charAt&&firstSegment.charAt(0);if(firstChar==="#"){var alias=firstSegment;segments.shift();return new expressions.AliasPathExpression(alias,segments)}else if(firstChar==="@"){var attribute=firstSegment.slice(1);segments.shift();return new expressions.AttributePathExpression(attribute,segments)}else{return new expressions.PathExpression(segments)}}function reduceCallExpression(node,afterSegments){return reduceFnExpression(node,afterSegments,expressions.FnExpression)}function reduceNewExpression(node,afterSegments){return reduceFnExpression(node,afterSegments,expressions.NewExpression)}function reduceFnExpression(node,afterSegments,Constructor){var args=node.arguments.map(reduce);var callee=node.callee;if(callee.type===Syntax.Identifier){var segments=[callee.name];return new Constructor(segments,args,afterSegments)}else if(callee.type===Syntax.MemberExpression){var segments=reduceMemberExpression(callee).segments;
return new Constructor(segments,args,afterSegments)}else{unexpected(node)}}function reduceLiteral(node){return new expressions.LiteralExpression(node.value)}function reduceUnaryExpression(node){var operator=node.operator+"U";var expression=reduce(node.argument);if(expression instanceof expressions.LiteralExpression){var fn=operatorFns.get[operator];expression.value=fn(expression.value);return expression}return new expressions.OperatorExpression(operator,[expression])}function reduceBinaryExpression(node){var operator=node.operator;var left=reduce(node.left);var right=reduce(node.right);if(left instanceof expressions.LiteralExpression&&right instanceof expressions.LiteralExpression){var fn=operatorFns.get[operator];var value=fn(left.value,right.value);return new expressions.LiteralExpression(value)}return new expressions.OperatorExpression(operator,[left,right])}function reduceConditionalExpression(node){var test=reduce(node.test);var consequent=reduce(node.consequent);var alternate=reduce(node.alternate);if(test instanceof expressions.LiteralExpression&&consequent instanceof expressions.LiteralExpression&&alternate instanceof expressions.LiteralExpression){var value=test.value?consequent.value:alternate.value;return new expressions.LiteralExpression(value)}return new expressions.OperatorExpression("?",[test,consequent,alternate])}function reduceArrayExpression(node){var elements=node.elements;var literal=[];var args=[];var isLiteral=true;for(var i=0,len=elements.length;i<len;i++){var expression=reduce(elements[i]);args.push(expression);if(isLiteral&&expression instanceof expressions.LiteralExpression){literal.push(expression.value)}else{isLiteral=false}}return isLiteral?new expressions.LiteralExpression(literal):new expressions.OperatorExpression("[]",args)}function reduceObjectExpression(node){var properties=node.properties;var literal={};var args=[];var isLiteral=true;for(var i=0,len=properties.length;i<len;i++){var property=properties[i];var key=getKeyName(property.key);var keyExpression=new expressions.LiteralExpression(key);var expression=reduce(property.value);args.push(keyExpression,expression);if(isLiteral&&expression instanceof expressions.LiteralExpression){literal[key]=expression.value}else{isLiteral=false}}return isLiteral?new expressions.LiteralExpression(literal):new expressions.OperatorExpression("{}",args)}function getKeyName(key){return key.type===Syntax.Identifier?key.name:key.type===Syntax.Literal?key.value:unexpected(key)}function reduceSequenceExpression(node,afterSegments){var args=node.expressions.map(reduce);return new expressions.SequenceExpression(args,afterSegments)}function unexpected(node){throw new Error("Unexpected Esprima node: "+JSON.stringify(node,null,2))}},{"derby-templates":33,"esprima-derby":32}],30:[function(require,module,exports){var htmlUtil=require("html-util");var derbyTemplates=require("derby-templates");var templates=derbyTemplates.templates;var expressions=derbyTemplates.expressions;var createPathExpression=require("./createPathExpression");var markup=require("./markup");exports.createTemplate=createTemplate;exports.createStringTemplate=createStringTemplate;exports.createExpression=createExpression;exports.createPathExpression=createPathExpression;exports.markup=markup;templates.View.prototype._parse=function(){var template;try{if(this.string){template=createStringTemplate(this.source,this)}else{var source=this.unminified?this.source:htmlUtil.minify(this.source).replace(/&sp;/g," ");template=createTemplate(source,this)}}catch(err){var message='\n\nWithin template "'+this.name+'":\n'+this.source;throw appendErrorMessage(err,message)}this.template=template;return template};var parseNode;function createTemplate(source,view){parseNode=new ParseNode(view);htmlUtil.parse(source,{start:parseHtmlStart,end:parseHtmlEnd,text:parseHtmlText,comment:parseHtmlComment,other:parseHtmlOther});while(parseNode.parent){parseNode=parseNode.parent;var last=parseNode.last();if(last instanceof templates.Element){last.notClosed=true;last.endTag="";continue}unexpected()}return new templates.Template(parseNode.content)}function createStringTemplate(source,view){parseNode=new ParseNode(view);parseText(source,parseTextLiteral,parseTextExpression);return new templates.Template(parseNode.content)}function parseHtmlStart(tag,tagName,attributes,selfClosing){var hooks;if(tagName!=="view"&&!viewForTagName(tagName)){hooks=hooksFromAttributes(attributes,"Element")}var attributesMap=parseAttributes(attributes);var namespaceUri=tagName.toLowerCase()==="svg"?templates.NAMESPACE_URIS.svg:parseNode.namespaceUri;if(selfClosing||templates.VOID_ELEMENTS[tagName]){var element=new templates.Element(tagName,attributesMap,null,hooks,selfClosing,null,namespaceUri);parseNode.content.push(element);parseElementClose(tagName)}else{parseNode=parseNode.child();parseNode.namespaceUri=namespaceUri;var element=new templates.Element(tagName,attributesMap,parseNode.content,hooks,selfClosing,null,namespaceUri);parseNode.parent.content.push(element)}}function parseAttributes(attributes){var attributesMap;for(var key in attributes){if(!attributesMap)attributesMap={};var value=attributes[key];var match=/([^:]+):[^:]/.exec(key);var nsUri=match&&templates.NAMESPACE_URIS[match[1]];if(value===""||typeof value!=="string"){attributesMap[key]=new templates.Attribute(value,nsUri);continue}parseNode=parseNode.child();parseText(htmlUtil.unescapeEntities(value),parseTextLiteral,parseTextExpression);if(parseNode.content.length===1){var item=parseNode.content[0];attributesMap[key]=item instanceof templates.Text?new templates.Attribute(item.data,nsUri):item instanceof templates.DynamicText?item.expression instanceof expressions.LiteralExpression?new templates.Attribute(item.expression.value,nsUri):new templates.DynamicAttribute(item.expression,nsUri):new templates.DynamicAttribute(item,nsUri)}else if(parseNode.content.length>1){var template=new templates.Template(parseNode.content);attributesMap[key]=new templates.DynamicAttribute(template,nsUri)}else{throw new Error("Error parsing "+key+" attribute: "+value)}parseNode=parseNode.parent}return attributesMap}function parseHtmlEnd(tag,tagName){parseNode=parseNode.parent;var last=parseNode.last();if(!(last instanceof templates.Element&&last.tagName===tagName)){throw new Error("Mismatched closing HTML tag: "+tag)}parseElementClose(tagName)}function parseElementClose(tagName){if(tagName==="view"){var element=parseNode.content.pop();parseViewElement(element);return}var view=viewForTagName(tagName);if(view){var element=parseNode.content.pop();parseNamedViewElement(element,view,view.name);return}var element=parseNode.last();markup.emit("element",element);markup.emit("element:"+tagName,element)}function viewForTagName(tagName){return parseNode.view&&parseNode.view.views.elementMap[tagName]}function parseHtmlText(data,isRawText){var unescaped=isRawText?data:htmlUtil.unescapeEntities(data);parseText(unescaped,parseTextLiteral,parseTextExpression,"html")}function parseHtmlComment(tag,data){if(!htmlUtil.isConditionalComment(tag))return;var comment=new templates.Comment(data);parseNode.content.push(comment)}var doctypeRegExp=/^<!DOCTYPE\s+([^\s]+)(?:\s+(PUBLIC|SYSTEM)\s+"([^"]+)"(?:\s+"([^"]+)")?)?\s*>/i;function parseHtmlOther(tag){var match=doctypeRegExp.exec(tag);if(match){var name=match[1];var idType=match[2]&&match[2].toLowerCase();var publicId,systemId;if(idType==="public"){publicId=match[3];systemId=match[4]}else if(idType==="system"){systemId=match[3]}var doctype=new templates.Doctype(name,publicId,systemId);parseNode.content.push(doctype)}else{unexpected(tag)}}function parseTextLiteral(data){var text=new templates.Text(data);parseNode.content.push(text)}function parseTextExpression(expression,environment){if(expression.meta.blockType){parseBlockExpression(expression)}else if(expression.meta.valueType==="view"){parseViewExpression(expression)}else if(expression.meta.unescaped&&environment==="html"){var html=new templates.DynamicHtml(expression);parseNode.content.push(html)}else{var text=new templates.DynamicText(expression);parseNode.content.push(text)}}function parseBlockExpression(expression){var blockType=expression.meta.blockType;if(expression.meta.isEnd){parseNode=parseNode.parent;var last=parseNode.last();var lastExpression=last&&(last.expression||last.expressions&&last.expressions[0]);if(!(lastExpression&&(blockType==="end"&&lastExpression.meta.blockType)||blockType===lastExpression.meta.blockType)){throw new Error("Mismatched closing template tag: "+expression.meta.source)}}else if(blockType==="else"||blockType==="else if"){parseNode=parseNode.parent;var last=parseNode.last();parseNode=parseNode.child();if(last instanceof templates.ConditionalBlock){last.expressions.push(expression);last.contents.push(parseNode.content)}else if(last instanceof templates.EachBlock){if(blockType!=="else")unexpected(expression.meta.source);last.elseContent=parseNode.content}else{unexpected(expression.meta.source)}}else{var nextNode=parseNode.child();var block;if(blockType==="if"||blockType==="unless"){block=new templates.ConditionalBlock([expression],[nextNode.content])}else if(blockType==="each"){block=new templates.EachBlock(expression,nextNode.content)}else{block=new templates.Block(expression,nextNode.content)}parseNode.content.push(block);parseNode=nextNode}}function parseViewElement(element){var nameAttribute=element.attributes.name;if(!nameAttribute){throw new Error("The <view> element requires a name attribute")}delete element.attributes.name;if(nameAttribute.expression){var viewAttributes=viewAttributesFromElement(element);var hooks=hooksFromAttributes(viewAttributes,"Component");var remaining=element.content||[];var viewInstance=new templates.DynamicViewInstance(nameAttribute.expression,viewAttributes,hooks);finishParseViewElement(viewAttributes,remaining,viewInstance)}else{var name=nameAttribute.data;var view=findView(name);parseNamedViewElement(element,view,name)}}function findView(name){var view=parseNode.view.views.find(name,parseNode.view.namespace);if(!view){var message=parseNode.view.views.findErrorMessage(name);throw new Error(message)}return view}function parseNamedViewElement(element,view,name){var viewAttributes=viewAttributesFromElement(element);var hooks=hooksFromAttributes(viewAttributes,"Component");var remaining=parseContentAttributes(element.content,view,viewAttributes);var viewInstance=new templates.ViewInstance(view.registeredName,viewAttributes,hooks);finishParseViewElement(viewAttributes,remaining,viewInstance)}function finishParseViewElement(viewAttributes,remaining,viewInstance){if(!viewAttributes.hasOwnProperty("content")&&remaining.length){viewAttributes.content=new templates.ParentWrapper(new templates.Template(remaining))}parseNode.content.push(viewInstance)}function viewAttributesFromElement(element){var viewAttributes={};for(var key in element.attributes){var attribute=element.attributes[key];var camelCased=dashToCamelCase(key);viewAttributes[camelCased]=attribute.expression instanceof templates.Template?new templates.ParentWrapper(attribute.expression):attribute.expression instanceof expressions.Expression?new templates.ParentWrapper(new templates.DynamicText(attribute.expression),attribute.expression):attribute.data}return viewAttributes}function hooksFromAttributes(attributes,type){if(!attributes)return;var hooks=[];for(var key in attributes){var value=attributes[key];var camelName=dashToCamelCase(key);if(key==="as"){var segments=value.split(".");hooks.push(new templates.MarkupAs(segments));delete attributes.as}var match,eventName;if(type==="Component"){match=/^on([A-Z_].*)/.exec(key);eventName=match&&match[1].charAt(0).toLowerCase()+match[1].slice(1)}else{match=/^on-(.+)/.exec(key);eventName=match&&match[1]}if(eventName){var expression=createPathExpression(value);var Constructor=templates[type+"On"];hooks.push(new Constructor(eventName,expression));delete attributes[key]}}if(hooks.length)return hooks}function dashToCamelCase(string){return string.replace(/-./g,function(match){return match.charAt(1).toUpperCase()})}function parseContentAttributes(content,view,viewAttributes){var remaining=[];if(!content)return remaining;for(var i=0,len=content.length;i<len;i++){var item=content[i];var name=item instanceof templates.Element&&item.tagName;if(name==="attribute"){var name=parseNameAttribute(item);parseAttributeElement(item,name,viewAttributes)}else if(view.attributesMap&&view.attributesMap[name]){parseAttributeElement(item,name,viewAttributes)}else if(name==="array"){var name=parseNameAttribute(item);parseArrayElement(item,name,viewAttributes)}else if(view.arraysMap&&view.arraysMap[name]){parseArrayElement(item,view.arraysMap[name],viewAttributes)}else{remaining.push(item)}}return remaining}function parseNameAttribute(element){var nameAttribute=element.attributes.name;var name=nameAttribute.data;if(!name){throw new Error("The <"+element.tagName+"> element requires a literal name attribute")}delete element.attributes.name;return name}function parseAttributeElement(element,name,viewAttributes){var camelName=dashToCamelCase(name);viewAttributes[camelName]=new templates.ParentWrapper(new templates.Template(element.content))}function parseArrayElement(element,name,viewAttributes){var item=viewAttributesFromElement(element);if(!item.hasOwnProperty("content")&&element.content.length){item.content=new templates.ParentWrapper(new templates.Template(element.content))}var camelName=dashToCamelCase(name);var viewAttribute=viewAttributes[camelName]||(viewAttributes[camelName]=[]);viewAttribute.push(item)}function parseViewExpression(expression){var nameExpression,attributesExpression;if(expression instanceof expressions.SequenceExpression){nameExpression=expression.args[0];attributesExpression=expression.args[1]}else{nameExpression=expression}var viewAttributes=viewAttributesFromExpression(attributesExpression);var hooks=hooksFromAttributes(viewAttributes,"Component");var viewInstance;if(nameExpression instanceof expressions.LiteralExpression){var name=nameExpression.get();findView(name);viewInstance=new templates.ViewInstance(name,viewAttributes,hooks)}else{viewInstance=new templates.DynamicViewInstance(nameExpression,hooks,viewAttributes)}parseNode.content.push(viewInstance)}function viewAttributesFromExpression(expression){if(!expression)return;var object=objectFromObjectExpression(expression);var viewAttributes={};for(var key in object){var value=object[key];viewAttributes[key]=value instanceof expressions.LiteralExpression?value.value:value instanceof expressions.Expression?new templates.ParentWrapper(new templates.DynamicText(value),value):value}return viewAttributes}function objectFromObjectExpression(expression){if(expression instanceof expressions.LiteralExpression){var object=expression.value;if(typeof object!=="object")unexpected();return object}else if(expression instanceof expressions.OperatorExpression&&expression.name==="{}"){var object={};var args=expression.args;for(var i=0,len=args.length;i<len;i+=2){var key=args[i].value;var value=args[i+1];object[key]=value}return object}else{unexpected()}}function ParseNode(view,parent){this.view=view;this.parent=parent;this.content=[];this.namespaceUri=parent&&parent.namespaceUri}ParseNode.prototype.child=function(){return new ParseNode(this.view,this)};ParseNode.prototype.last=function(){return this.content[this.content.length-1]};function parseText(data,onLiteral,onExpression,environment){var current=data;var last;while(current){if(current===last)throw new Error("Error parsing template text: "+data);last=current;var start=current.indexOf("{{");if(start===-1){onLiteral(current);return}var end=matchBraces(current,2,start,"{","}");if(end===-1)throw new Error("Mismatched braces in: "+data);if(start>0){var before=current.slice(0,start);onLiteral(current.slice(0,start))}var inside=current.slice(start+2,end-2);if(inside){var expression=createExpression(inside);onExpression(expression,environment)}current=current.slice(end)}}function matchBraces(text,num,i,openChar,closeChar){i+=num;while(num){var close=text.indexOf(closeChar,i);var open=text.indexOf(openChar,i);var hasClose=close!==-1;var hasOpen=open!==-1;if(hasClose&&(!hasOpen||close<open)){i=close+1;num--;continue}else if(hasOpen){i=open+1;num++;continue}else{return-1}}return i}var blockRegExp=/^(if|unless|else if|each|with)\s+([\s\S]+?)(?:\s+as\s+([^,\s]+)\s*(?:,\s*(\S+))?)?$/;var valueRegExp=/^(?:(view|unbound|bound|unescaped)\s+)?([\s\S]*)/;function createExpression(source){source=source.trim();var meta=new expressions.ExpressionMeta(source);var match=blockRegExp.exec(source);var path;if(match){meta.blockType=match[1];path=match[2];meta.as=match[3];meta.keyAs=match[4]}else if(source==="else"||source==="unbound"||source==="bound"){meta.blockType=source}else if(source.charAt(0)==="/"){meta.isEnd=true;meta.blockType=source.slice(1).trim()||"end"}else{path=source;var keyword;do{match=valueRegExp.exec(path);keyword=match[1];path=match[2];if(keyword==="unescaped"){meta.unescaped=true}else if(keyword==="unbound"||keyword==="bound"){meta.bindType=keyword}else if(keyword){meta.valueType=keyword}}while(keyword)}var expression;try{expression=path?createPathExpression(path):new expressions.Expression}catch(err){var message="\n\nWithin expression: "+source;throw appendErrorMessage(err,message)}expression.meta=meta;return expression}function unexpected(source){throw new Error("Error parsing template: "+source)}function appendErrorMessage(err,message){if(err instanceof Error){err.message+=message;return err}return new Error(err+message)}},{"./createPathExpression":29,"./markup":31,"derby-templates":33,"html-util":40}],31:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var templates=require("derby-templates").templates;var createPathExpression=require("./createPathExpression");var markup=module.exports=new MarkupParser;function MarkupParser(){EventEmitter.call(this)}mergeInto(MarkupParser.prototype,EventEmitter.prototype);markup.on("element:a",function(template){if(hasListenerFor(template,"click")){var attributes=template.attributes||(template.attributes={});if(!attributes.href){attributes.href=new templates.Attribute("#");addListener(template,"click","$preventDefault($event)")}}});markup.on("element:form",function(template){if(hasListenerFor(template,"submit")){addListener(template,"submit","$preventDefault($event)")}});function hasListenerFor(template,eventName){var hooks=template.hooks;if(!hooks)return false;for(var i=0,len=hooks.length;i<len;i++){var hook=hooks[i];if(hook instanceof templates.ElementOn&&hook.name===eventName){return true}}return false}function addListener(template,eventName,source){var hooks=template.hooks||(template.hooks=[]);var expression=createPathExpression(source);hooks.push(new templates.ElementOn(eventName,expression))}function mergeInto(to,from){for(var key in from){to[key]=from[key]}return to}},{"./createPathExpression":29,"derby-templates":33,events:11}],32:[function(require,module,exports){(function(root,factory){"use strict";if(typeof define==="function"&&define.amd){define(["exports"],factory)}else if(typeof exports!=="undefined"){factory(exports)}else{factory(root.esprima={})}})(this,function(exports){"use strict";var Token,TokenName,FnExprTokens,Syntax,PropertyKind,Messages,Regex,SyntaxTreeDelegate,source,strict,index,lineNumber,lineStart,length,delegate,lookahead,state,extra;Token={UndefinedLiteral:-1,BooleanLiteral:1,EOF:2,Identifier:3,Keyword:4,NullLiteral:5,NumericLiteral:6,Punctuator:7,StringLiteral:8,RegularExpression:9};TokenName={};TokenName[Token.UndefinedLiteral]="Undefined";TokenName[Token.BooleanLiteral]="Boolean";TokenName[Token.EOF]="<end>";TokenName[Token.Identifier]="Identifier";TokenName[Token.Keyword]="Keyword";TokenName[Token.NullLiteral]="Null";TokenName[Token.NumericLiteral]="Numeric";TokenName[Token.Punctuator]="Punctuator";TokenName[Token.StringLiteral]="String";TokenName[Token.RegularExpression]="RegularExpression";FnExprTokens=["(","{","[","in","typeof","instanceof","new","return","case","delete","throw","void","=","+=","-=","*=","/=","%=","<<=",">>=",">>>=","&=","|=","^=",",","+","-","*","/","%","++","--","<<",">>",">>>","&","|","^","!","~","&&","||","?",":","===","==",">=","<=","<",">","!=","!=="];Syntax={AssignmentExpression:"AssignmentExpression",ArrayExpression:"ArrayExpression",BinaryExpression:"BinaryExpression",CallExpression:"CallExpression",ConditionalExpression:"ConditionalExpression",ExpressionStatement:"ExpressionStatement",FunctionExpression:"FunctionExpression",Identifier:"Identifier",Literal:"Literal",LogicalExpression:"LogicalExpression",MemberExpression:"MemberExpression",NewExpression:"NewExpression",ObjectExpression:"ObjectExpression",Property:"Property",SequenceExpression:"SequenceExpression",ThisExpression:"ThisExpression",UnaryExpression:"UnaryExpression",UpdateExpression:"UpdateExpression"};PropertyKind={Data:1,Get:2,Set:4};Messages={UnexpectedToken:"Unexpected token %0",UnexpectedNumber:"Unexpected number",UnexpectedString:"Unexpected string",UnexpectedIdentifier:"Unexpected identifier",UnexpectedReserved:"Unexpected reserved word",UnexpectedEOS:"Unexpected end of input",NewlineAfterThrow:"Illegal newline after throw",InvalidRegExp:"Invalid regular expression",UnterminatedRegExp:"Invalid regular expression: missing /",InvalidLHSInAssignment:"Invalid left-hand side in assignment",InvalidLHSInForIn:"Invalid left-hand side in for-in",MultipleDefaultsInSwitch:"More than one default clause in switch statement",NoCatchOrFinally:"Missing catch or finally after try",UnknownLabel:"Undefined label '%0'",Redeclaration:"%0 '%1' has already been declared",IllegalContinue:"Illegal continue statement",IllegalBreak:"Illegal break statement",IllegalReturn:"Illegal return statement",StrictModeWith:"Strict mode code may not include a with statement",StrictCatchVariable:"Catch variable may not be eval or arguments in strict mode",StrictVarName:"Variable name may not be eval or arguments in strict mode",StrictParamName:"Parameter name eval or arguments is not allowed in strict mode",StrictParamDupe:"Strict mode function may not have duplicate parameter names",StrictFunctionName:"Function name may not be eval or arguments in strict mode",StrictOctalLiteral:"Octal literals are not allowed in strict mode.",StrictDelete:"Delete of an unqualified identifier in strict mode.",StrictDuplicateProperty:"Duplicate data property in object literal not allowed in strict mode",AccessorDataProperty:"Object literal may not have data and accessor property with the same name",AccessorGetSet:"Object literal may not have multiple get/set accessors with the same name",StrictLHSAssignment:"Assignment to eval or arguments is not allowed in strict mode",StrictLHSPostfix:"Postfix increment/decrement may not have eval or arguments operand in strict mode",StrictLHSPrefix:"Prefix increment/decrement may not have eval or arguments operand in strict mode",StrictReservedWord:"Use of future reserved word in strict mode"};Regex={NonAsciiIdentifierStart:new RegExp("[ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԧԱ-Ֆՙա-ևא-תװ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࢠࢢ-ࢬऄ-हऽॐक़-ॡॱ-ॷॹ-ॿঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-ళవ-హఽౘౙౠౡಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഅ-ഌഎ-ഐഒ-ഺഽൎൠൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏼᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛮ-ᛰᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡷᢀ-ᢨᢪᢰ-ᣵᤀ-ᤜᥐ-ᥭᥰ-ᥴᦀ-ᦫᧁ-ᧇᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᳩ-ᳬᳮ-ᳱᳵᳶᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎⅠ-ↈⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⸯ々-〇〡-〩〱-〵〸-〼ぁ-ゖゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿌ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚗꚠ-ꛯꜗ-ꜟꜢ-ꞈꞋ-ꞎꞐ-ꞓꞠ-Ɦꟸ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꪀ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꯀ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ]"),NonAsciiIdentifierPart:new RegExp("[ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮ̀-ʹͶͷͺ-ͽΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁ҃-҇Ҋ-ԧԱ-Ֆՙա-և֑-ׇֽֿׁׂׅׄא-תװ-ײؐ-ؚؠ-٩ٮ-ۓە-ۜ۟-۪ۨ-ۼۿܐ-݊ݍ-ޱ߀-ߵߺࠀ-࠭ࡀ-࡛ࢠࢢ-ࢬࣤ-ࣾऀ-ॣ०-९ॱ-ॷॹ-ॿঁ-ঃঅ-ঌএঐও-নপ-রলশ-হ়-ৄেৈো-ৎৗড়ঢ়য়-ৣ০-ৱਁ-ਃਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹ਼ਾ-ੂੇੈੋ-੍ੑਖ਼-ੜਫ਼੦-ੵઁ-ઃઅ-ઍએ-ઑઓ-નપ-રલળવ-હ઼-ૅે-ૉો-્ૐૠ-ૣ૦-૯ଁ-ଃଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହ଼-ୄେୈୋ-୍ୖୗଡ଼ଢ଼ୟ-ୣ୦-୯ୱஂஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹா-ூெ-ைொ-்ௐௗ௦-௯ఁ-ఃఅ-ఌఎ-ఐఒ-నప-ళవ-హఽ-ౄె-ైొ-్ౕౖౘౙౠ-ౣ౦-౯ಂಃಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹ಼-ೄೆ-ೈೊ-್ೕೖೞೠ-ೣ೦-೯ೱೲംഃഅ-ഌഎ-ഐഒ-ഺഽ-ൄെ-ൈൊ-ൎൗൠ-ൣ൦-൯ൺ-ൿංඃඅ-ඖක-නඳ-රලව-ෆ්ා-ුූෘ-ෟෲෳก-ฺเ-๎๐-๙ກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ູົ-ຽເ-ໄໆ່-ໍ໐-໙ໜ-ໟༀ༘༙༠-༩༹༵༷༾-ཇཉ-ཬཱ-྄྆-ྗྙ-ྼ࿆က-၉ၐ-ႝႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚ፝-፟ᎀ-ᎏᎠ-Ᏼᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛮ-ᛰᜀ-ᜌᜎ-᜔ᜠ-᜴ᝀ-ᝓᝠ-ᝬᝮ-ᝰᝲᝳក-៓ៗៜ៝០-៩᠋-᠍᠐-᠙ᠠ-ᡷᢀ-ᢪᢰ-ᣵᤀ-ᤜᤠ-ᤫᤰ-᤻᥆-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉ᧐-᧙ᨀ-ᨛᨠ-ᩞ᩠-᩿᩼-᪉᪐-᪙ᪧᬀ-ᭋ᭐-᭙᭫-᭳ᮀ-᯳ᰀ-᰷᱀-᱉ᱍ-ᱽ᳐-᳔᳒-ᳶᴀ-ᷦ᷼-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼ‌‍‿⁀⁔ⁱⁿₐ-ₜ⃐-⃥⃜⃡-⃰ℂℇℊ-ℓℕℙ-ℝℤΩℨK-ℭℯ-ℹℼ-ℿⅅ-ⅉⅎⅠ-ↈⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯ⵿-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞⷠ-ⷿⸯ々-〇〡-〯〱-〵〸-〼ぁ-ゖ゙゚ゝ-ゟァ-ヺー-ヿㄅ-ㄭㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿌ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘫꙀ-꙯ꙴ-꙽ꙿ-ꚗꚟ-꛱ꜗ-ꜟꜢ-ꞈꞋ-ꞎꞐ-ꞓꞠ-Ɦꟸ-ꠧꡀ-ꡳꢀ-꣄꣐-꣙꣠-ꣷꣻ꤀-꤭ꤰ-꥓ꥠ-ꥼꦀ-꧀ꧏ-꧙ꨀ-ꨶꩀ-ꩍ꩐-꩙ꩠ-ꩶꩺꩻꪀ-ꫂꫛ-ꫝꫠ-ꫯꫲ-꫶ꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꯀ-ꯪ꯬꯭꯰-꯹가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻ︀-️︠-︦︳︴﹍-﹏ﹰ-ﹴﹶ-ﻼ０-９Ａ-Ｚ＿ａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ]")};function assert(condition,message){if(!condition){throw new Error("ASSERT: "+message)}}function isDecimalDigit(ch){return ch>=48&&ch<=57}function isHexDigit(ch){return"0123456789abcdefABCDEF".indexOf(ch)>=0}function isOctalDigit(ch){return"01234567".indexOf(ch)>=0}function isWhiteSpace(ch){return ch===32||ch===9||ch===11||ch===12||ch===160||ch>=5760&&[5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279].indexOf(ch)>=0}function isLineTerminator(ch){return ch===10||ch===13||ch===8232||ch===8233}function isIdentifierStart(ch){return ch===36||ch===95||ch===64||ch===35||ch>=65&&ch<=90||ch>=97&&ch<=122||ch===92||ch>=128&&Regex.NonAsciiIdentifierStart.test(String.fromCharCode(ch))}function isIdentifierPart(ch){return ch===36||ch===95||ch>=65&&ch<=90||ch>=97&&ch<=122||ch>=48&&ch<=57||ch===92||ch>=128&&Regex.NonAsciiIdentifierPart.test(String.fromCharCode(ch))}function isFutureReservedWord(id){return false}function isStrictModeReservedWord(id){return false}function isRestrictedWord(id){return false}function isKeyword(id){return id==="this"||id==="typeof"||id==="instanceof"||id==="in"||id==="new"}function addComment(type,value,start,end,loc){var comment,attacher;assert(typeof start==="number","Comment must have valid position");if(state.lastCommentStart>=start){return}state.lastCommentStart=start;comment={type:type,value:value};if(extra.range){comment.range=[start,end]}if(extra.loc){comment.loc=loc}extra.comments.push(comment);if(extra.attachComment){attacher={comment:comment,leading:null,trailing:null,range:[start,end]};extra.pendingComments.push(attacher)}}function skipSingleLineComment(){var start,loc,ch,comment;start=index-2;loc={start:{line:lineNumber,column:index-lineStart-2}};while(index<length){ch=source.charCodeAt(index);++index;if(isLineTerminator(ch)){if(extra.comments){comment=source.slice(start+2,index-1);loc.end={line:lineNumber,column:index-lineStart-1};addComment("Line",comment,start,index-1,loc)}if(ch===13&&source.charCodeAt(index)===10){++index}++lineNumber;lineStart=index;return}}if(extra.comments){comment=source.slice(start+2,index);loc.end={line:lineNumber,column:index-lineStart};addComment("Line",comment,start,index,loc)}}function skipMultiLineComment(){var start,loc,ch,comment;if(extra.comments){start=index-2;loc={start:{line:lineNumber,column:index-lineStart-2}}}while(index<length){ch=source.charCodeAt(index);if(isLineTerminator(ch)){if(ch===13&&source.charCodeAt(index+1)===10){++index}++lineNumber;++index;lineStart=index;if(index>=length){throwError({},Messages.UnexpectedToken,"ILLEGAL")}}else if(ch===42){if(source.charCodeAt(index+1)===47){++index;++index;if(extra.comments){comment=source.slice(start+2,index-2);loc.end={line:lineNumber,column:index-lineStart};addComment("Block",comment,start,index,loc)}return}++index}else{++index}}throwError({},Messages.UnexpectedToken,"ILLEGAL")}function skipComment(){var ch,start;start=index===0;while(index<length){ch=source.charCodeAt(index);if(isWhiteSpace(ch)){++index}else if(isLineTerminator(ch)){++index;if(ch===13&&source.charCodeAt(index)===10){++index}++lineNumber;lineStart=index;start=true}else if(ch===47){ch=source.charCodeAt(index+1);if(ch===47){++index;++index;skipSingleLineComment();start=true}else if(ch===42){++index;++index;skipMultiLineComment()}else{break}}else if(start&&ch===45){if(source.charCodeAt(index+1)===45&&source.charCodeAt(index+2)===62){index+=3;skipSingleLineComment()}else{break}}else if(ch===60){if(source.slice(index+1,index+4)==="!--"){++index;++index;++index;++index;skipSingleLineComment()}else{break}}else{break}}}function scanHexEscape(prefix){var i,len,ch,code=0;len=prefix==="u"?4:2;for(i=0;i<len;++i){if(index<length&&isHexDigit(source[index])){ch=source[index++];code=code*16+"0123456789abcdef".indexOf(ch.toLowerCase())}else{return""}}return String.fromCharCode(code)}function getEscapedIdentifier(){var ch,id;ch=source.charCodeAt(index++);id=String.fromCharCode(ch);if(ch===92){if(source.charCodeAt(index)!==117){throwError({},Messages.UnexpectedToken,"ILLEGAL")}++index;ch=scanHexEscape("u");if(!ch||ch==="\\"||!isIdentifierStart(ch.charCodeAt(0))){throwError({},Messages.UnexpectedToken,"ILLEGAL")}id=ch}while(index<length){ch=source.charCodeAt(index);if(!isIdentifierPart(ch)){break}++index;id+=String.fromCharCode(ch);if(ch===92){id=id.substr(0,id.length-1);if(source.charCodeAt(index)!==117){throwError({},Messages.UnexpectedToken,"ILLEGAL")}++index;ch=scanHexEscape("u");if(!ch||ch==="\\"||!isIdentifierPart(ch.charCodeAt(0))){throwError({},Messages.UnexpectedToken,"ILLEGAL")}id+=ch}}return id}function getIdentifier(){var start,ch;start=index++;while(index<length){ch=source.charCodeAt(index);if(ch===92){index=start;return getEscapedIdentifier()}if(isIdentifierPart(ch)){++index}else{break}}return source.slice(start,index)}function scanIdentifier(){var start,id,type;start=index;id=source.charCodeAt(index)===92?getEscapedIdentifier():getIdentifier();if(id.length===1){type=Token.Identifier}else if(isKeyword(id)){type=Token.Keyword}else if(id==="undefined"){type=Token.Undefined}else if(id==="null"){type=Token.NullLiteral}else if(id==="true"||id==="false"){type=Token.BooleanLiteral}else{type=Token.Identifier}return{type:type,value:id,lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}function scanPunctuator(){var start=index,code=source.charCodeAt(index),code2,ch1=source[index],ch2,ch3,ch4;switch(code){case 46:case 40:case 41:case 59:case 44:case 123:case 125:case 91:case 93:case 58:case 63:case 126:++index;if(extra.tokenize){if(code===40){extra.openParenToken=extra.tokens.length}else if(code===123){extra.openCurlyToken=extra.tokens.length}}return{type:Token.Punctuator,value:String.fromCharCode(code),lineNumber:lineNumber,lineStart:lineStart,range:[start,index]};default:code2=source.charCodeAt(index+1);if(code2===61){switch(code){case 37:case 38:case 42:case 43:case 45:case 47:case 60:case 62:case 94:case 124:index+=2;return{type:Token.Punctuator,value:String.fromCharCode(code)+String.fromCharCode(code2),lineNumber:lineNumber,lineStart:lineStart,range:[start,index]};case 33:case 61:index+=2;if(source.charCodeAt(index)===61){++index}return{type:Token.Punctuator,value:source.slice(start,index),lineNumber:lineNumber,lineStart:lineStart,range:[start,index]};default:break}}break}ch2=source[index+1];ch3=source[index+2];ch4=source[index+3];if(ch1===">"&&ch2===">"&&ch3===">"){if(ch4==="="){index+=4;return{type:Token.Punctuator,value:">>>=",lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}}if(ch1===">"&&ch2===">"&&ch3===">"){index+=3;return{type:Token.Punctuator,value:">>>",lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}if(ch1==="<"&&ch2==="<"&&ch3==="="){index+=3;return{type:Token.Punctuator,value:"<<=",lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}if(ch1===">"&&ch2===">"&&ch3==="="){index+=3;
return{type:Token.Punctuator,value:">>=",lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}if(ch1===ch2&&"+-<>&|".indexOf(ch1)>=0){index+=2;return{type:Token.Punctuator,value:ch1+ch2,lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}if("<>=!+-*%&|^/".indexOf(ch1)>=0){++index;return{type:Token.Punctuator,value:ch1,lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}throwError({},Messages.UnexpectedToken,"ILLEGAL")}function scanHexLiteral(start){var number="";while(index<length){if(!isHexDigit(source[index])){break}number+=source[index++]}if(number.length===0){throwError({},Messages.UnexpectedToken,"ILLEGAL")}if(isIdentifierStart(source.charCodeAt(index))){throwError({},Messages.UnexpectedToken,"ILLEGAL")}return{type:Token.NumericLiteral,value:parseInt("0x"+number,16),lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}function scanOctalLiteral(start){var number="0"+source[index++];while(index<length){if(!isOctalDigit(source[index])){break}number+=source[index++]}if(isIdentifierStart(source.charCodeAt(index))||isDecimalDigit(source.charCodeAt(index))){throwError({},Messages.UnexpectedToken,"ILLEGAL")}return{type:Token.NumericLiteral,value:parseInt(number,8),octal:true,lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}function scanNumericLiteral(){var number,start,ch;ch=source[index];assert(isDecimalDigit(ch.charCodeAt(0))||ch===".","Numeric literal must start with a decimal digit or a decimal point");start=index;number="";if(ch!=="."){number=source[index++];ch=source[index];if(number==="0"){if(ch==="x"||ch==="X"){++index;return scanHexLiteral(start)}if(isOctalDigit(ch)){return scanOctalLiteral(start)}if(ch&&isDecimalDigit(ch.charCodeAt(0))){throwError({},Messages.UnexpectedToken,"ILLEGAL")}}while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++]}ch=source[index]}if(ch==="."){number+=source[index++];while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++]}ch=source[index]}if(ch==="e"||ch==="E"){number+=source[index++];ch=source[index];if(ch==="+"||ch==="-"){number+=source[index++]}if(isDecimalDigit(source.charCodeAt(index))){while(isDecimalDigit(source.charCodeAt(index))){number+=source[index++]}}else{throwError({},Messages.UnexpectedToken,"ILLEGAL")}}if(isIdentifierStart(source.charCodeAt(index))){throwError({},Messages.UnexpectedToken,"ILLEGAL")}return{type:Token.NumericLiteral,value:parseFloat(number),lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}function scanStringLiteral(){var str="",quote,start,ch,code,unescaped,restore,octal=false;quote=source[index];assert(quote==="'"||quote==='"',"String literal must starts with a quote");start=index;++index;while(index<length){ch=source[index++];if(ch===quote){quote="";break}else if(ch==="\\"){ch=source[index++];if(!ch||!isLineTerminator(ch.charCodeAt(0))){switch(ch){case"n":str+="\n";break;case"r":str+="\r";break;case"t":str+="	";break;case"u":case"x":restore=index;unescaped=scanHexEscape(ch);if(unescaped){str+=unescaped}else{index=restore;str+=ch}break;case"b":str+="\b";break;case"f":str+="\f";break;case"v":str+="";break;default:if(isOctalDigit(ch)){code="01234567".indexOf(ch);if(code!==0){octal=true}if(index<length&&isOctalDigit(source[index])){octal=true;code=code*8+"01234567".indexOf(source[index++]);if("0123".indexOf(ch)>=0&&index<length&&isOctalDigit(source[index])){code=code*8+"01234567".indexOf(source[index++])}}str+=String.fromCharCode(code)}else{str+=ch}break}}else{++lineNumber;if(ch==="\r"&&source[index]==="\n"){++index}}}else if(isLineTerminator(ch.charCodeAt(0))){break}else{str+=ch}}if(quote!==""){throwError({},Messages.UnexpectedToken,"ILLEGAL")}return{type:Token.StringLiteral,value:str,octal:octal,lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}function scanRegExp(){var str,ch,start,pattern,flags,value,classMarker=false,restore,terminated=false;lookahead=null;skipComment();start=index;ch=source[index];assert(ch==="/","Regular expression literal must start with a slash");str=source[index++];while(index<length){ch=source[index++];str+=ch;if(ch==="\\"){ch=source[index++];if(isLineTerminator(ch.charCodeAt(0))){throwError({},Messages.UnterminatedRegExp)}str+=ch}else if(isLineTerminator(ch.charCodeAt(0))){throwError({},Messages.UnterminatedRegExp)}else if(classMarker){if(ch==="]"){classMarker=false}}else{if(ch==="/"){terminated=true;break}else if(ch==="["){classMarker=true}}}if(!terminated){throwError({},Messages.UnterminatedRegExp)}pattern=str.substr(1,str.length-2);flags="";while(index<length){ch=source[index];if(!isIdentifierPart(ch.charCodeAt(0))){break}++index;if(ch==="\\"&&index<length){ch=source[index];if(ch==="u"){++index;restore=index;ch=scanHexEscape("u");if(ch){flags+=ch;for(str+="\\u";restore<index;++restore){str+=source[restore]}}else{index=restore;flags+="u";str+="\\u"}}else{str+="\\"}}else{flags+=ch;str+=ch}}try{value=new RegExp(pattern,flags)}catch(e){throwError({},Messages.InvalidRegExp)}if(extra.tokenize){return{type:Token.RegularExpression,value:value,lineNumber:lineNumber,lineStart:lineStart,range:[start,index]}}return{literal:str,value:value,range:[start,index]}}function collectRegex(){var pos,loc,regex,token;skipComment();pos=index;loc={start:{line:lineNumber,column:index-lineStart}};regex=scanRegExp();loc.end={line:lineNumber,column:index-lineStart};if(!extra.tokenize){if(extra.tokens.length>0){token=extra.tokens[extra.tokens.length-1];if(token.range[0]===pos&&token.type==="Punctuator"){if(token.value==="/"||token.value==="/="){extra.tokens.pop()}}}extra.tokens.push({type:"RegularExpression",value:regex.literal,range:[pos,index],loc:loc})}return regex}function isIdentifierName(token){return token.type===Token.Identifier||token.type===Token.Keyword||token.type===Token.BooleanLiteral||token.type===Token.Undefined||token.type===Token.NullLiteral}function advanceSlash(){var prevToken,checkToken;prevToken=extra.tokens[extra.tokens.length-1];if(!prevToken){return collectRegex()}if(prevToken.type==="Punctuator"){if(prevToken.value===")"){checkToken=extra.tokens[extra.openParenToken-1];if(checkToken&&checkToken.type==="Keyword"&&(checkToken.value==="if"||checkToken.value==="while"||checkToken.value==="for"||checkToken.value==="with")){return collectRegex()}return scanPunctuator()}if(prevToken.value==="}"){if(extra.tokens[extra.openCurlyToken-3]&&extra.tokens[extra.openCurlyToken-3].type==="Keyword"){checkToken=extra.tokens[extra.openCurlyToken-4];if(!checkToken){return scanPunctuator()}}else if(extra.tokens[extra.openCurlyToken-4]&&extra.tokens[extra.openCurlyToken-4].type==="Keyword"){checkToken=extra.tokens[extra.openCurlyToken-5];if(!checkToken){return collectRegex()}}else{return scanPunctuator()}if(FnExprTokens.indexOf(checkToken.value)>=0){return scanPunctuator()}return collectRegex()}return collectRegex()}if(prevToken.type==="Keyword"){return collectRegex()}return scanPunctuator()}function advance(){var ch;skipComment();if(index>=length){return{type:Token.EOF,lineNumber:lineNumber,lineStart:lineStart,range:[index,index]}}ch=source.charCodeAt(index);if(ch===40||ch===41||ch===58){return scanPunctuator()}if(ch===39||ch===34){return scanStringLiteral()}if(isIdentifierStart(ch)){return scanIdentifier()}if(ch===46){if(isDecimalDigit(source.charCodeAt(index+1))){return scanNumericLiteral()}return scanPunctuator()}if(isDecimalDigit(ch)){return scanNumericLiteral()}if(extra.tokenize&&ch===47){return advanceSlash()}return scanPunctuator()}function collectToken(){var start,loc,token,range,value;skipComment();start=index;loc={start:{line:lineNumber,column:index-lineStart}};token=advance();loc.end={line:lineNumber,column:index-lineStart};if(token.type!==Token.EOF){range=[token.range[0],token.range[1]];value=source.slice(token.range[0],token.range[1]);extra.tokens.push({type:TokenName[token.type],value:value,range:range,loc:loc})}return token}function lex(){var token;token=lookahead;index=token.range[1];lineNumber=token.lineNumber;lineStart=token.lineStart;lookahead=typeof extra.tokens!=="undefined"?collectToken():advance();index=token.range[1];lineNumber=token.lineNumber;lineStart=token.lineStart;return token}function peek(){var pos,line,start;pos=index;line=lineNumber;start=lineStart;lookahead=typeof extra.tokens!=="undefined"?collectToken():advance();index=pos;lineNumber=line;lineStart=start}SyntaxTreeDelegate={name:"SyntaxTree",markStart:function(){if(extra.loc){state.markerStack.push(index-lineStart);state.markerStack.push(lineNumber)}if(extra.range){state.markerStack.push(index)}},processComment:function(node){var i,attacher,pos,len,candidate;if(typeof node.type==="undefined"||node.type===Syntax.Program){return}peek();for(i=0;i<extra.pendingComments.length;++i){attacher=extra.pendingComments[i];if(node.range[0]>=attacher.comment.range[1]){candidate=attacher.leading;if(candidate){pos=candidate.range[0];len=candidate.range[1]-pos;if(node.range[0]<=pos&&node.range[1]-node.range[0]>=len){attacher.leading=node}}else{attacher.leading=node}}if(node.range[1]<=attacher.comment.range[0]){candidate=attacher.trailing;if(candidate){pos=candidate.range[0];len=candidate.range[1]-pos;if(node.range[0]<=pos&&node.range[1]-node.range[0]>=len){attacher.trailing=node}}else{attacher.trailing=node}}}},markEnd:function(node){if(extra.range){node.range=[state.markerStack.pop(),index]}if(extra.loc){node.loc={start:{line:state.markerStack.pop(),column:state.markerStack.pop()},end:{line:lineNumber,column:index-lineStart}};this.postProcess(node)}if(extra.attachComment){this.processComment(node)}return node},markEndIf:function(node){if(node.range||node.loc){if(extra.loc){state.markerStack.pop();state.markerStack.pop()}if(extra.range){state.markerStack.pop()}}else{this.markEnd(node)}return node},postProcess:function(node){if(extra.source){node.loc.source=extra.source}return node},createArrayExpression:function(elements){return{type:Syntax.ArrayExpression,elements:elements}},createAssignmentExpression:function(operator,left,right){return{type:Syntax.AssignmentExpression,operator:operator,left:left,right:right}},createBinaryExpression:function(operator,left,right){var type=operator==="||"||operator==="&&"?Syntax.LogicalExpression:Syntax.BinaryExpression;return{type:type,operator:operator,left:left,right:right}},createCallExpression:function(callee,args){return{type:Syntax.CallExpression,callee:callee,arguments:args}},createConditionalExpression:function(test,consequent,alternate){return{type:Syntax.ConditionalExpression,test:test,consequent:consequent,alternate:alternate}},createExpressionStatement:function(expression){return{type:Syntax.ExpressionStatement,expression:expression}},createFunctionExpression:function(id,params,defaults,body){return{type:Syntax.FunctionExpression,id:id,params:params,defaults:defaults,body:body,rest:null,generator:false,expression:false}},createIdentifier:function(name){return{type:Syntax.Identifier,name:name}},createLiteral:function(token){return{type:Syntax.Literal,value:token.value,raw:source.slice(token.range[0],token.range[1])}},createMemberExpression:function(accessor,object,property){return{type:Syntax.MemberExpression,computed:accessor==="[",object:object,property:property}},createNewExpression:function(callee,args){return{type:Syntax.NewExpression,callee:callee,arguments:args}},createObjectExpression:function(properties){return{type:Syntax.ObjectExpression,properties:properties}},createPostfixExpression:function(operator,argument){return{type:Syntax.UpdateExpression,operator:operator,argument:argument,prefix:false}},createProperty:function(kind,key,value){return{type:Syntax.Property,key:key,value:value,kind:kind}},createSequenceExpression:function(expressions){return{type:Syntax.SequenceExpression,expressions:expressions}},createThisExpression:function(){return{type:Syntax.ThisExpression}},createUnaryExpression:function(operator,argument){if(operator==="++"||operator==="--"){return{type:Syntax.UpdateExpression,operator:operator,argument:argument,prefix:true}}return{type:Syntax.UnaryExpression,operator:operator,argument:argument,prefix:true}}};function peekLineTerminator(){var pos,line,start,found;pos=index;line=lineNumber;start=lineStart;skipComment();found=lineNumber!==line;index=pos;lineNumber=line;lineStart=start;return found}function throwError(token,messageFormat){var error,args=Array.prototype.slice.call(arguments,2),msg=messageFormat.replace(/%(\d)/g,function(whole,index){assert(index<args.length,"Message reference must be in range");return args[index]});if(typeof token.lineNumber==="number"){error=new Error("Line "+token.lineNumber+": "+msg);error.index=token.range[0];error.lineNumber=token.lineNumber;error.column=token.range[0]-lineStart+1}else{error=new Error("Line "+lineNumber+": "+msg);error.index=index;error.lineNumber=lineNumber;error.column=index-lineStart+1}error.description=msg;throw error}function throwErrorTolerant(){try{throwError.apply(null,arguments)}catch(e){if(extra.errors){extra.errors.push(e)}else{throw e}}}function throwUnexpected(token){if(token.type===Token.EOF){throwError(token,Messages.UnexpectedEOS)}if(token.type===Token.NumericLiteral){throwError(token,Messages.UnexpectedNumber)}if(token.type===Token.StringLiteral){throwError(token,Messages.UnexpectedString)}if(token.type===Token.Identifier){throwError(token,Messages.UnexpectedIdentifier)}if(token.type===Token.Keyword){if(isFutureReservedWord(token.value)){throwError(token,Messages.UnexpectedReserved)}else if(strict&&isStrictModeReservedWord(token.value)){throwErrorTolerant(token,Messages.StrictReservedWord);return}throwError(token,Messages.UnexpectedToken,token.value)}throwError(token,Messages.UnexpectedToken,token.value)}function expect(value){var token=lex();if(token.type!==Token.Punctuator||token.value!==value){throwUnexpected(token)}}function expectKeyword(keyword){var token=lex();if(token.type!==Token.Keyword||token.value!==keyword){throwUnexpected(token)}}function match(value){return lookahead.type===Token.Punctuator&&lookahead.value===value}function matchKeyword(keyword){return lookahead.type===Token.Keyword&&lookahead.value===keyword}function matchAssign(){var op;if(lookahead.type!==Token.Punctuator){return false}op=lookahead.value;return op==="="||op==="*="||op==="/="||op==="%="||op==="+="||op==="-="||op==="<<="||op===">>="||op===">>>="||op==="&="||op==="^="||op==="|="}function consumeSemicolon(){var line;if(source.charCodeAt(index)===59){lex();return}line=lineNumber;skipComment();if(lineNumber!==line){return}if(match(";")){lex();return}if(lookahead.type!==Token.EOF&&!match("}")){throwUnexpected(lookahead)}}function isLeftHandSide(expr){return expr.type===Syntax.Identifier||expr.type===Syntax.MemberExpression}function parseArrayInitialiser(){var elements=[];expect("[");while(!match("]")){if(match(",")){lex();elements.push(null)}else{elements.push(parseAssignmentExpression());if(!match("]")){expect(",")}}}expect("]");return delegate.createArrayExpression(elements)}function parsePropertyFunction(param,first){var previousStrict,body;previousStrict=strict;skipComment();delegate.markStart();body=parseFunctionSourceElements();if(first&&strict&&isRestrictedWord(param[0].name)){throwErrorTolerant(first,Messages.StrictParamName)}strict=previousStrict;return delegate.markEnd(delegate.createFunctionExpression(null,param,[],body))}function parseObjectPropertyKey(){var token;skipComment();delegate.markStart();token=lex();if(token.type===Token.StringLiteral||token.type===Token.NumericLiteral){if(strict&&token.octal){throwErrorTolerant(token,Messages.StrictOctalLiteral)}return delegate.markEnd(delegate.createLiteral(token))}return delegate.markEnd(delegate.createIdentifier(token.value))}function parseObjectProperty(){var token,key,id,value,param;token=lookahead;skipComment();delegate.markStart();if(token.type===Token.Identifier){id=parseObjectPropertyKey();if(token.value==="get"&&!match(":")){key=parseObjectPropertyKey();expect("(");expect(")");value=parsePropertyFunction([]);return delegate.markEnd(delegate.createProperty("get",key,value))}if(token.value==="set"&&!match(":")){key=parseObjectPropertyKey();expect("(");token=lookahead;if(token.type!==Token.Identifier){expect(")");throwErrorTolerant(token,Messages.UnexpectedToken,token.value);value=parsePropertyFunction([])}else{param=[parseVariableIdentifier()];expect(")");value=parsePropertyFunction(param,token)}return delegate.markEnd(delegate.createProperty("set",key,value))}expect(":");value=parseAssignmentExpression();return delegate.markEnd(delegate.createProperty("init",id,value))}if(token.type===Token.EOF||token.type===Token.Punctuator){throwUnexpected(token)}else{key=parseObjectPropertyKey();expect(":");value=parseAssignmentExpression();return delegate.markEnd(delegate.createProperty("init",key,value))}}function parseObjectInitialiser(){var properties=[],property,name,key,kind,map={},toString=String;expect("{");while(!match("}")){property=parseObjectProperty();if(property.key.type===Syntax.Identifier){name=property.key.name}else{name=toString(property.key.value)}kind=property.kind==="init"?PropertyKind.Data:property.kind==="get"?PropertyKind.Get:PropertyKind.Set;key="$"+name;if(Object.prototype.hasOwnProperty.call(map,key)){if(map[key]===PropertyKind.Data){if(strict&&kind===PropertyKind.Data){throwErrorTolerant({},Messages.StrictDuplicateProperty)}else if(kind!==PropertyKind.Data){throwErrorTolerant({},Messages.AccessorDataProperty)}}else{if(kind===PropertyKind.Data){throwErrorTolerant({},Messages.AccessorDataProperty)}else if(map[key]&kind){throwErrorTolerant({},Messages.AccessorGetSet)}}map[key]|=kind}else{map[key]=kind}properties.push(property);if(!match("}")){expect(",")}}expect("}");return delegate.createObjectExpression(properties)}function parseGroupExpression(){var expr;expect("(");expr=parseExpression();expect(")");return expr}function parsePrimaryExpression(){var type,token,expr;if(match("(")){return parseGroupExpression()}type=lookahead.type;delegate.markStart();if(type===Token.Identifier){expr=delegate.createIdentifier(lex().value)}else if(type===Token.StringLiteral||type===Token.NumericLiteral){if(strict&&lookahead.octal){throwErrorTolerant(lookahead,Messages.StrictOctalLiteral)}expr=delegate.createLiteral(lex())}else if(type===Token.Keyword){if(matchKeyword("this")){lex();expr=delegate.createThisExpression()}else if(matchKeyword("function")){expr=parseFunctionExpression()}}else if(type===Token.BooleanLiteral){token=lex();token.value=token.value==="true";expr=delegate.createLiteral(token)}else if(type===Token.Undefined){token=lex();token.value=void 0;expr=delegate.createLiteral(token)}else if(type===Token.NullLiteral){token=lex();token.value=null;expr=delegate.createLiteral(token)}else if(match("[")){expr=parseArrayInitialiser()}else if(match("{")){expr=parseObjectInitialiser()}else if(match("/")||match("/=")){if(typeof extra.tokens!=="undefined"){expr=delegate.createLiteral(collectRegex())}else{expr=delegate.createLiteral(scanRegExp())}peek()}if(expr){return delegate.markEnd(expr)}throwUnexpected(lex())}function parseArguments(){var args=[];expect("(");if(!match(")")){while(index<length){args.push(parseAssignmentExpression());if(match(")")){break}expect(",")}}expect(")");return args}function parseNonComputedProperty(){var token;delegate.markStart();token=lex();if(!isIdentifierName(token)){throwUnexpected(token)}return delegate.markEnd(delegate.createIdentifier(token.value))}function parseNonComputedMember(){expect(".");return parseNonComputedProperty()}function parseComputedMember(){var expr;expect("[");expr=parseExpression();expect("]");return expr}function parseNewExpression(){var callee,args;delegate.markStart();expectKeyword("new");callee=parseLeftHandSideExpression();args=match("(")?parseArguments():[];return delegate.markEnd(delegate.createNewExpression(callee,args))}function parseLeftHandSideExpressionAllowCall(){var marker,previousAllowIn,expr,args,property;marker=createLocationMarker();previousAllowIn=state.allowIn;state.allowIn=true;expr=matchKeyword("new")?parseNewExpression():parsePrimaryExpression();state.allowIn=previousAllowIn;while(match(".")||match("[")||match("(")){if(match("(")){args=parseArguments();expr=delegate.createCallExpression(expr,args)}else if(match("[")){property=parseComputedMember();expr=delegate.createMemberExpression("[",expr,property)}else{property=parseNonComputedMember();expr=delegate.createMemberExpression(".",expr,property)}if(marker){marker.end();marker.apply(expr)}}return expr}function parseLeftHandSideExpression(){var marker,previousAllowIn,expr,property;marker=createLocationMarker();previousAllowIn=state.allowIn;expr=matchKeyword("new")?parseNewExpression():parsePrimaryExpression();state.allowIn=previousAllowIn;while(match(".")||match("[")){if(match("[")){property=parseComputedMember();expr=delegate.createMemberExpression("[",expr,property)}else{property=parseNonComputedMember();expr=delegate.createMemberExpression(".",expr,property)}if(marker){marker.end();marker.apply(expr)}}return expr}function parsePostfixExpression(){var expr,token;delegate.markStart();expr=parseLeftHandSideExpressionAllowCall();if(lookahead.type===Token.Punctuator){if((match("++")||match("--"))&&!peekLineTerminator()){if(strict&&expr.type===Syntax.Identifier&&isRestrictedWord(expr.name)){throwErrorTolerant({},Messages.StrictLHSPostfix)}if(!isLeftHandSide(expr)){throwErrorTolerant({},Messages.InvalidLHSInAssignment)}token=lex();expr=delegate.createPostfixExpression(token.value,expr)}}return delegate.markEndIf(expr)}function parseUnaryExpression(){var token,expr;delegate.markStart();if(lookahead.type!==Token.Punctuator&&lookahead.type!==Token.Keyword){expr=parsePostfixExpression()}else if(match("++")||match("--")){token=lex();expr=parseUnaryExpression();if(strict&&expr.type===Syntax.Identifier&&isRestrictedWord(expr.name)){throwErrorTolerant({},Messages.StrictLHSPrefix)}if(!isLeftHandSide(expr)){throwErrorTolerant({},Messages.InvalidLHSInAssignment)}expr=delegate.createUnaryExpression(token.value,expr)}else if(match("+")||match("-")||match("~")||match("!")){token=lex();expr=parseUnaryExpression();expr=delegate.createUnaryExpression(token.value,expr)}else if(matchKeyword("delete")||matchKeyword("void")||matchKeyword("typeof")){token=lex();expr=parseUnaryExpression();expr=delegate.createUnaryExpression(token.value,expr);if(strict&&expr.operator==="delete"&&expr.argument.type===Syntax.Identifier){throwErrorTolerant({},Messages.StrictDelete)}}else{expr=parsePostfixExpression()}return delegate.markEndIf(expr)}function binaryPrecedence(token,allowIn){var prec=0;if(token.type!==Token.Punctuator&&token.type!==Token.Keyword){return 0}switch(token.value){case"||":prec=1;break;case"&&":prec=2;break;case"|":prec=3;break;case"^":prec=4;break;case"&":prec=5;break;case"==":case"!=":case"===":case"!==":prec=6;break;case"<":case">":case"<=":case">=":case"instanceof":prec=7;break;case"in":prec=allowIn?7:0;break;case"<<":case">>":case">>>":prec=8;break;case"+":case"-":prec=9;break;case"*":case"/":case"%":prec=11;break;default:break}return prec}function parseBinaryExpression(){var marker,markers,expr,token,prec,stack,right,operator,left,i;marker=createLocationMarker();left=parseUnaryExpression();token=lookahead;prec=binaryPrecedence(token,state.allowIn);if(prec===0){return left}token.prec=prec;lex();markers=[marker,createLocationMarker()];right=parseUnaryExpression();stack=[left,token,right];while((prec=binaryPrecedence(lookahead,state.allowIn))>0){while(stack.length>2&&prec<=stack[stack.length-2].prec){right=stack.pop();operator=stack.pop().value;left=stack.pop();expr=delegate.createBinaryExpression(operator,left,right);markers.pop();marker=markers.pop();if(marker){marker.end();marker.apply(expr)}stack.push(expr);markers.push(marker)}token=lex();token.prec=prec;stack.push(token);markers.push(createLocationMarker());expr=parseUnaryExpression();stack.push(expr)}i=stack.length-1;expr=stack[i];markers.pop();while(i>1){expr=delegate.createBinaryExpression(stack[i-1].value,stack[i-2],expr);i-=2;marker=markers.pop();if(marker){marker.end();marker.apply(expr)}}return expr}function parseConditionalExpression(){var expr,previousAllowIn,consequent,alternate;delegate.markStart();expr=parseBinaryExpression();if(match("?")){lex();previousAllowIn=state.allowIn;state.allowIn=true;consequent=parseAssignmentExpression();state.allowIn=previousAllowIn;expect(":");alternate=parseAssignmentExpression();expr=delegate.markEnd(delegate.createConditionalExpression(expr,consequent,alternate))}else{delegate.markEnd({})}return expr}function parseAssignmentExpression(){var token,left,right,node;token=lookahead;delegate.markStart();node=left=parseConditionalExpression();if(matchAssign()){if(!isLeftHandSide(left)){throwErrorTolerant({},Messages.InvalidLHSInAssignment)}if(strict&&left.type===Syntax.Identifier&&isRestrictedWord(left.name)){throwErrorTolerant(token,Messages.StrictLHSAssignment)}token=lex();right=parseAssignmentExpression();node=delegate.createAssignmentExpression(token.value,left,right)}return delegate.markEndIf(node)}function parseExpression(){var expr;delegate.markStart();expr=parseAssignmentExpression();if(match(",")){expr=delegate.createSequenceExpression([expr]);while(index<length){if(!match(",")){break}lex();expr.expressions.push(parseAssignmentExpression())}}return delegate.markEndIf(expr)}function parseExpressionStatement(){var expr=parseExpression();consumeSemicolon();return delegate.createExpressionStatement(expr)}function parseProgram(){skipComment();delegate.markStart();strict=false;peek();return delegate.markEnd(parseExpressionStatement())}function attachComments(){var i,attacher,comment,leading,trailing;for(i=0;i<extra.pendingComments.length;++i){attacher=extra.pendingComments[i];comment=attacher.comment;leading=attacher.leading;if(leading){if(typeof leading.leadingComments==="undefined"){leading.leadingComments=[]}leading.leadingComments.push(attacher.comment)}trailing=attacher.trailing;if(trailing){if(typeof trailing.trailingComments==="undefined"){trailing.trailingComments=[]}trailing.trailingComments.push(attacher.comment)}}extra.pendingComments=[]}function filterTokenLocation(){var i,entry,token,tokens=[];for(i=0;i<extra.tokens.length;++i){entry=extra.tokens[i];token={type:entry.type,value:entry.value};if(extra.range){token.range=entry.range}if(extra.loc){token.loc=entry.loc}tokens.push(token)}extra.tokens=tokens}function LocationMarker(){this.marker=[index,lineNumber,index-lineStart,0,0,0]}LocationMarker.prototype={constructor:LocationMarker,end:function(){this.marker[3]=index;this.marker[4]=lineNumber;this.marker[5]=index-lineStart},apply:function(node){if(extra.range){node.range=[this.marker[0],this.marker[3]]}if(extra.loc){node.loc={start:{line:this.marker[1],column:this.marker[2]},end:{line:this.marker[4],column:this.marker[5]}};node=delegate.postProcess(node)}if(extra.attachComment){delegate.processComment(node)}}};function createLocationMarker(){if(!extra.loc&&!extra.range){return null}skipComment();return new LocationMarker}function tokenize(code,options){var toString,token,tokens;toString=String;if(typeof code!=="string"&&!(code instanceof String)){code=toString(code)}delegate=SyntaxTreeDelegate;source=code;index=0;lineNumber=source.length>0?1:0;lineStart=0;length=source.length;lookahead=null;state={allowIn:true,labelSet:{},inFunctionBody:false,inIteration:false,inSwitch:false,lastCommentStart:-1};extra={};options=options||{};options.tokens=true;extra.tokens=[];extra.tokenize=true;extra.openParenToken=-1;extra.openCurlyToken=-1;extra.range=typeof options.range==="boolean"&&options.range;extra.loc=typeof options.loc==="boolean"&&options.loc;if(typeof options.comment==="boolean"&&options.comment){extra.comments=[]}if(typeof options.tolerant==="boolean"&&options.tolerant){extra.errors=[]}if(length>0){if(typeof source[0]==="undefined"){if(code instanceof String){source=code.valueOf()}}}try{peek();if(lookahead.type===Token.EOF){return extra.tokens}token=lex();while(lookahead.type!==Token.EOF){try{token=lex()}catch(lexError){token=lookahead;if(extra.errors){extra.errors.push(lexError);break}else{throw lexError}}}filterTokenLocation();tokens=extra.tokens;if(typeof extra.comments!=="undefined"){tokens.comments=extra.comments}if(typeof extra.errors!=="undefined"){tokens.errors=extra.errors}}catch(e){throw e}finally{extra={}}return tokens}function parse(code,options){var program,toString;toString=String;if(typeof code!=="string"&&!(code instanceof String)){code=toString(code)}delegate=SyntaxTreeDelegate;source=code;index=0;lineNumber=source.length>0?1:0;lineStart=0;length=source.length;lookahead=null;state={allowIn:true,labelSet:{},inFunctionBody:false,inIteration:false,inSwitch:false,lastCommentStart:-1,markerStack:[]};extra={};if(typeof options!=="undefined"){extra.range=typeof options.range==="boolean"&&options.range;extra.loc=typeof options.loc==="boolean"&&options.loc;extra.attachComment=typeof options.attachComment==="boolean"&&options.attachComment;if(extra.loc&&options.source!==null&&options.source!==undefined){extra.source=toString(options.source)}if(typeof options.tokens==="boolean"&&options.tokens){extra.tokens=[]}if(typeof options.comment==="boolean"&&options.comment){extra.comments=[]}if(typeof options.tolerant==="boolean"&&options.tolerant){extra.errors=[]}if(extra.attachComment){extra.range=true;extra.pendingComments=[];extra.comments=[]}}if(length>0){if(typeof source[0]==="undefined"){if(code instanceof String){source=code.valueOf()}}}try{program=parseProgram();if(typeof extra.comments!=="undefined"){program.comments=extra.comments}if(typeof extra.tokens!=="undefined"){filterTokenLocation();program.tokens=extra.tokens}if(typeof extra.errors!=="undefined"){program.errors=extra.errors}if(extra.attachComment){attachComments()}}catch(e){throw e}finally{extra={}}return program}exports.version="1.1.0-dev";exports.tokenize=tokenize;exports.parse=parse;exports.Syntax=function(){var name,types={};if(typeof Object.create==="function"){types=Object.create(null)}for(name in Syntax){if(Syntax.hasOwnProperty(name)){types[name]=Syntax[name]}}if(typeof Object.freeze==="function"){Object.freeze(types)}return types}()})},{}],33:[function(require,module,exports){exports.contexts=require("./lib/contexts");exports.expressions=require("./lib/expressions");exports.operatorFns=require("./lib/operatorFns");exports.templates=require("./lib/templates")},{"./lib/contexts":34,"./lib/expressions":35,"./lib/operatorFns":36,"./lib/templates":37}],34:[function(require,module,exports){exports.ContextMeta=ContextMeta;exports.Context=Context;function noop(){}function ContextMeta(){this.addBinding=noop;this.removeBinding=noop;this.addItemContext=noop;this.removeItemContext=noop;this.views=null;this.idNamespace="";this.idCount=0;this.pending=[];this.pauseCount=0}function Context(meta,controller,parent,unbound,expression,item,view,attributes,hooks){this.meta=meta;this.controller=controller;this.parent=parent;this.unbound=unbound;this.expression=expression;this.alias=expression&&expression.meta.as;this.keyAlias=expression&&expression.meta.keyAs;this.item=item;this.view=view;this.attributes=attributes;this.hooks=hooks;this._id=null}Context.prototype.id=function(){var count=++this.meta.idCount;return this.meta.idNamespace+"_"+count.toString(36)};Context.prototype.addBinding=function(binding){var expression=binding.template.expression;var bindType=expression&&expression.meta&&expression.meta.bindType;if(bindType==="unbound")return;if(bindType==="bound")return this.meta.addBinding(binding);if(this.unbound)return;this.meta.addBinding(binding)};Context.prototype.removeBinding=function(binding){this.meta.removeBinding(binding)};Context.prototype.child=function(expression){var blockType=expression.meta.blockType;var unbound=blockType==="unbound"?true:blockType==="bound"?false:this.unbound;return new Context(this.meta,this.controller,this,unbound,expression)};Context.prototype.componentChild=function(component){return new Context(this.meta,component,this,this.unbound)};Context.prototype.eachChild=function(index){var context=new Context(this.meta,this.controller,this,this.unbound,this.expression,index);
this.meta.addItemContext(context);return context};Context.prototype.viewChild=function(view,attributes,hooks){return new Context(this.meta,this.controller,this,this.unbound,null,null,view,attributes,hooks)};Context.prototype.forRelative=function(expression){return expression.meta&&expression.meta.blockType?this.parent:this};Context.prototype.forAlias=function(alias){var context=this;while(context){if(context.alias===alias||context.keyAlias===alias)return context;context=context.parent}};Context.prototype.forAttribute=function(attribute){var context=this;while(context){if(context.view){var attributes=context.attributes;if(!attributes)return;if(attributes.hasOwnProperty(attribute))return context;if(!attributes.inherit)return}context=context.parent}};Context.prototype.forViewParent=function(){var context=this;while(context){if(context.view)return context.parent;context=context.parent}};Context.prototype.getView=function(){var context=this;while(context){if(context.view)return context.view;context=context.parent}};Context.prototype.get=function(){return this.expression?this.expression.get(this):this.controller.model.data};Context.prototype.pause=function(){this.meta.pauseCount++};Context.prototype.unpause=function(){if(--this.meta.pauseCount)return;this.flush()};Context.prototype.flush=function(){var pending=this.meta.pending;var len=pending.length;if(!len)return;this.meta.pending=[];for(var i=0;i<len;i++){pending[i].run()}};Context.prototype.queueCreate=function(object){this.meta.pending.push(new PendingCreate(object,this))};function PendingCreate(object,context){this.object=object;this.context=context}PendingCreate.prototype.run=function(){this.object.create(this.context)}},{}],35:[function(require,module,exports){var serializeObject=require("serialize-object");var operatorFns=require("./operatorFns");var templates=require("./templates");exports.lookup=lookup;exports.templateTruthy=templateTruthy;exports.pathSegments=pathSegments;exports.renderValue=renderValue;exports.ExpressionMeta=ExpressionMeta;exports.Expression=Expression;exports.LiteralExpression=LiteralExpression;exports.PathExpression=PathExpression;exports.RelativePathExpression=RelativePathExpression;exports.AliasPathExpression=AliasPathExpression;exports.AttributePathExpression=AttributePathExpression;exports.BracketsExpression=BracketsExpression;exports.FnExpression=FnExpression;exports.OperatorExpression=OperatorExpression;exports.NewExpression=NewExpression;exports.SequenceExpression=SequenceExpression;function lookup(segments,value){if(!segments)return value;for(var i=0,len=segments.length;i<len;i++){if(value==null)return value;value=value[segments[i]]}return value}function templateTruthy(value){return Array.isArray(value)?value.length>0:!!value}function pathSegments(segments){var result=[];for(var i=0;i<segments.length;i++){var segment=segments[i];result[i]=typeof segment==="object"?segment.item:segment}return result}function renderValue(value,context){return typeof value!=="object"?value:value instanceof templates.Template?value.get(context,true):Array.isArray(value)?renderArray(value,context):renderObject(value,context)}function renderArray(array,context){for(var i=0,len=array.length;i<len;i++){if(hasTemplateProperty(array[i])){return renderArrayProperties(array,context)}}return array}function renderObject(object,context){return hasTemplateProperty(object)?renderObjectProperties(object,context):object}function hasTemplateProperty(object){if(typeof object!=="object")return false;for(var key in object){if(object[key]instanceof templates.Template)return true}return false}function renderArrayProperties(array,context){var out=[];for(var i=0,len=array.length;i<len;i++){var item=renderObject(array[i],context);out.push(item)}return out}function renderObjectProperties(object,context){var out={};for(var key in object){var value=object[key];out[key]=value instanceof templates.Template?value.get(context,true):value}return out}function ExpressionMeta(source,blockType,isEnd,as,keyAs,unescaped,bindType,valueType){this.source=source;this.blockType=blockType;this.isEnd=isEnd;this.as=as;this.keyAs=keyAs;this.unescaped=unescaped;this.bindType=bindType;this.valueType=valueType}ExpressionMeta.prototype.module="expressions";ExpressionMeta.prototype.type="ExpressionMeta";ExpressionMeta.prototype.serialize=function(){return serializeObject.instance(this,this.source,this.blockType,this.isEnd,this.as,this.keyAs,this.unescaped,this.bindType,this.valueType)};function Expression(meta){this.meta=meta}Expression.prototype.module="expressions";Expression.prototype.type="Expression";Expression.prototype.serialize=function(){return serializeObject.instance(this,this.meta)};Expression.prototype.toString=function(){return this.meta&&this.meta.source};Expression.prototype.truthy=function(context){var blockType=this.meta.blockType;if(blockType==="else")return true;var value=this.get(context,true);var truthy=templateTruthy(value);return blockType==="unless"?!truthy:truthy};Expression.prototype.get=function(){};Expression.prototype.resolve=function(){};Expression.prototype.dependencies=function(){};Expression.prototype.pathSegments=function(context){var segments=this.resolve(context);return segments&&pathSegments(segments)};Expression.prototype.set=function(context,value){var segments=this.pathSegments(context);if(!segments)throw new Error("Expression does not support setting");context.controller.model._set(segments,value)};Expression.prototype._getPatch=function(context,value){if(this.meta&&this.meta.blockType&&value instanceof templates.Template){value=value.get(context,true)}return context&&context.expression===this&&context.item!=null?value&&value[context.item]:value};Expression.prototype._resolvePatch=function(context,segments){return context&&context.expression===this&&context.item!=null?segments.concat(context):segments};function LiteralExpression(value,meta){this.value=value;this.meta=meta}LiteralExpression.prototype=new Expression;LiteralExpression.prototype.type="LiteralExpression";LiteralExpression.prototype.serialize=function(){return serializeObject.instance(this,this.value,this.meta)};LiteralExpression.prototype.get=function(context){return this._getPatch(context,this.value)};function PathExpression(segments,meta){this.segments=segments;this.meta=meta}PathExpression.prototype=new Expression;PathExpression.prototype.type="PathExpression";PathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.segments,this.meta)};PathExpression.prototype.get=function(context){var value=lookup(this.segments,context.controller.model.data);return this._getPatch(context,value)};PathExpression.prototype.resolve=function(context){var segments=concat(context.controller._scope,this.segments);return this._resolvePatch(context,segments)};PathExpression.prototype.dependencies=function(context,forInnerPath){return outerDependency(this,context,forInnerPath)};function RelativePathExpression(segments,meta){this.segments=segments;this.meta=meta}RelativePathExpression.prototype=new Expression;RelativePathExpression.prototype.type="RelativePathExpression";RelativePathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.segments,this.meta)};RelativePathExpression.prototype.get=function(context){var relativeContext=context.forRelative(this);var value=relativeContext.get();if(this.segments.length){if(value instanceof templates.Template)value=value.get(relativeContext,true);value=lookup(this.segments,value)}return this._getPatch(context,value)};RelativePathExpression.prototype.resolve=function(context){var relativeContext=context.forRelative(this);var base=relativeContext.expression?relativeContext.expression.resolve(relativeContext):[];if(!base)return;var segments=base.concat(this.segments);return this._resolvePatch(relativeContext,segments)};RelativePathExpression.prototype.dependencies=function(context,forInnerPath){var relativeContext=context.forRelative(this);var inner=relativeContext.expression&&relativeContext.expression.dependencies(relativeContext,true);var outer=outerDependency(this,context,forInnerPath);return concat(outer,inner)};function AliasPathExpression(alias,segments,meta){this.alias=alias;this.segments=segments;this.meta=meta}AliasPathExpression.prototype=new Expression;AliasPathExpression.prototype.type="AliasPathExpression";AliasPathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.alias,this.segments,this.meta)};AliasPathExpression.prototype.get=function(context){var aliasContext=context.forAlias(this.alias);if(!aliasContext)return;if(aliasContext.keyAlias===this.alias){return aliasContext.item}var value=aliasContext.get();if(this.segments.length){if(value instanceof templates.Template)value=value.get(aliasContext,true);value=lookup(this.segments,value)}return this._getPatch(context,value)};AliasPathExpression.prototype.resolve=function(context){var aliasContext=context.forAlias(this.alias);if(!aliasContext)return;if(aliasContext.keyAlias===this.alias)return;var base=aliasContext.expression.resolve(aliasContext);if(!base)return;var segments=base.concat(this.segments);return this._resolvePatch(context,segments)};AliasPathExpression.prototype.dependencies=function(context,forInnerPath){var aliasContext=context.forAlias(this.alias);if(!aliasContext)return;var inner=aliasContext.expression.dependencies(aliasContext,true);var outer=aliasContext.keyAlias===this.alias?outerDependency(aliasContext.parent.expression,aliasContext.parent,forInnerPath):outerDependency(this,context,forInnerPath);return concat(outer,inner)};function AttributePathExpression(attribute,segments,meta){this.attribute=attribute;this.segments=segments;this.meta=meta}AttributePathExpression.prototype=new Expression;AttributePathExpression.prototype.type="AttributePathExpression";AttributePathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.attribute,this.segments,this.meta)};AttributePathExpression.prototype.get=function(context){var attributeContext=context.forAttribute(this.attribute);if(!attributeContext)return;var value=attributeContext.attributes[this.attribute];if(this.segments.length){if(value instanceof templates.Template)value=value.get(attributeContext,true);value=lookup(this.segments,value)}return this._getPatch(context,value)};AttributePathExpression.prototype.resolve=function(context){var attributeContext=context.forAttribute(this.attribute);var value=attributeContext&&attributeContext.attributes[this.attribute];var base=value&&typeof value.resolve==="function"&&value.resolve(attributeContext);if(!base)return;var segments=base.concat(this.segments);return this._resolvePatch(context,segments)};AttributePathExpression.prototype.dependencies=function(context,forInnerPath){var attributeContext=context.forAttribute(this.attribute);var value=attributeContext&&attributeContext.attributes[this.attribute];var inner=value&&typeof value.dependencies==="function"&&value.dependencies(attributeContext,true);var outer=outerDependency(this,context,forInnerPath);return concat(outer,inner)};function BracketsExpression(before,inside,afterSegments,meta){this.before=before;this.inside=inside;this.afterSegments=afterSegments;this.meta=meta}BracketsExpression.prototype=new Expression;BracketsExpression.prototype.type="BracketsExpression";BracketsExpression.prototype.serialize=function(){return serializeObject.instance(this,this.before,this.inside,this.afterSegments,this.meta)};BracketsExpression.prototype.get=function(context){var inside=this.inside.get(context);if(inside==null)return;var before=this.before.get(context);if(!before)return;var base=before[inside];var value=this.afterSegments?lookup(this.afterSegments,base):base;return this._getPatch(context,value)};BracketsExpression.prototype.resolve=function(context){var inside=this.inside.get(context);if(inside==null)return;var base=this.before.resolve(context);if(!base)return;var segments=this.afterSegments?base.concat(inside,this.afterSegments):base.concat(inside);return this._resolvePatch(context,segments)};BracketsExpression.prototype.dependencies=function(context,forInnerPath){var before=this.before.dependencies(context,true);var inner=this.inside.dependencies(context);var outer=outerDependency(this,context,forInnerPath);return concat(concat(outer,inner),before)};function FnExpression(segments,args,afterSegments,meta){this.segments=segments;this.args=args;this.afterSegments=afterSegments;this.meta=meta;var parentSegments=segments&&segments.slice();this.lastSegment=parentSegments&&parentSegments.pop();this.parentSegments=parentSegments&&parentSegments.length?parentSegments:null}FnExpression.prototype=new Expression;FnExpression.prototype.type="FnExpression";FnExpression.prototype.serialize=function(){return serializeObject.instance(this,this.segments,this.args,this.afterSegments,this.meta)};FnExpression.prototype.get=function(context){var value=this.apply(context);if(this.afterSegments){value=lookup(this.afterSegments,value)}return this._getPatch(context,value)};FnExpression.prototype.apply=function(context,extraInputs,modelExtras){var controller=context.controller;var fn,parent;while(controller){parent=this.parentSegments?lookup(this.parentSegments,controller):controller;fn=parent&&parent[this.lastSegment];if(fn)break;controller=controller.parent}if(!fn)throw new Error("Function not found for: "+this.segments.join("."));var getFn=fn.get||fn;if(modelExtras){for(var key in modelExtras){context.controller.model.data[key]=modelExtras[key]}}var out=this._applyFn(getFn,context,extraInputs,parent);if(modelExtras){for(var key in modelExtras){delete context.controller.model.data[key]}}return out};FnExpression.prototype._getInputs=function(context){var inputs=[];for(var i=0,len=this.args.length;i<len;i++){var value=this.args[i].get(context);inputs.push(renderValue(value,context))}return inputs};FnExpression.prototype._applyFn=function(fn,context,extraInputs,thisArg){if(!this.args){return extraInputs?fn.apply(thisArg,extraInputs):fn.call(thisArg)}var inputs=this._getInputs(context);if(extraInputs){for(var i=0,len=extraInputs.length;i<len;i++){inputs.push(extraInputs[i])}}return fn.apply(thisArg,inputs)};FnExpression.prototype.dependencies=function(context){var dependencies=[];if(!this.args)return dependencies;for(var i=0,len=this.args.length;i<len;i++){var argDependencies=this.args[i].dependencies(context);var firstDependency=argDependencies&&argDependencies[0];if(!firstDependency)continue;if(firstDependency[firstDependency.length-1]!=="*"){argDependencies[0]=argDependencies[0].concat("*")}for(var j=0,jLen=argDependencies.length;j<jLen;j++){dependencies.push(argDependencies[j])}}return dependencies};FnExpression.prototype.set=function(context,value){var controller=context.controller;var fn,parent;while(controller){parent=this.parentSegments?lookup(this.parentSegments,controller):controller;fn=parent&&parent[this.lastSegment];if(fn)break;controller=controller.parent}var setFn=fn&&fn.set;if(!setFn)throw new Error("No setter function for: "+this.segments.join("."));var inputs=this._getInputs(context);inputs.unshift(value);var out=setFn.apply(parent,inputs);for(var i in out){this.args[i].set(context,out[i])}};function NewExpression(segments,args,afterSegments,meta){FnExpression.call(this,segments,args,afterSegments,meta)}NewExpression.prototype=new FnExpression;NewExpression.prototype.type="NewExpression";NewExpression.prototype._applyFn=function(Fn,context){if(!this.args)return new Fn;var inputs=this._getInputs(context);inputs.unshift(null);return new(Fn.bind.apply(Fn,inputs))};function OperatorExpression(name,args,afterSegments,meta){this.name=name;this.args=args;this.afterSegments=afterSegments;this.meta=meta;this.getFn=operatorFns.get[name];this.setFn=operatorFns.set[name]}OperatorExpression.prototype=new FnExpression;OperatorExpression.prototype.type="OperatorExpression";OperatorExpression.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.args,this.afterSegments,this.meta)};OperatorExpression.prototype.apply=function(context){var inputs=this._getInputs(context);return this.getFn.apply(null,inputs)};OperatorExpression.prototype.set=function(context,value){var inputs=this._getInputs(context);inputs.unshift(value);var out=this.setFn.apply(null,inputs);for(var i in out){this.args[i].set(context,out[i])}};function SequenceExpression(args,afterSegments,meta){this.args=args;this.afterSegments=afterSegments;this.meta=meta}SequenceExpression.prototype=new OperatorExpression;SequenceExpression.prototype.type="SequenceExpression";SequenceExpression.prototype.serialize=function(){return serializeObject.instance(this,this.args,this.afterSegments,this.meta)};SequenceExpression.prototype.name=",";SequenceExpression.prototype.getFn=operatorFns.get[","];SequenceExpression.prototype.resolve=function(context){var last=this.args[this.args.length-1];return last.resolve(context)};SequenceExpression.prototype.dependencies=function(context,forInnerPath){var last=this.args[this.args.length-1];return last.dependencies(context,forInnerPath)};function outerDependency(expression,context,forInnerPath){if(forInnerPath)return;return[expression.resolve(context)]}function concat(a,b){if(!a)return b;if(!b)return a;return a.concat(b)}},{"./operatorFns":36,"./templates":37,"serialize-object":39}],36:[function(require,module,exports){exports.get={"!U":function(value){return!value},"-U":function(value){return-value},"+U":function(value){return+value},"~U":function(value){return~value},typeofU:function(value){return typeof value},"||":function(left,right){return left||right},"&&":function(left,right){return left&&right},"|":function(left,right){return left|right},"^":function(left,right){return left^right},"&":function(left,right){return left&right},"==":function(left,right){return left==right},"!=":function(left,right){return left!=right},"===":function(left,right){return left===right},"!==":function(left,right){return left!==right},"<":function(left,right){return left<right},">":function(left,right){return left>right},"<=":function(left,right){return left<=right},">=":function(left,right){return left>=right},"instanceof":function(left,right){return left instanceof right},"in":function(left,right){return left in right},"<<":function(left,right){return left<<right},">>":function(left,right){return left>>right},">>>":function(left,right){return left>>>right},"+":function(left,right){return left+right},"-":function(left,right){return left-right},"*":function(left,right){return left*right},"/":function(left,right){return left/right},"%":function(left,right){return left%right},"?":function(test,consequent,alternate){return test?consequent:alternate},",":function(){return arguments[arguments.length-1]},"[]":function(){return Array.prototype.slice.call(arguments)},"{}":function(){var value={};for(var i=0,len=arguments.length;i<len;i+=2){var key=arguments[i];value[key]=arguments[i+1]}return value}};exports.set={"!U":function(value){return[!value]},"-U":function(value){return[-value]},"==":function(value,left,right){if(value)return[right]},"===":function(value,left,right){if(value)return[right]},"in":function(value,left,right){right[left]=true;return{1:right}},"+":function(value,left,right){return[value-right]},"-":function(value,left,right){return[value+right]},"*":function(value,left,right){return[value/right]},"/":function(value,left,right){return[value*right]}}},{}],37:[function(require,module,exports){var saddle=require("saddle");var serializeObject=require("serialize-object");(function(){for(var key in saddle){exports[key]=saddle[key]}})();exports.View=View;exports.ViewInstance=ViewInstance;exports.DynamicViewInstance=DynamicViewInstance;exports.ParentWrapper=ParentWrapper;exports.Views=Views;exports.MarkupHook=MarkupHook;exports.ElementOn=ElementOn;exports.ComponentOn=ComponentOn;exports.MarkupAs=MarkupAs;exports.emptyTemplate=new saddle.Template([]);saddle.Template.prototype.resolve=function(){};saddle.Template.prototype.dependencies=function(context){return getArrayDependencies(this.content,context)};saddle.Doctype.prototype.dependencies=function(){};saddle.Text.prototype.dependencies=function(){};saddle.DynamicText.prototype.dependencies=function(context){return getDependencies(this.expression,context)};saddle.Comment.prototype.dependencies=function(){};saddle.DynamicComment.prototype.dependencies=function(context){return getDependencies(this.expression,context)};saddle.Element.prototype.dependencies=function(context){var items=getMapDependencies(this.attributes,context);return getArrayDependencies(this.content,context,items)};saddle.Block.prototype.dependencies=function(context){var items=getDependencies(this.expression,context);return getArrayDependencies(this.content,context,items)};saddle.ConditionalBlock.prototype.dependencies=function(context){var items=getArrayDependencies(this.expressions,context);return getArrayOfArrayDependencies(this.contents,context,items)};saddle.EachBlock.prototype.dependencies=function(context){var items=getDependencies(this.expression,context);items=getArrayDependencies(this.content,context,items);return getArrayDependencies(this.elseContent,context,items)};saddle.Attribute.prototype.dependencies=function(){};saddle.DynamicAttribute.prototype.dependencies=function(context){return getDependencies(this.expression,context)};function getArrayOfArrayDependencies(expressions,context,items){if(!expressions)return items;for(var i=0,len=expressions.length;i<len;i++){items=getArrayDependencies(expressions[i],context,items)}return items}function getArrayDependencies(expressions,context,items){if(!expressions)return items;for(var i=0,len=expressions.length;i<len;i++){items=getDependencies(expressions[i],context,items)}return items}function getMapDependencies(expressions,context,items){if(!expressions)return items;for(var key in expressions){items=getDependencies(expressions[key],context,items)}return items}function getDependencies(expression,context,items){var dependencies=expression&&expression.dependencies(context);if(!dependencies)return items;for(var i=0,len=dependencies.length;i<len;i++){items||(items=[]);items.push(dependencies[i])}return items}function ViewAttributesMap(source){var items=source.split(/\s+/);for(var i=0,len=items.length;i<len;i++){this[items[i]]=true}}function ViewArraysMap(source){var items=source.split(/\s+/);for(var i=0,len=items.length;i<len;i++){var item=items[i].split("/");this[item[0]]=item[1]||item[0]}}function View(views,name,source,options){this.views=views;this.name=name;this.source=source;this.options=options;var nameSegments=(this.name||"").split(":");var lastSegment=nameSegments.pop();this.namespace=nameSegments.join(":");this.registeredName=lastSegment==="index"?this.namespace:this.name;this.attributesMap=options&&options.attributes&&new ViewAttributesMap(options.attributes);this.arraysMap=options&&options.arrays&&new ViewArraysMap(options.arrays);this.unminified=options&&(options.unminified||options.unminified==="");this.string=options&&(options.string||options.string==="");this.template=null;this.componentFactory=null}View.prototype=new saddle.Template;View.prototype.type="View";View.prototype.serialize=function(options){var template=this.template||this._parse();return"views.register("+serializeObject.args([this.name,options&&options.minify?null:this.source,hasKeys(this.options)?this.options:null])+").template = "+template.serialize()+";"};View.prototype.get=function(context,unescaped){if(this.componentFactory)context=this.componentFactory.init(context);var template=this.template||this._parse();return template.get(context,unescaped)};View.prototype.getFragment=function(context,binding){if(this.componentFactory)context=this.componentFactory.init(context);var template=this.template||this._parse();var fragment=template.getFragment(context,binding);if(this.componentFactory)context.queueCreate(this.componentFactory);return fragment};View.prototype.appendTo=function(parent,context){if(this.componentFactory)context=this.componentFactory.init(context);var template=this.template||this._parse();template.appendTo(parent,context);if(this.componentFactory)context.queueCreate(this.componentFactory)};View.prototype.attachTo=function(parent,node,context){if(this.componentFactory)context=this.componentFactory.init(context);var template=this.template||this._parse();var node=template.attachTo(parent,node,context);if(this.componentFactory)context.queueCreate(this.componentFactory);return node};View.prototype.dependencies=function(context){var template=this.template||this._parse();return template.dependencies(context)};View.prototype._parse=function(){throw new Error("View parsing not available")};function ViewInstance(name,attributes,hooks){this.name=name;this.attributes=attributes;this.hooks=hooks;this.view=null}ViewInstance.prototype=new saddle.Template;ViewInstance.prototype.type="ViewInstance";ViewInstance.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.attributes,this.hooks)};ViewInstance.prototype.get=function(context,unescaped){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks);return view.get(viewContext,unescaped)};ViewInstance.prototype.getFragment=function(context,binding){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks);return view.getFragment(viewContext,binding)};ViewInstance.prototype.appendTo=function(parent,context){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks);view.appendTo(parent,viewContext)};ViewInstance.prototype.attachTo=function(parent,node,context){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks);return view.attachTo(parent,node,viewContext)};ViewInstance.prototype.dependencies=function(context){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks);return view.dependencies(viewContext)};ViewInstance.prototype._find=function(context){if(this.view)return this.view;var contextView=context.getView();var namespace=contextView&&contextView.namespace;this.view=context.meta.views.find(this.name,namespace);if(!this.view){var message=context.meta.views.findErrorMessage(this.name,contextView);throw new Error(message)}return this.view};function DynamicViewInstance(nameExpression,attributes,hooks){this.nameExpression=nameExpression;this.attributes=attributes;this.hooks=hooks;this.optional=attributes&&attributes.optional}DynamicViewInstance.prototype=new ViewInstance;DynamicViewInstance.prototype.type="DynamicViewInstance";DynamicViewInstance.prototype.serialize=function(){return serializeObject.instance(this,this.nameExpression,this.attributes,this.hooks)};DynamicViewInstance.prototype._find=function(context){var name=this.nameExpression.get(context);var contextView=context.getView();var namespace=contextView&&contextView.namespace;var view=name&&context.meta.views.find(name,namespace);if(!view){if(this.optional)return exports.emptyTemplate;var message=context.meta.views.findErrorMessage(name,contextView);throw new Error(message)}return view};function ParentWrapper(template,expression){this.template=template;this.expression=expression}ParentWrapper.prototype=new saddle.Template;ParentWrapper.prototype.type="ParentWrapper";ParentWrapper.prototype.serialize=function(){return serializeObject.instance(this,this.template,this.expression)};ParentWrapper.prototype.get=function(context,unescaped){return(this.expression||this.template).get(context.forViewParent(),unescaped)};ParentWrapper.prototype.getFragment=function(context,binding){return this.template.getFragment(context.forViewParent(),binding)};ParentWrapper.prototype.appendTo=function(parent,context){this.template.appendTo(parent,context.forViewParent())};ParentWrapper.prototype.attachTo=function(parent,node,context){return this.template.attachTo(parent,node,context.forViewParent())};ParentWrapper.prototype.resolve=function(context){return this.expression&&this.expression.resolve(context.forViewParent())};ParentWrapper.prototype.dependencies=function(context){return(this.expression||this.template).dependencies(context.forViewParent())};function ViewsMap(){}function Views(){this.nameMap=new ViewsMap;this.elementMap=new ViewsMap}Views.prototype.find=function(name,namespace){var map=this.nameMap;var exactName=namespace?namespace+":"+name:name;var match=map[exactName];if(match)return match;var segments=name.split(":");var segmentsDepth=segments.length;if(namespace)segments=namespace.split(":").concat(segments);while(segmentsDepth>0){while(segments.length>segmentsDepth){segments.splice(-1-segmentsDepth,1);var testName=segments.join(":");var match=map[testName];if(match)return match}segmentsDepth--}};Views.prototype.register=function(name,source,options){var mapName=name.replace(/:index$/,"");var view=this.nameMap[mapName];if(view){var componentFactory=view.componentFactory;View.call(view,this,name,source,options);view.componentFactory=componentFactory}else{view=new View(this,name,source,options)}this.nameMap[mapName]=view;if(options&&options.element)this.elementMap[options.element]=view;return view};Views.prototype.serialize=function(options){var out="function(derbyTemplates, views) {"+"var expressions = derbyTemplates.expressions;"+"var templates = derbyTemplates.templates;";for(var name in this.nameMap){out+=this.nameMap[name].serialize(options)}return out+"}"};Views.prototype.findErrorMessage=function(name,contextView){var names=Object.keys(this.nameMap);var message='Cannot find view "'+name+'" in'+[""].concat(names).join("\n  ")+"\n";if(contextView){message+='\nWithin template "'+contextView.name+'":\n'+contextView.source}return message};function MarkupHook(){}MarkupHook.prototype.module=saddle.Template.prototype.module;function ElementOn(name,expression){this.name=name;this.expression=expression}ElementOn.prototype=new MarkupHook;ElementOn.prototype.type="ElementOn";ElementOn.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.expression)};ElementOn.prototype.emit=function(context,element){var expression=this.expression;element.addEventListener(this.name,function elementOnListener(event){return expression.apply(context,null,{$event:event,$element:element})},false)};function ComponentOn(name,expression){this.name=name;this.expression=expression}ComponentOn.prototype=new MarkupHook;ComponentOn.prototype.type="ComponentOn";ComponentOn.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.expression)};ComponentOn.prototype.emit=function(context,component){var expression=this.expression;component.on(this.name,function componentOnListener(){var args=arguments.length&&Array.prototype.slice.call(arguments);return expression.apply(context,args)})};function MarkupAs(segments){this.segments=segments;this.lastSegment=segments.pop()}MarkupAs.prototype=new MarkupHook;MarkupAs.prototype.type="MarkupAs";MarkupAs.prototype.serialize=function(){var segments=this.segments.concat(this.lastSegment);return serializeObject.instance(this,segments)};MarkupAs.prototype.emit=function(context,target){var node=traverseAndCreate(context.controller,this.segments);node[this.lastSegment]=target};function traverseAndCreate(node,segments){var len=segments.length;if(!len)return node;for(var i=0;i<len;i++){var segment=segments[i];node=node[segment]||(node[segment]={})}return node}function hasKeys(value){if(!value)return false;for(var key in value){return true}return false}},{saddle:38,"serialize-object":39}],38:[function(require,module,exports){if(typeof require==="function"){var serializeObject=require("serialize-object")}var UPDATE_PROPERTIES={checked:"checked",disabled:"disabled",selected:"selected",type:"type",value:"value","class":"className","for":"htmlFor",tabindex:"tabIndex",readonly:"readOnly",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable",enctype:"encoding",id:"id",title:"title"};
var CREATE_PROPERTIES={};mergeInto(UPDATE_PROPERTIES,CREATE_PROPERTIES);CREATE_PROPERTIES.checked="defaultChecked";CREATE_PROPERTIES.value="defaultValue";var VOID_ELEMENTS={area:true,base:true,br:true,col:true,embed:true,hr:true,img:true,input:true,keygen:true,link:true,menuitem:true,meta:true,param:true,source:true,track:true,wbr:true};var NAMESPACE_URIS={svg:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink",xmlns:"http://www.w3.org/2000/xmlns/"};exports.CREATE_PROPERTIES=CREATE_PROPERTIES;exports.UPDATE_PROPERTIES=UPDATE_PROPERTIES;exports.VOID_ELEMENTS=VOID_ELEMENTS;exports.NAMESPACE_URIS=NAMESPACE_URIS;exports.Template=Template;exports.Doctype=Doctype;exports.Text=Text;exports.DynamicText=DynamicText;exports.Comment=Comment;exports.DynamicComment=DynamicComment;exports.Html=Html;exports.DynamicHtml=DynamicHtml;exports.Element=Element;exports.Block=Block;exports.ConditionalBlock=ConditionalBlock;exports.EachBlock=EachBlock;exports.Attribute=Attribute;exports.DynamicAttribute=DynamicAttribute;exports.Binding=Binding;exports.NodeBinding=NodeBinding;exports.AttributeBinding=AttributeBinding;exports.RangeBinding=RangeBinding;function Template(content){this.content=content}Template.prototype.get=function(context,unescaped){return contentHtml(this.content,context,unescaped)};Template.prototype.getFragment=function(context,binding){var fragment=document.createDocumentFragment();this.appendTo(fragment,context,binding);return fragment};Template.prototype.appendTo=function(parent,context){appendContent(parent,this.content,context)};Template.prototype.attachTo=function(parent,node,context){return attachContent(parent,node,this.content,context)};Template.prototype.update=function(){};Template.prototype.stringify=function(value){return value==null?"":value+""};Template.prototype.module="templates";Template.prototype.type="Template";Template.prototype.serialize=function(){return serializeObject.instance(this,this.content)};function Doctype(name,publicId,systemId){this.name=name;this.publicId=publicId;this.systemId=systemId}Doctype.prototype=new Template;Doctype.prototype.get=function(){var publicText=this.publicId?' PUBLIC "'+this.publicId+'"':"";var systemText=this.systemId?this.publicId?' "'+this.systemId+'"':' SYSTEM "'+this.systemId+'"':"";return"<!DOCTYPE "+this.name+publicText+systemText+">"};Doctype.prototype.appendTo=function(){};Doctype.prototype.attachTo=function(parent,node){if(!node||node.nodeType!==10){throw attachError(parent,node)}return node.nextSibling};Doctype.prototype.type="Doctype";Doctype.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.publicId,this.systemId)};function Text(data){this.data=data;this.escaped=escapeHtml(data)}Text.prototype=new Template;Text.prototype.get=function(context,unescaped){return unescaped?this.data:this.escaped};Text.prototype.appendTo=function(parent){var node=document.createTextNode(this.data);parent.appendChild(node)};Text.prototype.attachTo=function(parent,node){return attachText(parent,node,this.data,this)};Text.prototype.type="Text";Text.prototype.serialize=function(){return serializeObject.instance(this,this.data)};function DynamicText(expression){this.expression=expression}DynamicText.prototype=new Template;DynamicText.prototype.get=function(context,unescaped){var value=this.expression.get(context);if(value instanceof Template){do{value=value.get(context,unescaped)}while(value instanceof Template);return value}var data=this.stringify(value);return unescaped?data:escapeHtml(data)};DynamicText.prototype.appendTo=function(parent,context){var value=this.expression.get(context);if(value instanceof Template){value.appendTo(parent,context);return}var data=this.stringify(value);var node=document.createTextNode(data);parent.appendChild(node);addNodeBinding(this,context,node)};DynamicText.prototype.attachTo=function(parent,node,context){var value=this.expression.get(context);if(value instanceof Template){return value.attachTo(parent,node,context)}var data=this.stringify(value);return attachText(parent,node,data,this,context)};DynamicText.prototype.update=function(context,binding){binding.node.data=this.stringify(this.expression.get(context))};DynamicText.prototype.type="DynamicText";DynamicText.prototype.serialize=function(){return serializeObject.instance(this,this.expression)};function attachText(parent,node,data,template,context){if(!node){var newNode=document.createTextNode(data);parent.appendChild(newNode);addNodeBinding(template,context,newNode);return}if(node.nodeType===3){if(node.data===data){addNodeBinding(template,context,node);return node.nextSibling}var nextNode=splitData(node,data.length);if(node.data!==data){throw attachError(parent,node)}addNodeBinding(template,context,node);return nextNode}if(data===""){var newNode=document.createTextNode("");parent.insertBefore(newNode,node||null);addNodeBinding(template,context,newNode);return node}throw attachError(parent,node)}function Comment(data){this.data=data}Comment.prototype=new Template;Comment.prototype.get=function(){return"<!--"+this.data+"-->"};Comment.prototype.appendTo=function(parent){var node=document.createComment(this.data);parent.appendChild(node)};Comment.prototype.attachTo=function(parent,node){return attachComment(parent,node,this.data)};Comment.prototype.type="Comment";Comment.prototype.serialize=function(){return serializeObject.instance(this,this.data)};function DynamicComment(expression){this.expression=expression}DynamicComment.prototype=new Template;DynamicComment.prototype.get=function(context){var value=getUnescapedValue(this.expression,context);var data=this.stringify(value);return"<!--"+data+"-->"};DynamicComment.prototype.appendTo=function(parent,context){var value=getUnescapedValue(this.expression,context);var data=this.stringify(value);var node=document.createComment(data);parent.appendChild(node);addNodeBinding(this,context,node)};DynamicComment.prototype.attachTo=function(parent,node,context){var value=getUnescapedValue(this.expression,context);var data=this.stringify(value);return attachComment(parent,node,data,this,context)};DynamicComment.prototype.update=function(context,binding){var value=getUnescapedValue(this.expression,context);binding.node.data=this.stringify(value)};DynamicComment.prototype.type="DynamicComment";DynamicComment.prototype.serialize=function(){return serializeObject.instance(this,this.expression)};function attachComment(parent,node,data,template,context){if(!node||node.nodeType!==8){var newNode=document.createComment(data);parent.insertBefore(newNode,node||null);addNodeBinding(template,context,newNode);return node}if(node.data===data){addNodeBinding(template,context,node);return node.nextSibling}throw attachError(parent,node)}function addNodeBinding(template,context,node){if(!context)return;context.addBinding(new NodeBinding(template,context,node))}function Html(data){this.data=data}Html.prototype=new Template;Html.prototype.get=function(){return this.data};Html.prototype.appendTo=function(parent){var fragment=createHtmlFragment(parent,this.data);parent.appendChild(fragment)};Html.prototype.attachTo=function(parent,node){return attachHtml(parent,node,this.data)};Html.prototype.type="Html";Html.prototype.serialize=function(){return serializeObject.instance(this,this.data)};function DynamicHtml(expression){this.expression=expression;this.ending="/"+expression}DynamicHtml.prototype=new Template;DynamicHtml.prototype.get=function(context){var value=getUnescapedValue(this.expression,context);return this.stringify(value)};DynamicHtml.prototype.appendTo=function(parent,context,binding){var start=document.createComment(this.expression);var end=document.createComment(this.ending);var value=getUnescapedValue(this.expression,context);var html=this.stringify(value);var fragment=createHtmlFragment(parent,html);parent.appendChild(start);parent.appendChild(fragment);parent.appendChild(end);updateRange(context,binding,this,start,end)};DynamicHtml.prototype.attachTo=function(parent,node,context){var start=document.createComment(this.expression);var end=document.createComment(this.ending);var value=getUnescapedValue(this.expression,context);var html=this.stringify(value);parent.insertBefore(start,node||null);node=attachHtml(parent,node,html);parent.insertBefore(end,node||null);updateRange(context,null,this,start,end);return node};DynamicHtml.prototype.update=function(context,binding){var start=binding.start;var end=binding.end;var value=getUnescapedValue(this.expression,context);var html=this.stringify(value);var fragment=createHtmlFragment(binding.start.parentNode,html);replaceRange(context,start,end,fragment,binding)};DynamicHtml.prototype.type="DynamicHtml";DynamicHtml.prototype.serialize=function(){return serializeObject.instance(this,this.expression)};function createHtmlFragment(parent,html){if(parent.nodeType===1){var range=document.createRange();range.selectNodeContents(parent);return range.createContextualFragment(html)}var div=document.createElement("div");var range=document.createRange();div.innerHTML=html;range.selectNodeContents(div);return range.extractContents()}function attachHtml(parent,node,html){var fragment=createHtmlFragment(parent,html);for(var i=0,len=fragment.childNodes.length;i<len;i++){if(!node)throw attachError(parent,node);node=node.nextSibling}return node}function Attribute(data,ns){this.data=data;this.ns=ns}Attribute.prototype.get=Attribute.prototype.getBound=function(context){return this.data};Attribute.prototype.module=Template.prototype.module;Attribute.prototype.type="Attribute";Attribute.prototype.serialize=function(){return serializeObject.instance(this,this.data,this.ns)};function DynamicAttribute(expression,ns){this.expression=expression;this.ns=ns}DynamicAttribute.prototype=new Attribute;DynamicAttribute.prototype.get=function(context){return getUnescapedValue(this.expression,context)};DynamicAttribute.prototype.getBound=function(context,element,name){context.addBinding(new AttributeBinding(this,context,element,name));return getUnescapedValue(this.expression,context)};DynamicAttribute.prototype.update=function(context,binding){var value=getUnescapedValue(this.expression,context);var element=binding.element;var propertyName=!element.ns&&UPDATE_PROPERTIES[binding.name];if(propertyName){if(value===void 0)value=null;element[propertyName]=value;return}if(value===false||value==null){if(this.ns){element.removeAttributeNS(this.ns,binding.name)}else{element.removeAttribute(binding.name)}return}if(value===true)value=binding.name;if(this.ns){element.setAttributeNS(this.ns,binding.name,value)}else{element.setAttribute(binding.name,value)}};DynamicAttribute.prototype.type="DynamicAttribute";DynamicAttribute.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.ns)};function getUnescapedValue(expression,context){var unescaped=true;var value=expression.get(context,unescaped);while(value instanceof Template){value=value.get(context,unescaped)}return value}function Element(tagName,attributes,content,hooks,selfClosing,notClosed,ns){this.tagName=tagName;this.attributes=attributes;this.content=content;this.hooks=hooks;this.selfClosing=selfClosing;this.notClosed=notClosed;this.ns=ns;var lowerTagName=tagName.toLowerCase();var isVoid=VOID_ELEMENTS[lowerTagName];this.startClose=selfClosing?" />":">";this.endTag=isVoid||selfClosing||notClosed?"":"</"+tagName+">";this.unescapedContent=lowerTagName==="script"||lowerTagName==="style"}Element.prototype=new Template;Element.prototype.get=function(context){var tagItems=[this.tagName];for(var key in this.attributes){var value=this.attributes[key].get(context);if(value===true){tagItems.push(key)}else if(value!==false&&value!=null){tagItems.push(key+'="'+escapeAttribute(value)+'"')}}var startTag="<"+tagItems.join(" ")+this.startClose;if(this.content){var inner=contentHtml(this.content,context,this.unescapedContent);return startTag+inner+this.endTag}return startTag+this.endTag};Element.prototype.appendTo=function(parent,context){var element=this.ns?document.createElementNS(this.ns,this.tagName):document.createElement(this.tagName);emitHooks(this.hooks,context,element);for(var key in this.attributes){var attribute=this.attributes[key];var value=attribute.getBound(context,element,key);if(value===false||value==null)continue;var propertyName=!this.ns&&CREATE_PROPERTIES[key];if(propertyName){element[propertyName]=value;continue}if(value===true)value=key;if(attribute.ns){element.setAttributeNS(attribute.ns,key,value)}else{element.setAttribute(key,value)}}if(this.content)appendContent(element,this.content,context);parent.appendChild(element)};Element.prototype.attachTo=function(parent,node,context){if(!node||node.nodeType!==1||node.tagName.toLowerCase()!==this.tagName.toLowerCase()){throw attachError(parent,node)}emitHooks(this.hooks,context,node);for(var key in this.attributes){this.attributes[key].getBound(context,node,key)}if(this.content)attachContent(node,node.firstChild,this.content,context);return node.nextSibling};Element.prototype.type="Element";Element.prototype.serialize=function(){return serializeObject.instance(this,this.tagName,this.attributes,this.content,this.hooks,this.selfClosing,this.notClosed,this.ns)};function getAttributeValue(element,name){var propertyName=UPDATE_PROPERTIES[name];return propertyName?element[propertyName]:element.getAttribute(name)}function emitHooks(hooks,context,value){if(!hooks)return;for(var i=0,len=hooks.length;i<len;i++){hooks[i].emit(context,value)}}function Block(expression,content){this.expression=expression;this.ending="/"+expression;this.content=content}Block.prototype=new Template;Block.prototype.get=function(context,unescaped){var blockContext=context.child(this.expression);return contentHtml(this.content,blockContext,unescaped)};Block.prototype.appendTo=function(parent,context,binding){var blockContext=context.child(this.expression);var start=document.createComment(this.expression);var end=document.createComment(this.ending);parent.appendChild(start);appendContent(parent,this.content,blockContext);parent.appendChild(end);updateRange(context,binding,this,start,end)};Block.prototype.attachTo=function(parent,node,context){var blockContext=context.child(this.expression);var start=document.createComment(this.expression);var end=document.createComment(this.ending);parent.insertBefore(start,node||null);node=attachContent(parent,node,this.content,blockContext);parent.insertBefore(end,node||null);updateRange(context,null,this,start,end);return node};Block.prototype.type="Block";Block.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.content)};function ConditionalBlock(expressions,contents){this.expressions=expressions;this.beginning=expressions.join("; ");this.ending="/"+this.beginning;this.contents=contents;this.last=null}ConditionalBlock.prototype=new Block;ConditionalBlock.prototype.get=function(context,unescaped){var html="";for(var i=0,len=this.expressions.length;i<len;i++){var expression=this.expressions[i];if(expression.truthy(context)){var blockContext=context.child(expression);html+=contentHtml(this.contents[i],blockContext,unescaped);break}}return html};ConditionalBlock.prototype.appendTo=function(parent,context,binding){var start=document.createComment(this.beginning);var end=document.createComment(this.ending);parent.appendChild(start);this.last=null;for(var i=0,len=this.expressions.length;i<len;i++){var expression=this.expressions[i];if(expression.truthy(context)){this.last=i;var blockContext=context.child(expression);appendContent(parent,this.contents[i],blockContext);break}}parent.appendChild(end);updateRange(context,binding,this,start,end)};ConditionalBlock.prototype.attachTo=function(parent,node,context){var start=document.createComment(this.beginning);var end=document.createComment(this.ending);parent.insertBefore(start,node||null);this.last=null;for(var i=0,len=this.expressions.length;i<len;i++){var expression=this.expressions[i];if(expression.truthy(context)){this.last=i;var blockContext=context.child(expression);node=attachContent(parent,node,this.contents[i],blockContext);break}}parent.insertBefore(end,node||null);updateRange(context,null,this,start,end);return node};ConditionalBlock.prototype.type="ConditionalBlock";ConditionalBlock.prototype.serialize=function(){return serializeObject.instance(this,this.expressions,this.contents)};ConditionalBlock.prototype.update=function(context,binding){var value=null;for(var i=0,len=this.expressions.length;i<len;i++){if(this.expressions[i].truthy(context)){value=i;break}}if(value===this.last)return;var start=binding.start;var end=binding.end;var fragment=this.getFragment(context,binding);replaceRange(context,start,end,fragment,binding)};function EachBlock(expression,content,elseContent){this.expression=expression;this.ending="/"+expression;this.content=content;this.elseContent=elseContent}EachBlock.prototype=new Block;EachBlock.prototype.get=function(context,unescaped){var items=this.expression.get(context);var listContext=context.child(this.expression);if(items&&items.length){var html="";for(var i=0,len=items.length;i<len;i++){var itemContext=listContext.eachChild(i);html+=contentHtml(this.content,itemContext,unescaped)}return html}else if(this.elseContent){return contentHtml(this.elseContent,listContext,unescaped)}return""};EachBlock.prototype.appendTo=function(parent,context,binding){var items=this.expression.get(context);var listContext=context.child(this.expression);var start=document.createComment(this.expression);var end=document.createComment(this.ending);parent.appendChild(start);if(items&&items.length){for(var i=0,len=items.length;i<len;i++){var itemContext=listContext.eachChild(i);this.appendItemTo(parent,itemContext,start)}}else if(this.elseContent){appendContent(parent,this.elseContent,listContext)}parent.appendChild(end);updateRange(context,binding,this,start,end)};EachBlock.prototype.appendItemTo=function(parent,context,itemFor,binding){var before=parent.lastChild;var start,end;appendContent(parent,this.content,context);if(before===parent.lastChild){start=end=document.createComment("empty");parent.appendChild(start)}else{start=before&&before.nextSibling||parent.firstChild;end=parent.lastChild}updateRange(context,binding,this,start,end,itemFor)};EachBlock.prototype.attachTo=function(parent,node,context){var items=this.expression.get(context);var listContext=context.child(this.expression);var start=document.createComment(this.expression);var end=document.createComment(this.ending);parent.insertBefore(start,node||null);if(items&&items.length){for(var i=0,len=items.length;i<len;i++){var itemContext=listContext.eachChild(i);node=this.attachItemTo(parent,node,itemContext,start)}}else if(this.elseContent){node=attachContent(parent,node,this.elseContent,listContext)}parent.insertBefore(end,node||null);updateRange(context,null,this,start,end);return node};EachBlock.prototype.attachItemTo=function(parent,node,context,itemFor){var start,end;var nextNode=attachContent(parent,node,this.content,context);if(nextNode===node){start=end=document.createComment("empty");parent.insertBefore(start,node||null)}else{start=node;end=nextNode&&nextNode.previousSibling||parent.lastChild}updateRange(context,null,this,start,end,itemFor);return nextNode};EachBlock.prototype.update=function(context,binding){var start=binding.start;var end=binding.end;if(binding.itemFor){var fragment=document.createDocumentFragment();this.appendItemTo(fragment,context,binding.itemFor,binding)}else{var fragment=this.getFragment(context,binding)}replaceRange(context,start,end,fragment,binding)};EachBlock.prototype.insert=function(context,binding,index,howMany){var items=this.expression.get(context);var listContext=context.child(this.expression);var node=indexStartNode(binding,index);var fragment=document.createDocumentFragment();for(var i=index,len=index+howMany;i<len;i++){var itemContext=listContext.eachChild(i);this.appendItemTo(fragment,itemContext,binding.start)}binding.start.parentNode.insertBefore(fragment,node||null)};EachBlock.prototype.remove=function(context,binding,index,howMany){var node=indexStartNode(binding,index);var i=0;var parent=binding.start.parentNode;while(node){var nextNode=node.nextSibling;parent.removeChild(node);emitRemoved(context,node,binding);if(node.$bindEnd&&node.$bindEnd.itemFor===binding.start){if(howMany===++i)return}node=nextNode}};EachBlock.prototype.move=function(context,binding,from,to,howMany){var node=indexStartNode(binding,from);var fragment=document.createDocumentFragment();var i=0;while(node){var nextNode=node.nextSibling;fragment.appendChild(node);if(node.$bindEnd&&node.$bindEnd.itemFor===binding.start){if(howMany===++i)break}node=nextNode}node=indexStartNode(binding,to);binding.start.parentNode.insertBefore(fragment,node||null)};EachBlock.prototype.type="EachBlock";EachBlock.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.content,this.elseContent)};function indexStartNode(binding,index){var node=binding.start;var i=0;while(node=node.nextSibling){if(node===binding.end)return node;if(node.$bindStart&&node.$bindStart.itemFor===binding.start){if(index===i)return node;i++}}}function updateRange(context,binding,template,start,end,itemFor){if(binding){binding.start=start;binding.end=end;setNodeProperty(start,"$bindStart",binding);setNodeProperty(end,"$bindEnd",binding)}else{context.addBinding(new RangeBinding(template,context,start,end,itemFor))}}function appendContent(parent,content,context){for(var i=0,len=content.length;i<len;i++){content[i].appendTo(parent,context)}}function attachContent(parent,node,content,context){for(var i=0,len=content.length;i<len;i++){node=content[i].attachTo(parent,node,context)}return node}function contentHtml(content,context,unescaped){var html="";for(var i=0,len=content.length;i<len;i++){html+=content[i].get(context,unescaped)}return html}function replaceRange(context,start,end,fragment,binding){var parent=start.parentNode;if(!parent)return;if(start===end){parent.replaceChild(fragment,start);emitRemoved(context,start,binding);return}var node=start;var nextNode;while(node){nextNode=node.nextSibling;emitRemoved(context,node,binding);parent.removeChild(node);if(node===end)break;node=nextNode}parent.insertBefore(fragment,nextNode||null)}function emitRemoved(context,node,ignore){var binding=node.$bindNode;if(binding&&binding!==ignore)context.removeBinding(binding);binding=node.$bindStart;if(binding&&binding!==ignore)context.removeBinding(binding);var attributes=node.$bindAttributes;if(attributes){for(var key in attributes){context.removeBinding(attributes[key])}}for(node=node.firstChild;node;node=node.nextSibling){emitRemoved(context,node,ignore)}}function attachError(parent,node){if(typeof console!=="undefined"){console.error("Attach failed for",node,"within",parent)}return new Error("Attaching bindings failed, because HTML structure "+"does not match client rendering.")}function Binding(){this.meta=null}Binding.prototype.type="Binding";Binding.prototype.update=function(){this.template.update(this.context,this)};Binding.prototype.insert=function(){this.update()};Binding.prototype.remove=function(){this.update()};Binding.prototype.move=function(){this.update()};function NodeBinding(template,context,node){this.template=template;this.context=context;this.node=node;this.meta=null;setNodeProperty(node,"$bindNode",this)}NodeBinding.prototype=new Binding;NodeBinding.prototype.type="NodeBinding";function AttributeBindingsMap(){}function AttributeBinding(template,context,element,name){this.template=template;this.context=context;this.element=element;this.name=name;this.meta=null;var map=element.$bindAttributes||(element.$bindAttributes=new AttributeBindingsMap);map[name]=this}AttributeBinding.prototype=new Binding;AttributeBinding.prototype.type="AttributeBinding";function RangeBinding(template,context,start,end,itemFor){this.template=template;this.context=context;this.start=start;this.end=end;this.itemFor=itemFor;this.meta=null;setNodeProperty(start,"$bindStart",this);setNodeProperty(end,"$bindEnd",this)}RangeBinding.prototype=new Binding;RangeBinding.prototype.type="RangeBinding";RangeBinding.prototype.insert=function(index,howMany){if(this.template.insert){this.template.insert(this.context,this,index,howMany)}else{this.template.update(this.context,this)}};RangeBinding.prototype.remove=function(index,howMany){if(this.template.remove){this.template.remove(this.context,this,index,howMany)}else{this.template.update(this.context,this)}};RangeBinding.prototype.move=function(from,to,howMany){if(this.template.move){this.template.move(this.context,this,from,to,howMany)}else{this.template.update(this.context,this)}};function noop(){}function mergeInto(from,to){for(var key in from){to[key]=from[key]}}function escapeHtml(string){string=string+"";return string.replace(/[&<]/g,function(match){return match==="&"?"&amp;":"&lt;"})}function escapeAttribute(string){string=string+"";return string.replace(/[&"]/g,function(match){return match==="&"?"&amp;":"&quot;"})}if(!Array.isArray){Array.isArray=function(value){return Object.prototype.toString.call(value)==="[object Array]"}}function splitData(node,index){var newNode=node.cloneNode(false);newNode.deleteData(0,index);node.deleteData(index,node.length-index);node.parentNode.insertBefore(newNode,node.nextSibling||null);return newNode}function setNodeProperty(node,key,value){return node[key]=value}(function(){if(typeof document==="undefined")return;var input=document.createElement("input");input.defaultValue="x";if(input.value!=="x"){CREATE_PROPERTIES.value="value"}try{document.createTextNode("").$try=0}catch(err){setNodeProperty=function(node,key,value){if(node.nodeType===3){var proxyNode;if(key==="$bindEnd"){proxyNode=node.nextSibling;if(!proxyNode||proxyNode.$bindProxy!==node){proxyNode=document.createComment("proxy");proxyNode.$bindProxy=node;node.parentNode.insertBefore(proxyNode,node.nextSibling||null)}}else{proxyNode=node.previousSibling;if(!proxyNode||proxyNode.$bindProxy!==node){proxyNode=document.createComment("proxy");proxyNode.$bindProxy=node;node.parentNode.insertBefore(proxyNode,node||null)}}return proxyNode[key]=value}return node[key]=value}}})()},{"serialize-object":39}],39:[function(require,module,exports){exports.instance=serializeInstance;exports.args=serializeArgs;exports.value=serializeValue;function serializeInstance(instance){var args=Array.prototype.slice.call(arguments,1);return"new "+instance.module+"."+instance.type+"("+serializeArgs(args)+")"}function serializeArgs(args){var items=[];for(var i=args.length;i--;){var item=serializeValue(args[i]);items.unshift(item)}for(var i=items.length;i--;){var item=items[i];if(item!=="void 0"&&item!=="null")break;items.pop()}return items.join(", ")}function serializeValue(input){if(input&&input.serialize){return input.serialize()}else if(typeof input==="undefined"){return"void 0"}else if(input===null){return"null"}else if(typeof input==="string"){return formatString(input)}else if(typeof input==="number"||typeof input==="boolean"){return input+""}else if(Array.isArray(input)){var items=[];for(var i=0;i<input.length;i++){var value=serializeValue(input[i]);items.push(value)}return"["+items.join(", ")+"]"}else if(typeof input==="object"){var items=[];for(var key in input){var value=serializeValue(input[key]);items.push(formatString(key)+": "+value)}return"{"+items.join(", ")+"}"}}function formatString(value){var escaped=value.replace(/['\r\n\\]/g,function(match){return match==="'"?"\\'":match==="\r"?"\\r":match==="\n"?"\\n":match==="\\"?"\\\\":""});return"'"+escaped+"'"}},{}],40:[function(require,module,exports){var parse=require("./parse");module.exports={parse:parse,unescapeEntities:unescapeEntities,isConditionalComment:isConditionalComment,trimLeading:trimLeading,trimText:trimText,trimTag:trimTag,minify:minify};var replaceEntity;if(typeof document!=="undefined"){var entityContainer=document.createElement("div");replaceEntity=function(match){entityContainer.innerHTML=match;return entityContainer.textContent||entityContainer.innerText}}else{var _require=require;var entities=_require("./entities.json");replaceEntity=function(match){var named=entities[match];if(named)return named.characters;if(match.charAt(1)!=="#"){throw new Error("Unrecognized character reference: "+match)}var charCode=match.charAt(2)==="x"||match.charAt(2)==="X"?parseInt(match.slice(3,-1),16):parseInt(match.slice(2,-1),10);return String.fromCharCode(charCode)}}function unescapeEntities(html){return html.replace(/&#?[A-Za-z0-9]+;/g,replaceEntity)}function isConditionalComment(tag){return/(?:^<!--\[)|(?:\]-->$)/.test(tag)}function trimLeading(text){return text?text.replace(/\r?\n\s*/g,""):""}function trimText(text){return text?text.replace(/\s*\r?\n\s*/g,""):""}function trimTag(tag){return tag.replace(/(?:\s*\r?\n\s*)+/g,"\n")}function minify(html){var minified="",minifyContent=true;parse(html,{start:function(tag,tagName,attrs){minifyContent=!("x-no-minify"in attrs);minified+=trimTag(tag)},end:function(tag){minified+=trimTag(tag)},text:function(text){minified+=minifyContent?trimText(text):text},comment:function(tag){if(isConditionalComment(tag))minified+=tag},other:function(tag){minified+=tag}});return minified}},{"./parse":41}],41:[function(require,module,exports){var startTag=/^<([^\s=\/!>]+)((?:\s+[^\s=\/>]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+)?)?)*)\s*(\/?)\s*>/,endTag=/^<\/([^\s=\/!>]+)[^>]*>/,comment=/^<!--([\s\S]*?)-->/,commentInside=/<!--[\s\S]*?-->/,other=/^<([\s\S]*?)>/,attr=/([^\s=]+)(?:\s*(=)\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+))?)?/g,rawTagsDefault=/^(style|script)$/i;function empty(){}function matchEndDefault(tagName){return new RegExp("</"+tagName,"i")}function onStartTag(html,match,handler){var attrs={},tag=match[0],tagName=match[1],remainder=match[2],selfClosing=!!match[3];html=html.slice(tag.length);remainder.replace(attr,function(match,name,equals,attr0,attr1,attr2){attrs[name]=attr0||attr1||attr2||(equals?"":true)});handler(tag,tagName,attrs,selfClosing,html);return html}function onTag(html,match,handler){var tag=match[0],data=match[1];html=html.slice(tag.length);handler(tag,data,html);return html}function onText(html,index,isRawText,handler){var text;if(~index){text=html.slice(0,index);html=html.slice(index)}else{text=html;html=""}if(text)handler(text,isRawText,html);return html}function rawEnd(html,ending,offset){offset||(offset=0);var index=html.search(ending),commentMatch=html.match(commentInside),commentEnd;if(commentMatch&&commentMatch.index<index){commentEnd=commentMatch.index+commentMatch[0].length;offset+=commentEnd;html=html.slice(commentEnd);return rawEnd(html,ending,offset)}return index+offset}module.exports=function(html,options){if(options==null)options={};if(!html)return;var startHandler=options.start||empty,endHandler=options.end||empty,textHandler=options.text||empty,commentHandler=options.comment||empty,otherHandler=options.other||empty,matchEnd=options.matchEnd||matchEndDefault,errorHandler=options.error,rawTags=options.rawTags||rawTagsDefault,index,last,match,tagName,err;while(html){if(html===last){err=new Error("HTML parse error: "+html);if(errorHandler){errorHandler(err)}else{throw err}}last=html;if(html[0]==="<"){if(match=html.match(startTag)){html=onStartTag(html,match,startHandler);tagName=match[1];if(rawTags.test(tagName)){index=rawEnd(html,matchEnd(tagName));html=onText(html,index,true,textHandler)}continue}if(match=html.match(endTag)){match[1]=match[1];html=onTag(html,match,endHandler);continue}if(match=html.match(comment)){html=onTag(html,match,commentHandler);continue}if(match=html.match(other)){html=onTag(html,match,otherHandler);continue}}index=html.indexOf("<");html=onText(html,index,false,textHandler)}}},{}],42:[function(require,module,exports){module.exports=Doc;function Doc(model,collectionName,id){this.collectionName=collectionName;this.id=id;this.collectionData=model&&model.data[collectionName]
}Doc.prototype.path=function(segments){return this.collectionName+"."+this.id+"."+segments.join(".")};Doc.prototype._errorMessage=function(description,segments,value){return description+" at "+this.path(segments)+": "+JSON.stringify(value,null,2)}},{}],43:[function(require,module,exports){var Doc=require("./Doc");var util=require("../util");module.exports=LocalDoc;function LocalDoc(model,collectionName,id,snapshot){Doc.call(this,model,collectionName,id);this.snapshot=snapshot;this._updateCollectionData()}LocalDoc.prototype=new Doc;LocalDoc.prototype._updateCollectionData=function(){this.collectionData[this.id]=this.snapshot};LocalDoc.prototype.set=function(segments,value,cb){function set(node,key){var previous=node[key];node[key]=value;return previous}return this._apply(segments,set,cb)};LocalDoc.prototype.del=function(segments,cb){var previous=this.get(segments);if(previous===void 0){cb();return}function del(node,key){delete node[key];return previous}return this._apply(segments,del,cb)};LocalDoc.prototype.increment=function(segments,byNumber,cb){var self=this;function validate(value){if(typeof value==="number"||value==null)return;return new TypeError(self._errorMessage("increment on non-number",segments,value))}function increment(node,key){var value=(node[key]||0)+byNumber;node[key]=value;return value}return this._validatedApply(segments,validate,increment,cb)};LocalDoc.prototype.push=function(segments,value,cb){function push(arr){return arr.push(value)}return this._arrayApply(segments,push,cb)};LocalDoc.prototype.unshift=function(segments,value,cb){function unshift(arr){return arr.unshift(value)}return this._arrayApply(segments,unshift,cb)};LocalDoc.prototype.insert=function(segments,index,values,cb){function insert(arr){arr.splice.apply(arr,[index,0].concat(values));return arr.length}return this._arrayApply(segments,insert,cb)};LocalDoc.prototype.pop=function(segments,cb){function pop(arr){return arr.pop()}return this._arrayApply(segments,pop,cb)};LocalDoc.prototype.shift=function(segments,cb){function shift(arr){return arr.shift()}return this._arrayApply(segments,shift,cb)};LocalDoc.prototype.remove=function(segments,index,howMany,cb){function remove(arr){return arr.splice(index,howMany)}return this._arrayApply(segments,remove,cb)};LocalDoc.prototype.move=function(segments,from,to,howMany,cb){function move(arr){var values=arr.splice(from,howMany);arr.splice.apply(arr,[to,0].concat(values));return values}return this._arrayApply(segments,move,cb)};LocalDoc.prototype.stringInsert=function(segments,index,value,cb){var self=this;function validate(value){if(typeof value==="string"||value==null)return;return new TypeError(self._errorMessage("stringInsert on non-string",segments,value))}function stringInsert(node,key){var previous=node[key];if(previous==null){node[key]=value;return previous}node[key]=previous.slice(0,index)+value+previous.slice(index);return previous}return this._validatedApply(segments,validate,stringInsert,cb)};LocalDoc.prototype.stringRemove=function(segments,index,howMany,cb){var self=this;function validate(value){if(typeof value==="string"||value==null)return;return new TypeError(self._errorMessage("stringRemove on non-string",segments,value))}function stringRemove(node,key){var previous=node[key];if(previous==null)return previous;if(index<0)index+=previous.length;node[key]=previous.slice(0,index)+previous.slice(index+howMany);return previous}return this._validatedApply(segments,validate,stringRemove,cb)};LocalDoc.prototype.get=function(segments){return util.lookup(segments,this.snapshot)};LocalDoc.prototype._createImplied=function(segments,fn){var node=this;var key="snapshot";var i=0;var nextKey=segments[i++];while(nextKey!=null){node=node[key]||(node[key]=/^\d+$/.test(nextKey)?[]:{});key=nextKey;nextKey=segments[i++]}return fn(node,key)};LocalDoc.prototype._apply=function(segments,fn,cb){var out=this._createImplied(segments,fn);this._updateCollectionData();cb();return out};LocalDoc.prototype._validatedApply=function(segments,validate,fn,cb){var out=this._createImplied(segments,function(node,key){var err=validate(node[key]);if(err)return cb(err);return fn(node,key)});this._updateCollectionData();cb();return out};LocalDoc.prototype._arrayApply=function(segments,fn,cb){var arr=this._createImplied(segments,nodeCreateArray);if(!Array.isArray(arr)){var message=this._errorMessage(fn.name+" on non-array",segments,arr);var err=new TypeError(message);return cb(err)}var out=fn(arr);this._updateCollectionData();cb();return out};function nodeCreateArray(node,key){return node[key]||(node[key]=[])}},{"../util":56,"./Doc":42}],44:[function(require,module,exports){var uuid=require("node-uuid");Model.INITS=[];module.exports=Model;function Model(options){this.root=this;var inits=Model.INITS;options||(options={});for(var i=0;i<inits.length;i++){inits[i](this,options)}}Model.prototype.id=function(){return uuid.v4()};Model.prototype._child=function(){return new ChildModel(this)};function ChildModel(model){this.root=model.root;this._events=model._events;this._maxListeners=model._maxListeners;this._context=model._context;this._at=model._at;this._pass=model._pass;this._silent=model._silent}ChildModel.prototype=new Model},{"node-uuid":59}],45:[function(require,module,exports){module.exports=require("./Model");require("./events");require("./paths");require("./collections");require("./mutators");require("./setDiff");require("./fn");require("./filter");require("./refList");require("./ref")},{"./Model":44,"./collections":46,"./events":48,"./filter":49,"./fn":50,"./mutators":51,"./paths":52,"./ref":53,"./refList":54,"./setDiff":55}],46:[function(require,module,exports){var Model=require("./Model");var LocalDoc=require("./LocalDoc");var util=require("../util");function CollectionMap(){}function ModelData(){}function DocMap(){}function CollectionData(){}Model.INITS.push(function(model){model.root.collections=new CollectionMap;model.root.data=new ModelData});Model.prototype.getCollection=function(collectionName){return this.root.collections[collectionName]};Model.prototype.getDoc=function(collectionName,id){var collection=this.root.collections[collectionName];return collection&&collection.docs[id]};Model.prototype.get=function(subpath){var segments=this._splitPath(subpath);return this._get(segments)};Model.prototype._get=function(segments){return util.lookup(segments,this.root.data)};Model.prototype.getCopy=function(subpath){var segments=this._splitPath(subpath);return this._getCopy(segments)};Model.prototype._getCopy=function(segments){var value=this._get(segments);return util.copy(value)};Model.prototype.getDeepCopy=function(subpath){var segments=this._splitPath(subpath);return this._getDeepCopy(segments)};Model.prototype._getDeepCopy=function(segments){var value=this._get(segments);return util.deepCopy(value)};Model.prototype.getOrCreateCollection=function(name){var collection=this.root.collections[name];if(collection)return collection;var Doc=this._getDocConstructor(name);collection=new Collection(this.root,name,Doc);this.root.collections[name]=collection;return collection};Model.prototype._getDocConstructor=function(){return LocalDoc};Model.prototype.getOrCreateDoc=function(collectionName,id,data){var collection=this.getOrCreateCollection(collectionName);return collection.docs[id]||collection.add(id,data)};Model.prototype.destroy=function(subpath){var segments=this._splitPath(subpath);var collections=this.root.collections;if(segments.length===0){for(var collectionName in collections){var collection=collections[collectionName];collection&&collection.destroy()}}else if(segments.length===1){var collection=collections[segments[0]];collection&&collection.destroy()}else{this.silent()._del(segments)}this.removeAllRefs(subpath);this.stopAll(subpath);this.removeAllFilters(subpath);this.removeAllListeners(null,subpath)};function Collection(model,name,Doc){this.model=model;this.name=name;this.Doc=Doc;this.docs=new DocMap;this.data=model.data[name]=new CollectionData}Collection.prototype.add=function(id,data){var doc=new this.Doc(this.model,this.name,id,data);this.docs[id]=doc;return doc};Collection.prototype.destroy=function(){delete this.model.collections[this.name];delete this.model.data[this.name]};Collection.prototype.remove=function(id){delete this.docs[id];delete this.data[id];if(noKeys(this.docs))this.destroy()};Collection.prototype.get=function(){return this.data};function noKeys(object){for(var key in object){return false}return true}},{"../util":56,"./LocalDoc":43,"./Model":44}],47:[function(require,module,exports){var defaultFns=module.exports=new DefaultFns;defaultFns.reverse=new FnPair(getReverse,setReverse);defaultFns.asc=asc;defaultFns.desc=desc;function DefaultFns(){}function FnPair(get,set){this.get=get;this.set=set}function getReverse(array){return array&&array.slice().reverse()}function setReverse(values){return{0:getReverse(values)}}function asc(a,b){if(a<b)return-1;if(a>b)return 1;return 0}function desc(a,b){if(a>b)return-1;if(a<b)return 1;return 0}},{}],48:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var util=require("../util");var Model=require("./Model");Model.MUTATOR_EVENTS={change:true,insert:true,remove:true,move:true,stringInsert:true,stringRemove:true,load:true,unload:true};Model.INITS.push(function(model){EventEmitter.call(this);model.setMaxListeners(0);model.root._defaultCallback=defaultCallback;function defaultCallback(err){if(typeof err==="string")err=new Error(err);if(err)model.emit("error",err)}model.root._mutatorEventQueue=null;model._pass=new Passed({},{})});util.mergeInto(Model.prototype,EventEmitter.prototype);Model.prototype.wrapCallback=function(cb){if(!cb)return this.root._defaultCallback;var model=this;return function wrappedCallback(){try{return cb.apply(this,arguments)}catch(err){model.emit("error",err)}}};Model.prototype._emit=EventEmitter.prototype.emit;Model.prototype.emit=function(type){if(type==="error"){return this._emit.apply(this,arguments)}try{if(Model.MUTATOR_EVENTS[type]){if(this._silent)return this;var segments=arguments[1];var eventArgs=arguments[2];if(this.root._mutatorEventQueue){this.root._mutatorEventQueue.push([type,segments,eventArgs]);return this}this.root._mutatorEventQueue=[];this._emit(type,segments,eventArgs);this._emit("all",segments,[type].concat(eventArgs));while(this.root._mutatorEventQueue.length){var queued=this.root._mutatorEventQueue.shift();type=queued[0];segments=queued[1];eventArgs=queued[2];this._emit(type,segments,eventArgs);this._emit("all",segments,[type].concat(eventArgs))}this.root._mutatorEventQueue=null;return this}return this._emit.apply(this,arguments)}catch(err){this.emit("error",err)}};Model.prototype._on=EventEmitter.prototype.on;Model.prototype.addListener=Model.prototype.on=function(type,pattern,cb){var listener=eventListener(this,pattern,cb);this._on(type,listener);return listener};Model.prototype.once=function(type,pattern,cb){var listener=eventListener(this,pattern,cb);function g(){var matches=listener.apply(null,arguments);if(matches)this.removeListener(type,g)}this._on(type,g);return g};Model.prototype._removeAllListeners=EventEmitter.prototype.removeAllListeners;Model.prototype.removeAllListeners=function(type,subpattern){if(!this._events)return this;if(!type){for(var key in this._events){this.removeAllListeners(key,subpattern)}return this}var pattern=this.path(subpattern);if(!pattern){if(arguments.length===0){return this._removeAllListeners()}else{return this._removeAllListeners(type)}}var listeners=this.listeners(type);var segments=pattern.split(".");for(var i=listeners.length;i--;){var listener=listeners[i];if(patternContained(pattern,segments,listener)){this.removeListener(type,listener)}}};function patternContained(pattern,segments,listener){var listenerSegments=listener.patternSegments;if(!listenerSegments)return false;if(pattern===listener.pattern||pattern==="**")return true;var len=segments.length;if(len>listenerSegments.length)return false;for(var i=0;i<len;i++){if(segments[i]!==listenerSegments[i])return false}return true}Model.prototype.pass=function(object,invert){var model=this._child();model._pass=invert?new Passed(object,this._pass):new Passed(this._pass,object);return model};function Passed(previous,value){for(var key in previous){this[key]=previous[key]}for(var key in value){this[key]=value[key]}}Model.prototype.silent=function(value){var model=this._child();model._silent=value==null?true:value;return model};function eventListener(model,subpattern,cb){if(cb){var pattern=model.path(subpattern);return modelEventListener(pattern,cb)}var path=model.path();cb=arguments[1];if(path)return modelEventListener(path,cb);return cb}function modelEventListener(pattern,cb){var patternSegments=util.castSegments(pattern.split("."));var testFn=testPatternFn(pattern,patternSegments);function modelListener(segments,eventArgs){var captures=testFn(segments);if(!captures)return;var args=captures.length?captures.concat(eventArgs):eventArgs;cb.apply(null,args);return true}modelListener.pattern=pattern;modelListener.patternSegments=patternSegments;return modelListener}function testPatternFn(pattern,patternSegments){if(pattern==="**"){return function testPattern(segments){return[segments.join(".")]}}var endingRest=stripRestWildcard(patternSegments);return function testPattern(segments){var patternLen=patternSegments.length;if(patternLen>segments.length)return;if(patternLen===segments.length||endingRest){var captures=[];for(var i=0;i<patternLen;i++){var patternSegment=patternSegments[i];var segment=segments[i];if(patternSegment==="*"||patternSegment==="**"){captures.push(segment);continue}if(patternSegment!==segment)return}if(endingRest){var remainder=segments.slice(i).join(".");captures.push(remainder)}return captures}}}function stripRestWildcard(segments){var lastIndex=segments.length-1;if(segments[lastIndex]==="**"){segments.pop();return true}var match=/^([^\*]+)\*\*$/.exec(segments[lastIndex]);if(!match)return false;segments[lastIndex]=match[1];return true}},{"../util":56,"./Model":44,events:11}],49:[function(require,module,exports){var util=require("../util");var Model=require("./Model");var defaultFns=require("./defaultFns");Model.INITS.push(function(model){model.root._filters=new Filters(model);model.on("all",filterListener);function filterListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];var map=model.root._filters.fromMap;for(var path in map){var filter=map[path];if(pass.$filter===filter)continue;if(util.mayImpact(filter.inputSegments,segments)){filter.update(pass)}}}});Model.prototype.filter=function(){var input,options,fn;if(arguments.length===1){fn=arguments[0]}else if(arguments.length===2){if(this.isPath(arguments[0])){input=arguments[0]}else{options=arguments[0]}fn=arguments[1]}else{input=arguments[0];options=arguments[1];fn=arguments[2]}var inputPath=this.path(input);return this.root._filters.add(inputPath,fn,null,options)};Model.prototype.sort=function(){var input,options,fn;if(arguments.length===1){fn=arguments[0]}else if(arguments.length===2){if(this.isPath(arguments[0])){input=arguments[0]}else{options=arguments[0]}fn=arguments[1]}else{input=arguments[0];options=arguments[1];fn=arguments[2]}if(!fn)throw new TypeError("Sort function is required");var inputPath=this.path(input);return this.root._filters.add(inputPath,null,fn,options)};Model.prototype.removeAllFilters=function(subpath){var segments=this._splitPath(subpath);var filters=this.root._filters.fromMap;for(var from in filters){if(util.contains(segments,filters[from].fromSegments)){filters[from].destroy()}}};function FromMap(){}function Filters(model){this.model=model;this.fromMap=new FromMap}Filters.prototype.add=function(inputPath,filterFn,sortFn,options){return new Filter(this,inputPath,filterFn,sortFn,options)};Filters.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var filter=this.fromMap[from];if(!filter.bundle)continue;var args=[from,filter.inputPath,filter.filterName,filter.sortName];if(filter.options)args.push(filter.options);out.push(args)}return out};function Filter(filters,inputPath,filterFn,sortFn,options){this.filters=filters;this.model=filters.model.pass({$filter:this});this.inputPath=inputPath;this.inputSegments=inputPath.split(".");this.filterName=null;this.sortName=null;this.bundle=true;this.filterFn=null;this.sortFn=null;this.options=options;this.skip=options&&options.skip;this.limit=options&&options.limit;if(filterFn)this.filter(filterFn);if(sortFn)this.sort(sortFn);this.idsSegments=null;this.from=null;this.fromSegments=null}Filter.prototype.filter=function(fn){if(typeof fn==="function"){this.filterFn=fn;this.bundle=false;return this}else if(typeof fn==="string"){this.filterName=fn;this.filterFn=this.model.root._namedFns[fn]||defaultFns[fn];if(!this.filterFn){throw new TypeError("Filter function not found: "+fn)}}return this};Filter.prototype.sort=function(fn){if(!fn)fn="asc";if(typeof fn==="function"){this.sortFn=fn;this.bundle=false;return this}else if(typeof fn==="string"){this.sortName=fn;this.sortFn=this.model.root._namedFns[fn]||defaultFns[fn];if(!this.sortFn){throw new TypeError("Sort function not found: "+fn)}}return this};Filter.prototype._slice=function(results){if(this.skip==null&&this.limit==null)return results;var begin=this.skip||0;var end;if(this.limit)end=begin+this.limit;return results.slice(begin,end)};Filter.prototype.ids=function(){try{var items=this.model._get(this.inputSegments);var ids=[];if(!items)return ids;if(Array.isArray(items)){if(this.filterFn){for(var i=0;i<items.length;i++){if(this.filterFn.call(this.model,items[i],i,items)){ids.push(i)}}}else{for(var i=0;i<items.length;i++)ids.push(i)}}else{if(this.filterFn){for(var key in items){if(items.hasOwnProperty(key)&&this.filterFn.call(this.model,items[key],key,items)){ids.push(key)}}}else{ids=Object.keys(items)}}var sortFn=this.sortFn;if(sortFn){ids.sort(function(a,b){return sortFn(items[a],items[b])})}return this._slice(ids)}catch(err){this.model.emit("error",err)}};Filter.prototype.get=function(){try{var items=this.model._get(this.inputSegments);var results=[];if(Array.isArray(items)){if(this.filterFn){for(var i=0;i<items.length;i++){if(this.filterFn.call(this.model,items[i],i,items)){results.push(items[i])}}}else{results=items.slice()}}else{if(this.filterFn){for(var key in items){if(items.hasOwnProperty(key)&&this.filterFn.call(this.model,items[key],key,items)){results.push(items[key])}}}else{for(var key in items){if(items.hasOwnProperty(key)){results.push(items[key])}}}}if(this.sortFn)results.sort(this.sortFn);return this._slice(results)}catch(err){this.model.emit("error",err)}};Filter.prototype.update=function(pass){var ids=this.ids();this.model.pass(pass,true)._setArrayDiff(this.idsSegments,ids)};Filter.prototype.ref=function(from){from=this.model.path(from);this.from=from;this.fromSegments=from.split(".");this.filters.fromMap[from]=this;this.idsSegments=["$filters",from.replace(/\./g,"|")];this.update();return this.model.refList(from,this.inputPath,this.idsSegments.join("."))};Filter.prototype.destroy=function(){delete this.filters.fromMap[this.from];this.model.removeRefList(this.from);this.model._del(this.idsSegments)}},{"../util":56,"./Model":44,"./defaultFns":47}],50:[function(require,module,exports){var util=require("../util");var Model=require("./Model");var defaultFns=require("./defaultFns");function NamedFns(){}Model.INITS.push(function(model){model.root._namedFns=new NamedFns;model.root._fns=new Fns(model);model.on("all",fnListener);function fnListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];var map=model.root._fns.fromMap;for(var path in map){var fn=map[path];if(pass.$fn===fn)continue;if(util.mayImpactAny(fn.inputsSegments,segments)){fn.onInput(pass)}else if(util.mayImpact(fn.fromSegments,segments)){fn.onOutput(pass)}}}});Model.prototype.fn=function(name,fns){this.root._namedFns[name]=fns};function parseStartArguments(model,args,hasPath){var last=args.pop();var fns,name;if(typeof last==="string"){name=last}else{fns=last}var path;if(hasPath){path=model.path(args.shift())}var i=args.length-1;var options;if(model.isPath(args[i])){args[i]=model.path(args[i])}else{options=args.pop()}while(i--){args[i]=model.path(args[i])}return{name:name,path:path,inputPaths:args,fns:fns,options:options}}Model.prototype.evaluate=function(){var args=Array.prototype.slice.call(arguments);var parsed=parseStartArguments(this,args,false);return this.root._fns.get(parsed.name,parsed.inputPaths,parsed.fns,parsed.options)};Model.prototype.start=function(){var args=Array.prototype.slice.call(arguments);var parsed=parseStartArguments(this,args,true);return this.root._fns.start(parsed.name,parsed.path,parsed.inputPaths,parsed.fns,parsed.options)};Model.prototype.stop=function(subpath){var path=this.path(subpath);this.root._fns.stop(path)};Model.prototype.stopAll=function(subpath){var segments=this._splitPath(subpath);var fns=this.root._fns.fromMap;for(var from in fns){if(util.contains(segments,fns[from].fromSegments)){this.stop(from)}}};function FromMap(){}function Fns(model){this.model=model;this.nameMap=model.root._namedFns;this.fromMap=new FromMap}Fns.prototype.get=function(name,inputPaths,fns,options){fns||(fns=this.nameMap[name]||defaultFns[name]);var fn=new Fn(this.model,name,null,inputPaths,fns,options);return fn.get()};Fns.prototype.start=function(name,path,inputPaths,fns,options){fns||(fns=this.nameMap[name]||defaultFns[name]);var fn=new Fn(this.model,name,path,inputPaths,fns,options);this.fromMap[path]=fn;return fn.onInput()};Fns.prototype.stop=function(path){var fn=this.fromMap[path];delete this.fromMap[path];return fn};Fns.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var fn=this.fromMap[from];if(!fn.name)continue;var args=[fn.from].concat(fn.inputPaths,fn.name);if(fn.options)args.push(fn.options);out.push(args)}return out};function Fn(model,name,from,inputPaths,fns,options){this.model=model.pass({$fn:this});this.name=name;this.from=from;this.inputPaths=inputPaths;this.options=options;if(!fns){var err=new TypeError("Model function not found: "+name);model.emit("error",err)}this.getFn=fns.get||fns;this.setFn=fns.set;this.fromSegments=from&&from.split(".");this.inputsSegments=[];for(var i=0;i<this.inputPaths.length;i++){var segments=this.inputPaths[i].split(".");this.inputsSegments.push(segments)}var copy=options&&options.copy||"output";this.copyInput=copy==="input"||copy==="both";this.copyOutput=copy==="output"||copy==="both";var equal=options&&options.equal==="strict"?util.equal:util.deepEqual;this.diffOptions={equal:equal};this.mode=options&&options.mode||"diff"}Fn.prototype.apply=function(fn,inputs){for(var i=0,len=this.inputsSegments.length;i<len;i++){var input=this.model._get(this.inputsSegments[i]);inputs.push(this.copyInput?util.deepCopy(input):input)}try{return fn.apply(this.model,inputs)}catch(err){this.model.emit("error",err)}};Fn.prototype.get=function(){return this.apply(this.getFn,[])};Fn.prototype.set=function(value,pass){if(!this.setFn)return;var out=this.apply(this.setFn,[value]);if(!out)return;var inputsSegments=this.inputsSegments;var model=this.model.pass(pass,true);for(var key in out){var value=this.copyOutput?util.deepCopy(out[key]):out[key];this._setValue(model,inputsSegments[key],value)}};Fn.prototype.onInput=function(pass){var value=this.copyOutput?util.deepCopy(this.get()):this.get();this._setValue(this.model.pass(pass,true),this.fromSegments,value);return value};Fn.prototype.onOutput=function(pass){var value=this.model._get(this.fromSegments);return this.set(value,pass)};Fn.prototype._setValue=function(model,segments,value){if(this.mode==="set"){model._set(segments,value)}else if(this.mode==="array"){model._setArrayDiff(segments,value)}else{model._setDiff(segments,value,this.diffOptions)}}},{"../util":56,"./Model":44,"./defaultFns":47}],51:[function(require,module,exports){var util=require("../util");var Model=require("./Model");Model.prototype._mutate=function(segments,fn,cb){cb=this.wrapCallback(cb);var collectionName=segments[0];var id=segments[1];if(!collectionName||!id){var message=fn.name+" must be performed under a collection "+"and document id. Invalid path: "+segments.join(".");return cb(new Error(message))}var doc=this.getOrCreateDoc(collectionName,id);var docSegments=segments.slice(2);return fn(doc,docSegments,cb)};Model.prototype.set=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else{subpath=arguments[0];value=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._set(segments,value,cb)};Model.prototype._set=function(segments,value,cb){segments=this._dereference(segments);var model=this;function set(doc,docSegments,fnCb){var previous=doc.set(docSegments,value,fnCb);model.emit("change",segments,[value,previous,model._pass]);return previous}return this._mutate(segments,set,cb)};Model.prototype.setEach=function(){var subpath,object,cb;if(arguments.length===1){object=arguments[0]}else if(arguments.length===2){subpath=arguments[0];object=arguments[1]}else{subpath=arguments[0];object=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._setEach(segments,object,cb)};Model.prototype._setEach=function(segments,object,cb){segments=this._dereference(segments);var group=util.asyncGroup(this.wrapCallback(cb));for(var key in object){var value=object[key];this._set(segments.concat(key),value,group())}};Model.prototype.add=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){if(typeof arguments[1]==="function"){value=arguments[0];cb=arguments[1]}else{subpath=arguments[0];value=arguments[1]}}else{subpath=arguments[0];value=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._add(segments,value,cb)};Model.prototype._add=function(segments,value,cb){if(typeof value!=="object"){var message="add requires an object value. Invalid value: "+value;cb=this.wrapCallback(cb);return cb(new Error(message))}var id=value.id||this.id();value.id=id;this._set(segments.concat(id),value,cb);return id};Model.prototype.setNull=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else{subpath=arguments[0];value=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._setNull(segments,value,cb)};Model.prototype._setNull=function(segments,value,cb){segments=this._dereference(segments);var model=this;function setNull(doc,docSegments,fnCb){var previous=doc.get(docSegments);if(previous!=null){fnCb();return previous}doc.set(docSegments,value,fnCb);model.emit("change",segments,[value,previous,model._pass]);return value}return this._mutate(segments,setNull,cb)};Model.prototype.del=function(){var subpath,cb;if(arguments.length===1){if(typeof arguments[0]==="function"){cb=arguments[0]}else{subpath=arguments[0]}}else{subpath=arguments[0];cb=arguments[1]}var segments=this._splitPath(subpath);return this._del(segments,cb)};Model.prototype._del=function(segments,cb){segments=this._dereference(segments);var model=this;function del(doc,docSegments,fnCb){var previous=doc.del(docSegments,fnCb);if(segments.length===2){var collectionName=segments[0];var id=segments[1];model.root.collections[collectionName].remove(id)}model.emit("change",segments,[void 0,previous,model._pass]);return previous}return this._mutate(segments,del,cb)};Model.prototype.increment=function(){var subpath,byNumber,cb;if(arguments.length===1){if(typeof arguments[0]==="function"){cb=arguments[0]}else if(typeof arguments[0]==="number"){byNumber=arguments[0]}else{subpath=arguments[0]}}else if(arguments.length===2){if(typeof arguments[1]==="function"){cb=arguments[1];if(typeof arguments[0]==="number"){byNumber=arguments[0]}else{subpath=arguments[0]}}else{subpath=arguments[0];byNumber=arguments[1]}}else{subpath=arguments[0];byNumber=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._increment(segments,byNumber,cb)};Model.prototype._increment=function(segments,byNumber,cb){segments=this._dereference(segments);if(byNumber==null)byNumber=1;var model=this;function increment(doc,docSegments,fnCb){var value=doc.increment(docSegments,byNumber,fnCb);var previous=value-byNumber;model.emit("change",segments,[value,previous,model._pass]);return value}return this._mutate(segments,increment,cb)};Model.prototype.push=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else{subpath=arguments[0];value=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._push(segments,value,cb)};Model.prototype._push=function(segments,value,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function push(doc,docSegments,fnCb){var length=doc.push(docSegments,value,fnCb);model.emit("insert",segments,[length-1,[value],model._pass]);return length}return this._mutate(segments,push,cb)};Model.prototype.unshift=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else{subpath=arguments[0];value=arguments[1];cb=arguments[2]}var segments=this._splitPath(subpath);return this._unshift(segments,value,cb)};Model.prototype._unshift=function(segments,value,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function unshift(doc,docSegments,fnCb){var length=doc.unshift(docSegments,value,fnCb);model.emit("insert",segments,[0,[value],model._pass]);return length}return this._mutate(segments,unshift,cb)};Model.prototype.insert=function(){var subpath,index,values,cb;if(arguments.length===1){this.emit("error",new Error("Not enough arguments for insert"))}else if(arguments.length===2){index=arguments[0];values=arguments[1]}else if(arguments.length===3){subpath=arguments[0];index=arguments[1];values=arguments[2]}else{subpath=arguments[0];index=arguments[1];values=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._insert(segments,+index,values,cb)};Model.prototype._insert=function(segments,index,values,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function insert(doc,docSegments,fnCb){var inserted=Array.isArray(values)?values:[values];var length=doc.insert(docSegments,index,inserted,fnCb);model.emit("insert",segments,[index,inserted,model._pass]);return length}return this._mutate(segments,insert,cb)};Model.prototype.pop=function(){var subpath,cb;if(arguments.length===1){if(typeof arguments[0]==="function"){cb=arguments[0]}else{subpath=arguments[0]}}else{subpath=arguments[0];cb=arguments[1]}var segments=this._splitPath(subpath);return this._pop(segments,cb)};Model.prototype._pop=function(segments,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function pop(doc,docSegments,fnCb){var arr=doc.get(docSegments);var length=arr&&arr.length;if(!length){fnCb();return}var value=doc.pop(docSegments,fnCb);model.emit("remove",segments,[length-1,[value],model._pass]);return value}return this._mutate(segments,pop,cb)};Model.prototype.shift=function(){var subpath,cb;if(arguments.length===1){if(typeof arguments[0]==="function"){cb=arguments[0]}else{subpath=arguments[0]}}else{subpath=arguments[0];cb=arguments[1]}var segments=this._splitPath(subpath);return this._shift(segments,cb)};Model.prototype._shift=function(segments,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function shift(doc,docSegments,fnCb){var arr=doc.get(docSegments);var length=arr&&arr.length;if(!length){fnCb();return}var value=doc.shift(docSegments,fnCb);model.emit("remove",segments,[0,[value],model._pass]);return value}return this._mutate(segments,shift,cb)
};Model.prototype.remove=function(){var subpath,index,howMany,cb;if(arguments.length===1){index=arguments[0]}else if(arguments.length===2){if(typeof arguments[1]==="function"){cb=arguments[1];if(typeof arguments[0]==="number"){index=arguments[0]}else{subpath=arguments[0]}}else{if(typeof arguments[0]==="number"){index=arguments[0];howMany=arguments[1]}else{subpath=arguments[0];index=arguments[1]}}}else if(arguments.length===3){if(typeof arguments[2]==="function"){cb=arguments[2];if(typeof arguments[0]==="number"){index=arguments[0];howMany=arguments[1]}else{subpath=arguments[0];index=arguments[1]}}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2]}}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);if(index==null)index=segments.pop();return this._remove(segments,+index,howMany,cb)};Model.prototype._remove=function(segments,index,howMany,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);if(howMany==null)howMany=1;var model=this;function remove(doc,docSegments,fnCb){var removed=doc.remove(docSegments,index,howMany,fnCb);model.emit("remove",segments,[index,removed,model._pass]);return removed}return this._mutate(segments,remove,cb)};Model.prototype.move=function(){var subpath,from,to,howMany,cb;if(arguments.length===1){this.emit("error",new Error("Not enough arguments for move"))}else if(arguments.length===2){from=arguments[0];to=arguments[1]}else if(arguments.length===3){if(typeof arguments[2]==="function"){from=arguments[0];to=arguments[1];cb=arguments[2]}else if(typeof arguments[0]==="number"){from=arguments[0];to=arguments[1];howMany=arguments[2]}else{subpath=arguments[0];from=arguments[1];to=arguments[2]}}else if(arguments.length===4){if(typeof arguments[3]==="function"){cb=arguments[3];if(typeof arguments[0]==="number"){from=arguments[0];to=arguments[1];howMany=arguments[2]}else{subpath=arguments[0];from=arguments[1];to=arguments[2]}}else{subpath=arguments[0];from=arguments[1];to=arguments[2];howMany=arguments[3]}}else{subpath=arguments[0];from=arguments[1];to=arguments[2];howMany=arguments[3];cb=arguments[4]}var segments=this._splitPath(subpath);return this._move(segments,from,to,howMany,cb)};Model.prototype._move=function(segments,from,to,howMany,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);if(howMany==null)howMany=1;var model=this;function move(doc,docSegments,fnCb){from=+from;to=+to;if(from<0||to<0){var len=doc.get(docSegments).length;if(from<0)from+=len;if(to<0)to+=len}var moved=doc.move(docSegments,from,to,howMany,fnCb);model.emit("move",segments,[from,to,moved.length,model._pass]);return moved}return this._mutate(segments,move,cb)};Model.prototype.stringInsert=function(){var subpath,index,text,cb;if(arguments.length===1){this.emit("error",new Error("Not enough arguments for stringInsert"))}else if(arguments.length===2){index=arguments[0];text=arguments[1]}else if(arguments.length===3){if(typeof arguments[2]==="function"){index=arguments[0];text=arguments[1];cb=arguments[2]}else{subpath=arguments[0];index=arguments[1];text=arguments[2]}}else{subpath=arguments[0];index=arguments[1];text=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._stringInsert(segments,index,text,cb)};Model.prototype._stringInsert=function(segments,index,text,cb){segments=this._dereference(segments);var model=this;function stringInsert(doc,docSegments,fnCb){var previous=doc.stringInsert(docSegments,index,text,fnCb);var value=doc.get(docSegments);var pass=model.pass({$type:"stringInsert",index:index,text:text})._pass;model.emit("change",segments,[value,previous,pass]);return}return this._mutate(segments,stringInsert,cb)};Model.prototype.stringRemove=function(){var subpath,index,howMany,cb;if(arguments.length===1){this.emit("error",new Error("Not enough arguments for stringRemove"))}else if(arguments.length===2){index=arguments[0];howMany=arguments[1]}else if(arguments.length===3){if(typeof arguments[2]==="function"){index=arguments[0];howMany=arguments[1];cb=arguments[2]}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2]}}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._stringRemove(segments,index,howMany,cb)};Model.prototype._stringRemove=function(segments,index,howMany,cb){segments=this._dereference(segments);var model=this;function stringRemove(doc,docSegments,fnCb){var previous=doc.stringRemove(docSegments,index,howMany,fnCb);var value=doc.get(docSegments);var pass=model.pass({$type:"stringRemove",index:index,howMany:howMany})._pass;model.emit("change",segments,[value,previous,pass]);return}return this._mutate(segments,stringRemove,cb)}},{"../util":56,"./Model":44}],52:[function(require,module,exports){var Model=require("./Model");exports.mixin={};Model.prototype._splitPath=function(subpath){var path=this.path(subpath);return path&&path.split(".")||[]};Model.prototype.path=function(subpath){if(subpath==null||subpath==="")return this._at?this._at:"";if(typeof subpath==="string"||typeof subpath==="number"){return this._at?this._at+"."+subpath:""+subpath}if(typeof subpath.path==="function")return subpath.path()};Model.prototype.isPath=function(subpath){return this.path(subpath)!=null};Model.prototype.scope=function(path){var model=this._child();model._at=path;return model};Model.prototype.at=function(subpath){var path=this.path(subpath);return this.scope(path)};Model.prototype.parent=function(levels){if(levels==null)levels=1;var segments=this._splitPath();var len=Math.max(0,segments.length-levels);var path=segments.slice(0,len).join(".");return this.scope(path)};Model.prototype.leaf=function(path){if(!path)path=this.path();var i=path.lastIndexOf(".");return path.slice(i+1)}},{"./Model":44}],53:[function(require,module,exports){var util=require("../util");var Model=require("./Model");Model.INITS.push(function(model){var root=model.root;root._refs=new Refs(root);addIndexListeners(root);addListener(root,"change",refChange);addListener(root,"load",refLoad);addListener(root,"unload",refUnload);addListener(root,"insert",refInsert);addListener(root,"remove",refRemove);addListener(root,"move",refMove);addListener(root,"stringInsert",refStringInsert);addListener(root,"stringRemove",refStringRemove)});function addIndexListeners(model){model.on("insert",function refInsertIndex(segments,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1].length;function patchInsert(refIndex){return index<=refIndex?refIndex+howMany:refIndex}onIndexChange(segments,patchInsert)});model.on("remove",function refRemoveIndex(segments,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1].length;function patchRemove(refIndex){return index<=refIndex?refIndex-howMany:refIndex}onIndexChange(segments,patchRemove)});model.on("move",function refMoveIndex(segments,eventArgs){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];function patchMove(refIndex){if(from<=refIndex&&refIndex<from+howMany){return refIndex+to-from}if(from<=refIndex)refIndex-=howMany;if(to<=refIndex)refIndex+=howMany;return refIndex}onIndexChange(segments,patchMove)});function onIndexChange(segments,patch){var fromMap=model._refs.fromMap;for(var from in fromMap){var ref=fromMap[from];if(!(ref.updateIndices&&util.contains(segments,ref.toSegments)&&ref.toSegments.length>segments.length))continue;var index=+ref.toSegments[segments.length];var patched=patch(index);if(index===patched)continue;model._refs.remove(from);ref.toSegments[segments.length]=""+patched;ref.to=ref.toSegments.join(".");model._refs._add(ref)}}}function refChange(model,dereferenced,eventArgs){var value=eventArgs[0];model._set(dereferenced,value)}function refLoad(model,dereferenced,eventArgs){var value=eventArgs[0];model._set(dereferenced,value)}function refUnload(model,dereferenced,eventArgs){model._del(dereferenced)}function refInsert(model,dereferenced,eventArgs){var index=eventArgs[0];var values=eventArgs[1];model._insert(dereferenced,index,values)}function refRemove(model,dereferenced,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1].length;model._remove(dereferenced,index,howMany)}function refMove(model,dereferenced,eventArgs){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];model._move(dereferenced,from,to,howMany)}function refStringInsert(model,dereferenced,eventArgs){var index=eventArgs[0];var text=eventArgs[1];model._stringInsert(dereferenced,index,text)}function refStringRemove(model,dereferenced,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1];model._stringRemove(dereferenced,index,howMany)}function addListener(model,type,fn){model.on(type,refListener);function refListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];var toMap=model._refs.toMap;var subpath;for(var i=0,len=segments.length;i<len;i++){subpath=subpath?subpath+"."+segments[i]:segments[i];var refs=toMap[subpath];if(!refs)continue;var remaining=segments.slice(i+1);for(var refIndex=0,numRefs=refs.length;refIndex<numRefs;refIndex++){var ref=refs[refIndex];var dereferenced=ref.fromSegments.concat(remaining);if(model._get(dereferenced)===model._get(segments)){model.emit(type,dereferenced,eventArgs)}else{var setterModel=ref.model.pass(pass,true);setterModel._dereference=noopDereference;fn(setterModel,dereferenced,eventArgs)}}}var parentToMap=model._refs.parentToMap;var refs=parentToMap[subpath];if(!refs)return;for(var refIndex=0,numRefs=refs.length;refIndex<numRefs;refIndex++){var ref=refs[refIndex];var value=model._get(ref.toSegments);var previous=model._get(ref.fromSegments);if(previous!==value){var setterModel=ref.model.pass(pass,true);setterModel._dereference=noopDereference;setterModel._set(ref.fromSegments,value)}}}}Model.prototype._canRefTo=function(value){return this.isPath(value)||value&&typeof value.ref==="function"};Model.prototype.ref=function(){var from,to,options;if(arguments.length===1){to=arguments[0]}else if(arguments.length===2){if(this._canRefTo(arguments[1])){from=arguments[0];to=arguments[1]}else{to=arguments[0];options=arguments[1]}}else{from=arguments[0];to=arguments[1];options=arguments[2]}var fromPath=this.path(from);var toPath=this.path(to);if(!toPath)return to.ref(fromPath);var fromSegments=fromPath.split(".");if(fromSegments.length<2){var message="ref must be performed under a collection "+"and document id. Invalid path: "+fromPath;this.emit("error",new Error(message))}this.root._refs.remove(fromPath);var value=this.get(to);this._set(fromSegments,value);this.root._refs.add(fromPath,toPath,options);return this.scope(fromPath)};Model.prototype.removeRef=function(from){var fromPath=this.path(from);this.root._refs.remove(fromPath);this.del(from)};Model.prototype.removeAllRefs=function(subpath){var segments=this._splitPath(subpath);var refs=this.root._refs.fromMap;var refLists=this.root._refLists.fromMap;for(var from in refs){if(util.contains(segments,refs[from].fromSegments)){this.removeRef(from)}}for(var from in refLists){if(util.contains(segments,refLists[from].fromSegments)){this.removeRefList(from)}}};Model.prototype.dereference=function(subpath){var segments=this._splitPath(subpath);return this._dereference(segments).join(".")};Model.prototype._dereference=function(segments,forArrayMutator,ignore){if(segments.length===0)return segments;var refs=this.root._refs.fromMap;var refLists=this.root._refLists.fromMap;var doAgain;do{var subpath="";doAgain=false;for(var i=0,len=segments.length;i<len;i++){subpath=subpath?subpath+"."+segments[i]:segments[i];var ref=refs[subpath];if(ref){var remaining=segments.slice(i+1);segments=ref.toSegments.concat(remaining);doAgain=true;break}var refList=refLists[subpath];if(refList&&refList!==ignore){var belowDescendant=i+2<len;var belowChild=i+1<len;if(!(belowDescendant||forArrayMutator&&belowChild))continue;segments=refList.dereference(segments,i);doAgain=true;break}}}while(doAgain);if(segments.length===0)return["$null"];return segments};function noopDereference(segments){return segments}function Ref(model,from,to,options){this.model=model&&model.pass({$ref:this});this.from=from;this.to=to;this.fromSegments=from.split(".");this.toSegments=to.split(".");this.parentTos=[];for(var i=1,len=this.toSegments.length;i<len;i++){var parentTo=this.toSegments.slice(0,i).join(".");this.parentTos.push(parentTo)}this.updateIndices=options&&options.updateIndices}function FromMap(){}function ToMap(){}function Refs(model){this.model=model;this.fromMap=new FromMap;this.toMap=new ToMap;this.parentToMap=new ToMap}Refs.prototype.add=function(from,to,options){var ref=new Ref(this.model,from,to,options);return this._add(ref)};Refs.prototype._add=function(ref){this.fromMap[ref.from]=ref;listMapAdd(this.toMap,ref.to,ref);for(var i=0,len=ref.parentTos.length;i<len;i++){listMapAdd(this.parentToMap,ref.parentTos[i],ref)}return ref};Refs.prototype.remove=function(from){var ref=this.fromMap[from];if(!ref)return;delete this.fromMap[from];listMapRemove(this.toMap,ref.to,ref);for(var i=0,len=ref.parentTos.length;i<len;i++){listMapRemove(this.parentToMap,ref.parentTos[i],ref)}return ref};Refs.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var ref=this.fromMap[from];out.push([ref.from,ref.to])}return out};function listMapAdd(map,name,item){map[name]||(map[name]=[]);map[name].push(item)}function listMapRemove(map,name,item){var items=map[name];if(!items)return;var index=items.indexOf(item);if(index===-1)return;items.splice(index,1);if(!items.length)delete map[name]}},{"../util":56,"./Model":44}],54:[function(require,module,exports){var util=require("../util");var Model=require("./Model");Model.INITS.push(function(model){var root=model.root;root._refLists=new RefLists(root);for(var type in Model.MUTATOR_EVENTS){addListener(root,type)}});function addListener(model,type){model.on(type,refListListener);function refListListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];var fromMap=model._refLists.fromMap;for(var from in fromMap){var refList=fromMap[from];if(pass.$refList===refList)continue;refList.onMutation(type,segments,eventArgs)}}}function patchFromEvent(type,segments,eventArgs,refList){var fromLength=refList.fromSegments.length;var segmentsLength=segments.length;var pass=eventArgs[eventArgs.length-1];var model=refList.model.pass(pass,true);if(segmentsLength===fromLength){if(type==="insert"){var index=eventArgs[0];var values=eventArgs[1];var ids=setNewToValues(model,refList,values);model._insert(refList.idsSegments,index,ids);return}if(type==="remove"){var index=eventArgs[0];var howMany=eventArgs[1].length;var ids=model._remove(refList.idsSegments,index,howMany);if(refList.deleteRemoved){for(var i=0;i<ids.length;i++){var item=refList.itemById(ids[i]);model._del(refList.toSegmentsByItem(item))}}return}if(type==="move"){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];model._move(refList.idsSegments,from,to,howMany);return}var values=type==="change"?eventArgs[0]:model._get(refList.fromSegments);if(!values){model._set(refList.idsSegments,[]);return}var ids=setNewToValues(model,refList,values);model._set(refList.idsSegments,ids);return}if(segmentsLength<fromLength){model._setArrayDiff(refList.fromSegments,refList.get());return}var index=segments[fromLength];var value=model._get(refList.fromSegments.concat(index));var toSegments=refList.toSegmentsByItem(value);if(segmentsLength>fromLength+1){var message="Mutation on descendant of refList `from` should have been dereferenced: "+segments.join(".");model.emit("error",new Error(message));return}if(type==="change"){model._set(toSegments,value);updateIdForValue(model,refList,index,value);return}if(type==="stringInsert"){var stringIndex=eventArgs[0];var stringValue=eventArgs[1];model._stringInsert(toSegments,stringIndex,stringValue);updateIdForValue(model,refList,index,value);return}if(type==="stringRemove"){var stringIndex=eventArgs[0];var howMany=eventArgs[1];model._stringRemove(toSegments,stringIndex,howMany);updateIdForValue(model,refList,index,value);return}if(type==="insert"||type==="remove"||type==="move"){var message="Array mutation on child of refList `from` should have been dereferenced: "+segments.join(".");model.emit("error",new Error(message));return}}function setNewToValues(model,refList,values,fn){var ids=[];for(var i=0;i<values.length;i++){var value=values[i];var id=refList.idByItem(value);if(id===void 0&&typeof value==="object"){id=value.id=model.id()}var toSegments=refList.toSegmentsByItem(value);if(id===void 0||toSegments===void 0){var message="Unable to add item to refList: "+value;return model.emit("error",new Error(message))}if(model._get(toSegments)!==value){model._set(toSegments,value)}ids.push(id)}return ids}function updateIdForValue(model,refList,index,value){var id=refList.idByItem(value);var outSegments=refList.idsSegments.concat(index);model._set(outSegments,id)}function patchToEvent(type,segments,eventArgs,refList){var toLength=refList.toSegments.length;var segmentsLength=segments.length;var pass=eventArgs[eventArgs.length-1];var model=refList.model.pass(pass,true);if(segmentsLength===toLength){if(type==="insert"){var insertIndex=eventArgs[0];var values=eventArgs[1];for(var i=0;i<values.length;i++){var value=values[i];var indices=refList.indicesByItem(value);if(!indices)continue;for(var j=0;j<indices.length;j++){var outSegments=refList.fromSegments.concat(indices[j]);model._set(outSegments,value)}}return}if(type==="remove"){var removeIndex=eventArgs[0];var values=eventArgs[1];var howMany=values.length;for(var i=removeIndex,len=removeIndex+howMany;i<len;i++){var indices=refList.indicesByItem(values[i]);if(!indices)continue;for(var j=0,indicesLen=indices.length;j<indicesLen;j++){var outSegments=refList.fromSegments.concat(indices[j]);model._set(outSegments,void 0)}}return}if(type==="move"){return}}if(segmentsLength<=toLength){model._setArrayDiff(refList.fromSegments,refList.get());return}if(segmentsLength>toLength+1){var value=model._get(segments.slice(0,toLength+1));var indices=refList.indicesByItem(value);if(!indices)return;var remaining=segments.slice(toLength+1);for(var i=0;i<indices.length;i++){var index=indices[i];var dereferenced=refList.fromSegments.concat(index,remaining);dereferenced=model._dereference(dereferenced,null,refList);eventArgs=eventArgs.slice();eventArgs[eventArgs.length-1]=model._pass;model.emit(type,dereferenced,eventArgs)}return}if(type==="change"||type==="load"||type==="unload"){var value,previous;if(type==="change"){value=eventArgs[0];previous=eventArgs[1]}else if(type==="load"){value=eventArgs[0];previous=void 0}else if(type==="unload"){value=void 0;previous=eventArgs[0]}var newIndices=refList.indicesByItem(value);var oldIndices=refList.indicesByItem(previous);if(!newIndices&&!oldIndices)return;if(oldIndices&&!equivalentArrays(oldIndices,newIndices)){for(var i=0;i<oldIndices.length;i++){var outSegments=refList.fromSegments.concat(oldIndices[i]);model._set(outSegments,void 0)}}if(newIndices){for(var i=0;i<newIndices.length;i++){var outSegments=refList.fromSegments.concat(newIndices[i]);model._set(outSegments,value)}}return}var value=model._get(segments.slice(0,toLength+1));var indices=refList.indicesByItem(value);if(!indices)return;if(type==="stringInsert"){var stringIndex=eventArgs[0];var value=eventArgs[1];for(var i=0;i<indices.length;i++){var outSegments=refList.fromSegments(indices[i]);model._stringInsert(outSegments,stringIndex,value)}return}if(type==="stringRemove"){var stringIndex=eventArgs[0];var howMany=eventArgs[1];for(var i=0;i<indices.length;i++){var outSegments=refList.fromSegments(indices[i]);model._stringRemove(outSegments,stringIndex,howMany)}return}if(type==="insert"||type==="remove"||type==="move"){for(var i=0;i<indices.length;i++){var dereferenced=refList.fromSegments.concat(indices[i]);dereferenced=model._dereference(dereferenced,null,refList);eventArgs=eventArgs.slice();eventArgs[eventArgs.length-1]=model._pass;model.emit(type,dereferenced,eventArgs)}}}function equivalentArrays(a,b){if(!a||!b)return false;if(a.length!==b.length)return false;for(var i=0;i<a.length;i++){if(a[i]!==b[i])return false}return true}function patchIdsEvent(type,segments,eventArgs,refList){var idsLength=refList.idsSegments.length;var segmentsLength=segments.length;var pass=eventArgs[eventArgs.length-1];var model=refList.model.pass(pass,true);if(segmentsLength===idsLength){if(type==="insert"){var index=eventArgs[0];var inserted=eventArgs[1];var values=[];for(var i=0;i<inserted.length;i++){var value=refList.itemById(inserted[i]);values.push(value)}model._insert(refList.fromSegments,index,values);return}if(type==="remove"){var index=eventArgs[0];var howMany=eventArgs[1].length;model._remove(refList.fromSegments,index,howMany);return}if(type==="move"){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];model._move(refList.fromSegments,from,to,howMany);return}}if(segmentsLength<=idsLength){model._setArrayDiff(refList.fromSegments,refList.get());return}var index=segments[idsLength];var id=refList.idByIndex(index);var item=refList.itemById(id);var itemSegments=refList.fromSegments.concat(index);if(model._get(itemSegments)!==item){model._set(itemSegments,item)}}Model.prototype.refList=function(){var from,to,ids,options;if(arguments.length===2){to=arguments[0];ids=arguments[1]}else if(arguments.length===3){if(this.isPath(arguments[2])){from=arguments[0];to=arguments[1];ids=arguments[2]}else{to=arguments[0];ids=arguments[1];options=arguments[2]}}else{from=arguments[0];to=arguments[1];ids=arguments[2];options=arguments[3]}var fromPath=this.path(from);var toPath;if(Array.isArray(to)){toPath=[];for(var i=0;i<to.length;i++){toPath.push(this.path(to[i]))}}else{toPath=this.path(to)}var idsPath=this.path(ids);var refList=this.root._refLists.add(fromPath,toPath,idsPath,options);this.pass({$refList:refList})._setArrayDiff(refList.fromSegments,refList.get());return this.scope(fromPath)};Model.prototype.removeRefList=function(from){var fromPath=this.path(from);var refList=this.root._refLists.remove(fromPath);if(refList)this._del(refList.fromSegments)};function RefList(model,from,to,ids,options){this.model=model&&model.pass({$refList:this});this.from=from;this.to=to;this.ids=ids;this.fromSegments=from&&from.split(".");this.toSegments=to&&to.split(".");this.idsSegments=ids&&ids.split(".");this.options=options;this.deleteRemoved=options&&options.deleteRemoved}RefList.prototype.get=function(){var ids=this.model._get(this.idsSegments);if(!ids)return[];var items=this.model._get(this.toSegments);var out=[];for(var i=0;i<ids.length;i++){var key=ids[i];out.push(items&&items[key])}return out};RefList.prototype.dereference=function(segments,i){var remaining=segments.slice(i+1);var key=this.idByIndex(remaining[0]);if(key==null)return[];remaining[0]=key;return this.toSegments.concat(remaining)};RefList.prototype.toSegmentsByItem=function(item){var key=this.idByItem(item);if(key===void 0)return;return this.toSegments.concat(key)};RefList.prototype.idByItem=function(item){if(item&&item.id)return item.id;var items=this.model._get(this.toSegments);for(var key in items){if(item===items[key])return key}};RefList.prototype.indicesByItem=function(item){var id=this.idByItem(item);var ids=this.model._get(this.idsSegments);if(!ids)return;var indices;var index=-1;while(true){index=ids.indexOf(id,index+1);if(index===-1)break;if(indices){indices.push(index)}else{indices=[index]}}return indices};RefList.prototype.itemById=function(id){return this.model._get(this.toSegments.concat(id))};RefList.prototype.idByIndex=function(index){return this.model._get(this.idsSegments.concat(index))};RefList.prototype.onMutation=function(type,segments,eventArgs){if(util.mayImpact(this.toSegments,segments)){patchToEvent(type,segments,eventArgs,this)}else if(util.mayImpact(this.idsSegments,segments)){patchIdsEvent(type,segments,eventArgs,this)}else if(util.mayImpact(this.fromSegments,segments)){patchFromEvent(type,segments,eventArgs,this)}};function FromMap(){}function RefLists(model){this.model=model;this.fromMap=new FromMap}RefLists.prototype.add=function(from,to,ids,options){var refList=new RefList(this.model,from,to,ids,options);this.fromMap[from]=refList;return refList};RefLists.prototype.remove=function(from){var refList=this.fromMap[from];delete this.fromMap[from];return refList};RefLists.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var refList=this.fromMap[from];out.push([refList.from,refList.to,refList.ids,refList.options])}return out}},{"../util":56,"./Model":44}],55:[function(require,module,exports){var util=require("../util");var Model=require("./Model");var arrayDiff=require("arraydiff");var deepEqual=util.deepEqual;Model.prototype.setDiff=function(){var subpath,value,options,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else if(arguments.length===3){subpath=arguments[0];value=arguments[1];if(typeof arguments[2]==="function"){cb=arguments[2]}else{options=arguments[2]}}else{subpath=arguments[0];value=arguments[1];options=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._setDiff(segments,value,options,cb)};Model.prototype.setDiffDeep=function(){var subpath,value,options,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else if(arguments.length===3){subpath=arguments[0];value=arguments[1];if(typeof arguments[2]==="function"){cb=arguments[2]}else{options=arguments[2]}}else{subpath=arguments[0];value=arguments[1];options=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._setDiffDeep(segments,value,options,cb)};Model.prototype._setDiffDeep=function(segments,value,options,cb){if(options){options.equal=deepEqual}else{options={equal:deepEqual}}return this._setDiff(segments,value,options,cb)};Model.prototype._setDiff=function(segments,value,options,cb){var equalFn=options&&options.equal||util.equal;var before=this._get(segments);cb=this.wrapCallback(cb);if(equalFn(before,value))return cb();var group=util.asyncGroup(cb);var finished=group();doDiff(this,segments,before,value,equalFn,group);finished()};function doDiff(model,segments,before,after,equalFn,group){if(typeof before!=="object"||!before||typeof after!=="object"||!after){model._set(segments,after,group());return}if(Array.isArray(before)&&Array.isArray(after)){var diff=arrayDiff(before,after,equalFn);if(!diff.length)return;if(diff.length===2&&diff[0].index===diff[1].index&&diff[0]instanceof arrayDiff.RemoveDiff&&diff[0].howMany===1&&diff[1]instanceof arrayDiff.InsertDiff&&diff[1].values.length===1){var index=diff[0].index;var itemSegments=segments.concat(index);doDiff(model,itemSegments,before[index],after[index],equalFn,group);return}model._applyArrayDiff(segments,diff,group());return}for(var key in before){if(key in after)continue;var itemSegments=segments.concat(key);model._del(itemSegments,group())}for(var key in after){if(equalFn(before[key],after[key]))continue;var itemSegments=segments.concat(key);doDiff(model,itemSegments,before[key],after[key],equalFn,group)}}Model.prototype.setArrayDiff=function(){var subpath,value,options,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else if(arguments.length===3){subpath=arguments[0];value=arguments[1];if(typeof arguments[2]==="function"){cb=arguments[2]}else{options=arguments[2]}}else{subpath=arguments[0];value=arguments[1];options=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._setArrayDiff(segments,value,options,cb)};Model.prototype.setArrayDiffDeep=function(){var subpath,value,options,cb;if(arguments.length===1){value=arguments[0]}else if(arguments.length===2){subpath=arguments[0];value=arguments[1]}else if(arguments.length===3){subpath=arguments[0];value=arguments[1];if(typeof arguments[2]==="function"){cb=arguments[2]}else{options=arguments[2]}}else{subpath=arguments[0];value=arguments[1];options=arguments[2];cb=arguments[3]}var segments=this._splitPath(subpath);return this._setArrayDiffDeep(segments,value,options,cb)};Model.prototype._setArrayDiffDeep=function(segments,value,options,cb){if(options){options.equal=deepEqual}else{options={equal:deepEqual}}return this._setArrayDiff(segments,value,options,cb)};Model.prototype._setArrayDiff=function(segments,value,options,cb){var before=this._get(segments);if(before===value)return this.wrapCallback(cb)();if(!Array.isArray(before)||!Array.isArray(value)){this._set(segments,value,cb);return}var equalFn=options&&options.equal;var diff=arrayDiff(before,value,equalFn);this._applyArrayDiff(segments,diff,cb)};Model.prototype._applyArrayDiff=function(segments,diff,cb){if(!diff.length)return this.wrapCallback(cb)();segments=this._dereference(segments);var model=this;function applyArrayDiff(doc,docSegments,fnCb){var group=util.asyncGroup(fnCb);for(var i=0,len=diff.length;i<len;i++){var item=diff[i];if(item instanceof arrayDiff.InsertDiff){doc.insert(docSegments,item.index,item.values,group());model.emit("insert",segments,[item.index,item.values,model._pass])}else if(item instanceof arrayDiff.RemoveDiff){var removed=doc.remove(docSegments,item.index,item.howMany,group());model.emit("remove",segments,[item.index,removed,model._pass])}else if(item instanceof arrayDiff.MoveDiff){var moved=doc.move(docSegments,item.from,item.to,item.howMany,group());model.emit("move",segments,[item.from,item.to,moved.length,model._pass])}}}return this._mutate(segments,applyArrayDiff,cb)}},{"../util":56,"./Model":44,arraydiff:57}],56:[function(require,module,exports){(function(process){var deepIs=require("deep-is");var isServer=process.title!=="browser";var isProduction=process.env.NODE_ENV==="production";exports.isServer=isServer;exports.isProduction=isProduction;exports.asyncGroup=asyncGroup;exports.castSegments=castSegments;exports.contains=contains;exports.copy=copy;exports.copyObject=copyObject;exports.deepCopy=deepCopy;exports.deepEqual=deepIs;exports.equal=equal;exports.equalsNaN=equalsNaN;exports.isArrayIndex=isArrayIndex;exports.lookup=lookup;exports.mergeInto=mergeInto;exports.mayImpact=mayImpact;exports.mayImpactAny=mayImpactAny;exports.serverRequire=serverRequire;exports.use=use;function asyncGroup(cb){var group=new AsyncGroup(cb);return function asyncGroupAdd(){return group.add()}}function AsyncGroup(cb){this.cb=cb;this.isDone=false;this.count=0}AsyncGroup.prototype.add=function(){this.count++;var self=this;return function(err){self.count--;if(self.isDone)return;if(err){self.isDone=true;self.cb(err);return}if(self.count>0)return;self.isDone=true;self.cb()}};function castSegments(segments){for(var i=segments.length;i--;){var segment=segments[i];if(typeof segment==="string"&&isArrayIndex(segment)){segments[i]=+segment}}return segments}function contains(segments,testSegments){for(var i=0;i<segments.length;i++){if(segments[i]!==testSegments[i])return false}return true}function copy(value){if(value instanceof Date)return new Date(value);if(typeof value==="object"){if(value===null)return null;if(Array.isArray(value))return value.slice();return copyObject(value)}return value}function copyObject(object){var out=new object.constructor;for(var key in object){if(object.hasOwnProperty(key)){out[key]=object[key]}}return out}function deepCopy(value){if(value instanceof Date)return new Date(value);if(typeof value==="object"){if(value===null)return null;if(Array.isArray(value)){var array=[];for(var i=value.length;i--;){array[i]=deepCopy(value[i])}return array}var object=new value.constructor;for(var key in value){if(value.hasOwnProperty(key)){object[key]=deepCopy(value[key])}}return object}return value}function equal(a,b){return a===b||equalsNaN(a)&&equalsNaN(b)}function equalsNaN(x){return x!==x}function isArrayIndex(segment){return/^[0-9]+$/.test(segment)}function lookup(segments,value){if(!segments)return value;for(var i=0,len=segments.length;i<len;i++){if(value==null)return value;
value=value[segments[i]]}return value}function mayImpactAny(segmentsList,testSegments){for(var i=0,len=segmentsList.length;i<len;i++){if(mayImpact(segmentsList[i],testSegments))return true}return false}function mayImpact(segments,testSegments){var len=Math.min(segments.length,testSegments.length);for(var i=0;i<len;i++){if(segments[i]!==testSegments[i])return false}return true}function mergeInto(to,from){for(var key in from){to[key]=from[key]}return to}function serverRequire(name){if(!isServer)return;var _require=require;return _require(name)}function use(plugin,options){if(typeof plugin==="string"){if(!isServer)return this;plugin=serverRequire(plugin)}var plugins=this._plugins||(this._plugins=[]);if(plugins.indexOf(plugin)===-1){plugins.push(plugin);plugin(this,options)}return this}}).call(this,require("/Users/enjamini/code/codeparty/derby-standalone/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))},{"/Users/enjamini/code/codeparty/derby-standalone/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":12,"deep-is":58}],57:[function(require,module,exports){module.exports=arrayDiff;arrayDiff.InsertDiff=InsertDiff;arrayDiff.RemoveDiff=RemoveDiff;arrayDiff.MoveDiff=MoveDiff;function InsertDiff(index,values){this.index=index;this.values=values}InsertDiff.prototype.type="insert";InsertDiff.prototype.toJSON=function(){return{type:this.type,index:this.index,values:this.values}};function RemoveDiff(index,howMany){this.index=index;this.howMany=howMany}RemoveDiff.prototype.type="remove";RemoveDiff.prototype.toJSON=function(){return{type:this.type,index:this.index,howMany:this.howMany}};function MoveDiff(from,to,howMany){this.from=from;this.to=to;this.howMany=howMany}MoveDiff.prototype.type="move";MoveDiff.prototype.toJSON=function(){return{type:this.type,from:this.from,to:this.to,howMany:this.howMany}};function strictEqual(a,b){return a===b}function arrayDiff(before,after,equalFn){if(!equalFn)equalFn=strictEqual;var beforeLength=before.length;var afterLength=after.length;var moves=[];var beforeMarked={};var afterMarked={};for(var beforeIndex=0;beforeIndex<beforeLength;beforeIndex++){var beforeItem=before[beforeIndex];for(var afterIndex=0;afterIndex<afterLength;afterIndex++){if(afterMarked[afterIndex])continue;if(!equalFn(beforeItem,after[afterIndex]))continue;var from=beforeIndex;var to=afterIndex;var howMany=0;do{beforeMarked[beforeIndex++]=afterMarked[afterIndex++]=true;howMany++}while(beforeIndex<beforeLength&&afterIndex<afterLength&&equalFn(before[beforeIndex],after[afterIndex])&&!afterMarked[afterIndex]);moves.push(new MoveDiff(from,to,howMany));beforeIndex--;break}}var removes=[];for(beforeIndex=0;beforeIndex<beforeLength;){if(beforeMarked[beforeIndex]){beforeIndex++;continue}var index=beforeIndex;var howMany=0;while(beforeIndex<beforeLength&&!beforeMarked[beforeIndex++]){howMany++}removes.push(new RemoveDiff(index,howMany))}var inserts=[];for(afterIndex=0;afterIndex<afterLength;){if(afterMarked[afterIndex]){afterIndex++;continue}var index=afterIndex;var howMany=0;while(afterIndex<afterLength&&!afterMarked[afterIndex++]){howMany++}var values=after.slice(index,index+howMany);inserts.push(new InsertDiff(index,values))}var insertsLength=inserts.length;var removesLength=removes.length;var movesLength=moves.length;var i,j;var count=0;for(i=0;i<removesLength;i++){var remove=removes[i];remove.index-=count;count+=remove.howMany;for(j=0;j<movesLength;j++){var move=moves[j];if(move.from>=remove.index)move.from-=remove.howMany}}for(i=insertsLength;i--;){var insert=inserts[i];var howMany=insert.values.length;for(j=movesLength;j--;){var move=moves[j];if(move.to>=insert.index)move.to-=howMany}}for(i=movesLength;i-->1;){var move=moves[i];if(move.to===move.from)continue;for(j=i;j--;){var earlier=moves[j];if(earlier.to>=move.to)earlier.to-=move.howMany;if(earlier.to>=move.from)earlier.to+=move.howMany}}var outputMoves=[];for(i=0;i<movesLength;i++){var move=moves[i];if(move.to===move.from)continue;outputMoves.push(move);for(j=i+1;j<movesLength;j++){var later=moves[j];if(later.from>=move.from)later.from-=move.howMany;if(later.from>=move.to)later.from+=move.howMany}}return removes.concat(outputMoves,inserts)}},{}],58:[function(require,module,exports){var pSlice=Array.prototype.slice;var Object_keys=typeof Object.keys==="function"?Object.keys:function(obj){var keys=[];for(var key in obj)keys.push(key);return keys};var deepEqual=module.exports=function(actual,expected){if(actual===0&&expected===0){return areZerosEqual(actual,expected)}else if(actual===expected){return true}else if(actual instanceof Date&&expected instanceof Date){return actual.getTime()===expected.getTime()}else if(isNumberNaN(actual)){return isNumberNaN(expected)}else if(typeof actual!="object"&&typeof expected!="object"){return actual==expected}else{return objEquiv(actual,expected)}};function isUndefinedOrNull(value){return value===null||value===undefined}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function isNumberNaN(value){return typeof value=="number"&&value!==value}function areZerosEqual(zeroA,zeroB){return 1/zeroA===1/zeroB}function objEquiv(a,b){if(isUndefinedOrNull(a)||isUndefinedOrNull(b))return false;if(a.prototype!==b.prototype)return false;if(isArguments(a)){if(!isArguments(b)){return false}a=pSlice.call(a);b=pSlice.call(b);return deepEqual(a,b)}try{var ka=Object_keys(a),kb=Object_keys(b),key,i}catch(e){return false}if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!deepEqual(a[key],b[key]))return false}return true}},{}],59:[function(require,module,exports){(function(Buffer){(function(){var _global=this;var _rng;if(typeof require=="function"){try{var _rb=require("crypto").randomBytes;_rng=_rb&&function(){return _rb(16)}}catch(e){}}if(!_rng&&_global.crypto&&crypto.getRandomValues){var _rnds8=new Uint8Array(16);_rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8}}if(!_rng){var _rnds=new Array(16);_rng=function(){for(var i=0,r;i<16;i++){if((i&3)===0)r=Math.random()*4294967296;_rnds[i]=r>>>((i&3)<<3)&255}return _rnds}}var BufferClass=typeof Buffer=="function"?Buffer:Array;var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+256).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i}function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){buf[i+ii++]=_hexToByte[oct]}});while(ii<16){buf[i+ii++]=0}return buf}function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+"-"+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]}var _seedBytes=_rng();var _nodeId=[_seedBytes[0]|1,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&16383;var _lastMSecs=0,_lastNSecs=0;function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!=null?options.clockseq:_clockseq;var msecs=options.msecs!=null?options.msecs:(new Date).getTime();var nsecs=options.nsecs!=null?options.nsecs:_lastNSecs+1;var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/1e4;if(dt<0&&options.clockseq==null){clockseq=clockseq+1&16383}if((dt<0||msecs>_lastMSecs)&&options.nsecs==null){nsecs=0}if(nsecs>=1e4){throw new Error("uuid.v1(): Can't create more than 10M uuids/sec")}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;msecs+=122192928e5;var tl=((msecs&268435455)*1e4+nsecs)%4294967296;b[i++]=tl>>>24&255;b[i++]=tl>>>16&255;b[i++]=tl>>>8&255;b[i++]=tl&255;var tmh=msecs/4294967296*1e4&268435455;b[i++]=tmh>>>8&255;b[i++]=tmh&255;b[i++]=tmh>>>24&15|16;b[i++]=tmh>>>16&255;b[i++]=clockseq>>>8|128;b[i++]=clockseq&255;var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n]}return buf?buf:unparse(b)}function v4(options,buf,offset){var i=buf&&offset||0;if(typeof options=="string"){buf=options=="binary"?new BufferClass(16):null;options=null}options=options||{};var rnds=options.random||(options.rng||_rng)();rnds[6]=rnds[6]&15|64;rnds[8]=rnds[8]&63|128;if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii]}}return buf||unparse(rnds)}var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;uuid.BufferClass=BufferClass;if(typeof define==="function"&&define.amd){define(function(){return uuid})}else if(typeof module!="undefined"&&module.exports){module.exports=uuid}else{var _previousRoot=_global.uuid;uuid.noConflict=function(){_global.uuid=_previousRoot;return uuid};_global.uuid=uuid}}).call(this)}).call(this,require("buffer").Buffer)},{buffer:2,crypto:6}],60:[function(require,module,exports){var qs=require("qs");var parseUrl=require("url").parse;var resolveUrl=require("url").resolve;var router=require("./router");var currentPath=window.location.pathname+window.location.search;if(window.history.replaceState){window.history.replaceState({$render:true,$method:"get"},null,window.location.href)}module.exports=History;function History(app,routes){this.app=app;this.routes=routes;if(window.history.pushState){addListeners(this);return}this.push=function(url){window.location.assign(url)};this.replace=function(url){window.location.replace(url)};this.refresh=function(){window.location.reload()}}History.prototype.push=function(url,render,state,e){this._update("pushState",url,render,state,e)};History.prototype.replace=function(url,render,state,e){this._update("replaceState",url,render,state,e)};History.prototype.refresh=function(){var path=routePath(window.location.href);router.render(this,{url:path,previous:path,method:"get"})};History.prototype.back=function(){window.history.back()};History.prototype.forward=function(){window.history.forward()};History.prototype.go=function(i){window.history.go(i)};History.prototype._update=function(historyMethod,relativeUrl,render,state,e){var url=resolveUrl(window.location.href,relativeUrl);var path=routePath(url);if(!path)return;if(render==null)render=true;if(state==null)state={};var options=renderOptions(e,path);state.$render=true;state.$method=options.method;window.history[historyMethod](state,null,options.url);currentPath=window.location.pathname+window.location.search;if(render)router.render(this,options,e)};History.prototype.page=function(){var page=this.app.createPage();var history=this;function redirect(url){if(url==="back")return history.back();if(url==="home")url="\\";history.replace(url,true)}page.redirect=redirect;return page};function routePath(url){var match=parseUrl(url);return match&&match.protocol===window.location.protocol&&match.host===window.location.host&&match.pathname+(match.search||"")}function renderOptions(e,path){if(e&&e.type==="submit"){var form=e.target;var elements=form.elements;var query=[];for(var i=0,len=elements.length,el;i<len;i++){el=elements[i];var name=el.name;if(!name)continue;var value=el.value;query.push(encodeURIComponent(name)+"="+encodeURIComponent(value));if(name==="_method"){var override=value.toLowerCase();if(override==="delete")override="del"}}query=query.join("&");if(form.method.toLowerCase()==="post"){var method=override||"post";var body=qs.parse(query)}else{method="get";path+="?"+query}}else{method="get"}return{method:method,url:path,previous:window.location.pathname+window.location.search,body:body,form:form,link:e&&e._tracksLink}}function addListeners(history){function onClick(e){var el=e.target;if(e.metaKey||e.which!==1)return;if(e.defaultPrevented)return;while(el){var url=el.href;if(url){if(el.hasAttribute&&el.hasAttribute("data-router-ignore"))return;if(el.target&&el.target!=="_self")return;var hashIndex=url.indexOf("#");if(~hashIndex&&url.slice(0,hashIndex)===window.location.href.replace(/#.*/,"")){return}e._tracksLink=el;history.push(url,true,null,e);return}el=el.parentNode}}function onSubmit(e){var target=e.target;if(e.defaultPrevented)return;if(target.tagName.toLowerCase()!=="form")return;if(target.enctype==="multipart/form-data")return;if(target.hasAttribute&&target.hasAttribute("data-router-ignore"))return;var url=target.action||window.location.href;history.push(url,true,null,e)}function onPopState(e){var previous=currentPath;var state=e.state;currentPath=window.location.pathname+window.location.search;var options={previous:previous,url:currentPath};if(state){if(!state.$render)return;options.method=state.$method;return router.render(history,options)}var url=window.location.href,hashIndex=url.indexOf("#"),el,id;if(~hashIndex&&currentPath!==previous){options.method="get";router.render(history,options);id=url.slice(hashIndex+1);if(el=document.getElementById(id)||document.getElementsByName(id)[0]){el.scrollIntoView()}}}document.addEventListener("click",onClick,false);document.addEventListener("submit",onSubmit,false);window.addEventListener("popstate",onPopState,false)}},{"./router":63,qs:64,url:18}],61:[function(require,module,exports){var Route=require("../vendor/express/router/route");var History=require("./History");var router=module.exports=require("./router");var compose=require("./compose");router.setup=setup;function setup(app){var routes={queue:{},transitional:{},onRoute:function(callback,page,params,next,isTransitional,done){return app.onRoute(callback,page,params,next,isTransitional,done)}};app.history=new History(app,routes);["get","post","put","del","enter","exit"].forEach(function(method){var queue=routes.queue[method]=[];var transitional=routes.transitional[method]=[];var transitionalCalls=[];app[method]=function(pattern,callback){if(Array.isArray(pattern)){pattern.forEach(function(item){app[method](item,callback)});return app}if(router.isTransitional(pattern)){var from=pattern.from;var to=pattern.to;var forward=pattern.forward||callback&&callback.forward||callback;var back=pattern.back||callback&&callback.back;transitionalCalls.push({from:from,to:to,forward:forward,back:back});var fromRoute=new Route(method,from,back);var toRoute=new Route(method,to,forward);fromRoute.isTransitional=true;toRoute.isTransitional=true;transitional.push({from:fromRoute,to:toRoute});if(back)transitional.push({from:toRoute,to:fromRoute});compose.transition(app[method],transitionalCalls,from,to,forward,back);return app}queue.push(new Route(method,pattern,callback));return app}})}},{"../vendor/express/router/route":65,"./History":60,"./compose":62,"./router":63}],62:[function(require,module,exports){var router=module.exports=require("./router");module.exports={transition:transition};function transition(add,calls,from,to,forward,back){if(from===to)return;for(var i=0,len=calls.length;i<len;i++){var call=calls[i];if(call.from===to){if(hasTransition(calls,from,call.to))continue;var composedForward=composeCallbacks(forward,call.forward,to);if(back&&call.back){var composedBack=composeCallbacks(call.back,back,to)}add({from:from,to:call.to,forward:composedForward,back:composedBack})}else if(call.to===from){if(hasTransition(calls,call.from,to))continue;var composedForward=composeCallbacks(call.forward,forward,from);if(back&&call.back){var composedBack=composeCallbacks(back,call.back,from)}add({from:call.from,to:to,forward:composedForward,back:composedBack})}}}function hasTransition(calls,from,to){for(var i=calls.length;i--;){var call=calls[i];if(call.from===from&&call.to===to)return true}return false}function composeCallbacks(first,second,intermediatePath){function composed(self,model,params,next,done){var intermediateUrl=router.mapRoute(intermediatePath,params);var url=params.url;var skipped=false;function wrapNext(err){skipped=true;next(err)}params.url=intermediateUrl;if(first.length===4){first.call(self,model,params,wrapNext,doneFirst)}else{first.call(self,model,params,wrapNext);doneFirst()}function doneFirst(){if(skipped)return;params.previous=intermediateUrl;params.url=url;if(second.length===4){second.call(self,model,params,next,done)}else{second.call(self,model,params,next);done&&done()}}}function asyncComposedCallback(model,params,next,done){composed(this,model,params,next,done)}function composedCallback(model,params,next){composed(this,model,params,next)}return first.length===4||second.length===4?asyncComposedCallback:composedCallback}},{"./router":63}],63:[function(require,module,exports){var qs=require("qs");var nodeUrl=require("url");module.exports={render:render,isTransitional:isTransitional,mapRoute:mapRoute};function isTransitional(pattern){return pattern.hasOwnProperty("from")&&pattern.hasOwnProperty("to")}function mapRoute(from,params){var i=params.url.indexOf("?");var queryString=~i?params.url.slice(i):"";var i=0;var path=from.replace(/\/(?:(?:\:([^?\/:*(]+)(?:\([^)]+\))?)|\*)(\?)?/g,onMatch);function onMatch(match,key,optional){var value=key?params[key]:params[i++];return optional&&value==null?"":"/"+encodeURIComponent(value)}return path+queryString}function render(history,options,e){var req=new RenderReq(history.app.page,history.routes,options,e);req.routeTransitional(0,function(){req.page=history.page();req.routeQueue(0,function(){req.routeAndTransition(0,function(){req.cancel()})})})}function RenderReq(page,routes,options,e){this.page=page;this.options=options;this.e=e;this.setUrl(options.url.replace(/#.*/,""));var queryString=nodeUrl.parse(this.url).query;this.query=queryString?qs.parse(queryString):{};this.method=options.method;this.body=options.body||{};this.previous=options.previous;this.previousPath=options.previous&&options.previous.replace(/\?.*/,"");this.transitional=routes.transitional[this.method];this.queue=routes.queue[this.method];this.onRoute=routes.onRoute}RenderReq.prototype.cancel=function(){var options=this.options;if(this.e||options.noNavigate)return;if(options.form){options.form.setAttribute("data-router-ignore","");options.form.submit()}else if(options.link){options.link.setAttribute("data-router-ignore","");options.link.click()}else{window.location.assign(options.url)}};RenderReq.prototype.setUrl=function(url){this.url=url;this.path=this.url.replace(/\?.*/,"")};RenderReq.prototype.routeTransitional=function(i,next){i||(i=0);var item;while(item=this.transitional[i++]){if(!item.to.match(this.path)||!item.from.match(this.previousPath))continue;var req=this;var otherParams=this.routeParams(item.from);var params=this.routeParams(item.to,otherParams);function done(){}this.onMatch(item.to,params,function(err){if(err)return req.cancel();req.routeTransitional(i,next)},done);return}next()};RenderReq.prototype.routeQueue=function(i,next){i||(i=0);var route;while(route=this.queue[i++]){if(!route.match(this.path))continue;var req=this;var params=this.routeParams(route);this.onMatch(route,params,function(err){if(err)return req.cancel();req.routeQueue(i,next)});return}next()};RenderReq.prototype.routeAndTransition=function(i,next){i||(i=0);var render=this.page.render;var item;while(item=this.transitional[i++]){if(!item.to.match(this.path))continue;var url=this.url;var params=this.routeParams(item.to);this.setUrl(mapRoute(item.from.path,params));var req=this;var skipped=false;function continueNext(){skipped=true;req.setUrl(url);req.page.render=render;req.routeAndTransition(i,next)}this.page.render=function(){var renderArguments=arguments;function done(){if(skipped)return;req.page.render=render;render.apply(req.page,renderArguments)}req.setUrl(url);var isAsync=req.onMatch(item.to,params,continueNext,done);if(isAsync)return;done()};this.routeQueue(0,continueNext);return}next()};RenderReq.prototype.onMatch=function(route,params,next,done){if(this.e){this.e.preventDefault();this.e=null}this.page.params=params;return this.onRoute(route.callbacks,this.page,this.page.params,next,route.isTransitional,done)};RenderReq.prototype.routeParams=function(route,otherParams){var routeParams=route.params;var params=routeParams.slice();if(otherParams){for(var key in otherParams){params[key]=otherParams[key]}}for(var key in routeParams){params[key]=routeParams[key]}params.previous=this.previous;params.url=this.url;params.body=this.body;params.query=this.query;params.method=this.method;return params}},{qs:64,url:18}],64:[function(require,module,exports){var toString=Object.prototype.toString;var hasOwnProperty=Object.prototype.hasOwnProperty;var indexOf=typeof Array.prototype.indexOf==="function"?function(arr,el){return arr.indexOf(el)}:function(arr,el){for(var i=0;i<arr.length;i++){if(arr[i]===el)return i}return-1};var isArray=Array.isArray||function(arr){return toString.call(arr)=="[object Array]"};var objectKeys=Object.keys||function(obj){var ret=[];for(var key in obj){if(obj.hasOwnProperty(key)){ret.push(key)}}return ret};var forEach=typeof Array.prototype.forEach==="function"?function(arr,fn){return arr.forEach(fn)}:function(arr,fn){for(var i=0;i<arr.length;i++)fn(arr[i])};var reduce=function(arr,fn,initial){if(typeof arr.reduce==="function")return arr.reduce(fn,initial);var res=initial;for(var i=0;i<arr.length;i++)res=fn(res,arr[i]);return res};var isint=/^[0-9]+$/;function promote(parent,key){if(parent[key].length==0)return parent[key]={};var t={};for(var i in parent[key]){if(hasOwnProperty.call(parent[key],i)){t[i]=parent[key][i]}}parent[key]=t;return t}function parse(parts,parent,key,val){var part=parts.shift();if(Object.getOwnPropertyDescriptor(Object.prototype,key))return;if(!part){if(isArray(parent[key])){parent[key].push(val)}else if("object"==typeof parent[key]){parent[key]=val}else if("undefined"==typeof parent[key]){parent[key]=val}else{parent[key]=[parent[key],val]}}else{var obj=parent[key]=parent[key]||[];if("]"==part){if(isArray(obj)){if(""!=val)obj.push(val)}else if("object"==typeof obj){obj[objectKeys(obj).length]=val}else{obj=parent[key]=[parent[key],val]}}else if(~indexOf(part,"]")){part=part.substr(0,part.length-1);if(!isint.test(part)&&isArray(obj))obj=promote(parent,key);parse(parts,obj,part,val)}else{if(!isint.test(part)&&isArray(obj))obj=promote(parent,key);parse(parts,obj,part,val)}}}function merge(parent,key,val){if(~indexOf(key,"]")){var parts=key.split("["),len=parts.length,last=len-1;parse(parts,parent,"base",val)}else{if(!isint.test(key)&&isArray(parent.base)){var t={};for(var k in parent.base)t[k]=parent.base[k];parent.base=t}set(parent.base,key,val)}return parent}function compact(obj){if("object"!=typeof obj)return obj;if(isArray(obj)){var ret=[];for(var i in obj){if(hasOwnProperty.call(obj,i)){ret.push(obj[i])}}return ret}for(var key in obj){obj[key]=compact(obj[key])}return obj}function parseObject(obj){var ret={base:{}};forEach(objectKeys(obj),function(name){merge(ret,name,obj[name])});return compact(ret.base)}function parseString(str){var ret=reduce(String(str).split("&"),function(ret,pair){var eql=indexOf(pair,"="),brace=lastBraceInKey(pair),key=pair.substr(0,brace||eql),val=pair.substr(brace||eql,pair.length),val=val.substr(indexOf(val,"=")+1,val.length);if(""==key)key=pair,val="";if(""==key)return ret;return merge(ret,decode(key),decode(val))},{base:{}}).base;return compact(ret)}exports.parse=function(str){if(null==str||""==str)return{};return"object"==typeof str?parseObject(str):parseString(str)};var stringify=exports.stringify=function(obj,prefix){if(isArray(obj)){return stringifyArray(obj,prefix)}else if("[object Object]"==toString.call(obj)){return stringifyObject(obj,prefix)}else if("string"==typeof obj){return stringifyString(obj,prefix)}else{return prefix+"="+encodeURIComponent(String(obj))}};function stringifyString(str,prefix){if(!prefix)throw new TypeError("stringify expects an object");return prefix+"="+encodeURIComponent(str)}function stringifyArray(arr,prefix){var ret=[];if(!prefix)throw new TypeError("stringify expects an object");for(var i=0;i<arr.length;i++){ret.push(stringify(arr[i],prefix+"["+i+"]"))}return ret.join("&")}function stringifyObject(obj,prefix){var ret=[],keys=objectKeys(obj),key;for(var i=0,len=keys.length;i<len;++i){key=keys[i];if(""==key)continue;if(null==obj[key]){ret.push(encodeURIComponent(key)+"=")}else{ret.push(stringify(obj[key],prefix?prefix+"["+encodeURIComponent(key)+"]":encodeURIComponent(key)))}}return ret.join("&")}function set(obj,key,val){var v=obj[key];if(Object.getOwnPropertyDescriptor(Object.prototype,key))return;if(undefined===v){obj[key]=val}else if(isArray(v)){v.push(val)}else{obj[key]=[v,val]}}function lastBraceInKey(str){var len=str.length,brace,c;for(var i=0;i<len;++i){c=str[i];if("]"==c)brace=false;if("["==c)brace=true;if("="==c&&!brace)return i}}function decode(str){try{return decodeURIComponent(str.replace(/\+/g," "))}catch(err){return str}}},{}],65:[function(require,module,exports){var utils=require("../utils");module.exports=Route;function Route(method,path,callbacks,options){options=options||{};this.path=path;this.method=method;this.callbacks=callbacks;this.regexp=utils.pathRegexp(path,this.keys=[],options.sensitive,options.strict)}Route.prototype.match=function(path){var keys=this.keys,params=this.params=[],m=this.regexp.exec(path);if(!m)return false;for(var i=1,len=m.length;i<len;++i){var key=keys[i-1];var val="string"==typeof m[i]?decodeURIComponent(m[i]):m[i];if(key){params[key.name]=val}else{params.push(val)}}return true}},{"../utils":66}],66:[function(require,module,exports){var toString={}.toString;exports.etag=function(body){return'"'+crc32.signed(body)+'"'};exports.locals=function(obj){function locals(obj){for(var key in obj)locals[key]=obj[key];return obj}return locals};exports.isAbsolute=function(path){if("/"==path[0])return true;if(":"==path[1]&&"\\"==path[2])return true};exports.flatten=function(arr,ret){var ret=ret||[],len=arr.length;for(var i=0;i<len;++i){if(Array.isArray(arr[i])){exports.flatten(arr[i],ret)}else{ret.push(arr[i])}}return ret};exports.normalizeType=function(type){return~type.indexOf("/")?acceptParams(type):{value:mime.lookup(type),params:{}}};exports.normalizeTypes=function(types){var ret=[];for(var i=0;i<types.length;++i){ret.push(exports.normalizeType(types[i]))}return ret};exports.acceptsArray=function(types,str){if(!str)return types[0];var accepted=exports.parseAccept(str),normalized=exports.normalizeTypes(types),len=accepted.length;for(var i=0;i<len;++i){for(var j=0,jlen=types.length;j<jlen;++j){if(exports.accept(normalized[j],accepted[i])){return types[j]}}}};exports.accepts=function(type,str){if("string"==typeof type)type=type.split(/ *, */);return exports.acceptsArray(type,str)};exports.accept=function(type,other){var t=type.value.split("/");return(t[0]==other.type||"*"==other.type)&&(t[1]==other.subtype||"*"==other.subtype)&&paramsEqual(type.params,other.params)};function paramsEqual(a,b){return!Object.keys(a).some(function(k){return a[k]!=b[k]})}exports.parseAccept=function(str){return exports.parseParams(str).map(function(obj){var parts=obj.value.split("/");obj.type=parts[0];obj.subtype=parts[1];return obj})};exports.parseParams=function(str){return str.split(/ *, */).map(acceptParams).filter(function(obj){return obj.quality}).sort(function(a,b){if(a.quality===b.quality){return a.originalIndex-b.originalIndex}else{return b.quality-a.quality}})};function acceptParams(str,index){var parts=str.split(/ *; */);var ret={value:parts[0],quality:1,params:{},originalIndex:index};for(var i=1;i<parts.length;++i){var pms=parts[i].split(/ *= */);if("q"==pms[0]){ret.quality=parseFloat(pms[1])}else{ret.params[pms[0]]=pms[1]}}return ret}exports.escape=function(html){return String(html).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};exports.pathRegexp=function(path,keys,sensitive,strict){if(toString.call(path)=="[object RegExp]")return path;if(Array.isArray(path))path="("+path.join("|")+")";path=path.concat(strict?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(_,slash,format,key,capture,optional,star){keys.push({name:key,optional:!!optional});slash=slash||"";return""+(optional?"":slash)+"(?:"+(optional?slash:"")+(format||"")+(capture||(format&&"([^/.]+?)"||"([^/]+?)"))+")"+(optional||"")+(star?"(/*)?":"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");return new RegExp("^"+path+"$",sensitive?"":"i")}},{}]},{},[1]);